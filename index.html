<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracker</title>
    <style>
        :root {
            --primary-color: #2196F3;
            --primary-dark: #1976D2;
            --primary-light: #E3F2FD;
            --secondary-color: #FF9800;
            --secondary-dark: #F57C00;
            --accent-color: #4CAF50;
            --accent-dark: #388E3C;
            --error-color: #F44336;
            --warning-color: #FF9800;
            --surface-color: #FFFFFF;
            --surface-dark: #F5F5F5;
            --text-primary: #212121;
            --text-secondary: #757575;
            --divider-color: #E0E0E0;
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 8px 16px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
            --border-radius-small: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-light) 0%, #f8f9fa 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 16px;
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
            background: var(--surface-color);
            min-height: 100vh;
            box-shadow: var(--shadow-medium);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .tab-content {
            display: none;
            padding: 20px 0;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--divider-color);
            border-radius: var(--border-radius-small);
            font-size: 14px;
            transition: var(--transition);
            background: var(--surface-color);
        }

        textarea {
            font-family: 'Courier New', monospace;
            resize: vertical;
            min-height: 80px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-color), #d32f2f);
        }

        .btn-block {
            width: 100%;
            margin-bottom: 12px;
        }

        .student-list {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--divider-color);
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--divider-color);
            transition: var(--transition);
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-item:hover {
            background: var(--surface-dark);
            margin: 0 -15px;
            padding-left: 15px;
            padding-right: 15px;
            border-radius: var(--border-radius-small);
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .student-roll {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .attendance-btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            margin-left: 6px;
            font-size: 12px;
        }

        .btn-present {
            background: var(--accent-color);
            color: white;
        }

        .btn-absent {
            background: var(--error-color);
            color: white;
        }

        .btn-present:hover {
            background: var(--accent-dark);
        }

        .btn-absent:hover {
            background: #d32f2f;
        }

        .lecture-btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            margin: 3px;
            background: #e0e0e0;
            color: #333;
            flex: 1;
            font-size: 12px;
        }

        .lecture-btn.selected {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .lecture-btn:hover {
            background: var(--primary-light);
        }

        .lecture-selection {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .summary-card {
            background: var(--surface-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--primary-color);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .summary-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .summary-percentage {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: var(--surface-dark);
            border-radius: var(--border-radius-small);
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: linear-gradient(135deg, var(--surface-color), var(--surface-dark));
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: var(--shadow-heavy);
            border-top: 1px solid var(--divider-color);
            backdrop-filter: blur(10px);
        }

        .tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
            border-radius: var(--border-radius-small);
            min-width: 70px;
        }

        .tab:hover {
            background: var(--primary-light);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .tab-icon {
            font-size: 1.5em;
            margin-bottom: 4px;
        }

        .tab-label {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message {
            padding: 12px;
            border-radius: var(--border-radius-small);
            margin-bottom: 16px;
            font-weight: 500;
            text-align: center;
        }

        .message.success {
            background: #e8f5e8;
            color: var(--accent-dark);
            border: 1px solid var(--accent-color);
        }

        .message.error {
            background: #ffeaea;
            color: #c62828;
            border: 1px solid var(--error-color);
        }

        .hidden {
            display: none !important;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--divider-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--primary-color));
            transition: width 0.3s ease;
        }

        .export-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .danger-zone {
            background: #ffeaea;
            border: 1px solid var(--error-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 30px;
        }

        .danger-zone h3 {
            color: var(--error-color);
            margin-bottom: 15px;
        }

        .danger-zone .btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .bulk-import-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px dashed var(--primary-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
            transition: var(--transition);
        }

        .bulk-import-section:hover {
            background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
            border-color: var(--primary-dark);
        }

        .enhanced-summary-card {
            background: linear-gradient(145deg, var(--surface-color), #f8f9fa);
            border: 1px solid var(--divider-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .enhanced-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        .lecture-sequence-info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 0.85em;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
                padding-bottom: 90px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .summary-stats {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .export-options {
                grid-template-columns: 1fr;
            }

            .tab-bar {
                padding: 8px 0;
            }

            .tab-icon {
                font-size: 1.2em;
            }

            .tab-label {
                font-size: 0.7em;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>📚 Attendance Tracker</h1>
            <p>Manage student attendance efficiently</p>
        </div>

        <!-- Take Attendance Tab -->
        <div class="tab-content active" id="attendance">
            <div class="form-group">
                <label for="subject-select">Select Subject:</label>
                <select id="subject-select">
                    <option value="">Choose a subject...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="class-date">Class Date:</label>
                <input type="date" id="class-date">
            </div>

            <div class="form-group">
                <label>Select Lecture:</label>
                <div class="lecture-selection">
                    <button class="lecture-btn" onclick="selectLecture(1)">1st Lecture</button>
                    <button class="lecture-btn" onclick="selectLecture(2)">2nd Lecture</button>
                    <button class="lecture-btn" onclick="selectLecture(3)">3rd Lecture</button>
                </div>
                <div id="lecture-info"
                    style="font-size: 14px; color: var(--text-secondary); text-align: center; margin-top: 8px;">
                    Select lecture number first
                </div>
            </div>

            <div id="student-attendance" class="student-list hidden">
                <!-- Students will be loaded here -->
            </div>

            <button class="btn btn-success btn-block" onclick="saveAttendance()">
                💾 Save Attendance
            </button>

            <div id="attendance-message" class="message hidden"></div>
        </div>

        <!-- Track Attendance Tab -->
        <div class="tab-content" id="track">
            <div class="form-group">
                <label for="track-subject">Select Subject:</label>
                <select id="track-subject">
                    <option value="">Choose a subject...</option>
                </select>
            </div>

            <div id="attendance-summary" class="attendance-summary">
                <!-- Attendance summary will be loaded here -->
            </div>
        </div>

        <!-- Summary Tab -->
        <div class="tab-content" id="summary">
            <div class="form-group">
                <label for="summary-subject">Select Subject:</label>
                <select id="summary-subject">
                    <option value="">All Subjects</option>
                </select>
            </div>

            <div class="export-options" style="grid-template-columns: 1fr; gap: 8px;">
                <button class="btn btn-success btn-block" onclick="generateStudentSummary()">
                    📊 Student Summary
                </button>
                <button class="btn btn-secondary btn-block" onclick="exportStudentPerformancePDF()">
                    📄 Student Performance Report
                </button>
                <button class="btn btn-secondary btn-block" onclick="exportClassAttendancePDF()">
                    📄 Class Attendance Report
                </button>
                <button class="btn btn-secondary btn-block" onclick="exportDetailedAnalysisPDF()">
                    📄 Detailed Analysis Report
                </button>
            </div>

            <div id="summary-content">
                <!-- Summary content will be loaded here -->
            </div>
        </div>

        <!-- Manage Tab -->
        <div class="tab-content" id="manage">
            <h3 style="margin-bottom: 20px; color: var(--text-primary);">👥 Manage Students</h3>

            <div class="form-group">
                <label for="student-name">Student Name:</label>
                <input type="text" id="student-name" placeholder="Enter student name">
            </div>

            <div class="form-group">
                <label for="student-roll">Roll Number:</label>
                <input type="text" id="student-roll" placeholder="Enter roll number">
            </div>

            <button class="btn btn-success btn-block" onclick="addStudent()">
                ➕ Add Student
            </button>

            <h4 style="margin: 20px 0 15px 0; color: var(--text-primary);">📄 Bulk Import Students</h4>
            <div class="form-group">
                <label for="bulk-import-text">Paste Excel data (Roll Number, Name):</label>
                <textarea id="bulk-import-text" rows="6"
                    placeholder="Example:&#10;2021-CS-001, John Doe&#10;2021-CS-002, Jane Smith&#10;2021-CS-003, Mike Johnson&#10;&#10;Or tab-separated from Excel copy-paste"></textarea>
            </div>
            <button class="btn btn-secondary btn-block" onclick="bulkImportStudents()">
                📋 Import Students from Text
            </button>

            <h3 style="margin: 30px 0 20px 0; color: var(--text-primary);">📚 Manage Subjects</h3>

            <div class="form-group">
                <label for="subject-name">Subject Name:</label>
                <input type="text" id="subject-name" placeholder="Enter subject name">
            </div>

            <button class="btn btn-success btn-block" onclick="addSubject()">
                ➕ Add Subject
            </button>

            <div id="current-students" class="student-list">
                <!-- Current students will be loaded here -->
            </div>

            <div id="current-subjects" class="student-list">
                <!-- Current subjects will be loaded here -->
            </div>

            <h3 style="margin: 30px 0 20px 0; color: var(--text-primary);">💾 Backup & Import</h3>

            <div class="export-options">
                <button class="btn btn-secondary" onclick="exportData()">
                    💾 Backup Data
                </button>
                <button class="btn" onclick="importData()">
                    📁 Import Data
                </button>
            </div>
            <input type="file" id="import-file" accept=".json" style="display: none;"
                onchange="handleFileImport(event)">

            <div class="danger-zone">
                <h3>⚠️ Danger Zone</h3>
                <button class="btn btn-danger" onclick="clearAllAttendance()">Clear All Attendance</button>
                <button class="btn btn-danger" onclick="clearAllStudents()">Clear All Students</button>
                <button class="btn btn-danger" onclick="clearAllSubjects()">Clear All Subjects</button>
                <div style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary);">
                    ⚠️ Warning: These actions cannot be undone. Export data first if needed.
                </div>
            </div>

            <div id="manage-message" class="message hidden"></div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab active" onclick="switchTab('attendance')">
            <span class="tab-icon">📝</span>
            <span class="tab-label">Take</span>
        </div>
        <div class="tab" onclick="switchTab('track')">
            <span class="tab-icon">📊</span>
            <span class="tab-label">Track</span>
        </div>
        <div class="tab" onclick="switchTab('summary')">
            <span class="tab-icon">📋</span>
            <span class="tab-label">Summary</span>
        </div>
        <div class="tab" onclick="switchTab('manage')">
            <span class="tab-icon">⚙️</span>
            <span class="tab-label">Manage</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Global variables
        let selectedLecture = null;
        let currentAttendance = {};

        // Data storage utilities - ALL FUNCTIONS ARE AT GLOBAL SCOPE
        function getStudents() {
            return JSON.parse(localStorage.getItem('students') || '[]');
        }

        function setStudents(students) {
            localStorage.setItem('students', JSON.stringify(students));
        }

        function getSubjects() {
            return JSON.parse(localStorage.getItem('subjects') || '[]');
        }

        function setSubjects(subjects) {
            localStorage.setItem('subjects', JSON.stringify(subjects));
        }

        function getAttendance() {
            return JSON.parse(localStorage.getItem('attendance') || '{}');
        }

        function setAttendance(attendance) {
            localStorage.setItem('attendance', JSON.stringify(attendance));
        }

        // Show message helper
        function showMessage(element, message, type = 'error') {
            element.textContent = message;
            element.className = `message ${type}`;
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 5000);
        }

        // Tab functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to selected tab
            document.querySelector(`.tab:nth-child(${getTabIndex(tabName)})`).classList.add('active');

            // Load content for the selected tab
            if (tabName === 'attendance') {
                loadSubjects('subject-select');
                setTodayDate();
                selectedLecture = null;
                document.querySelectorAll('.lecture-btn').forEach(btn => btn.classList.remove('selected'));
                document.getElementById('lecture-info').textContent = 'Select lecture number first';
            } else if (tabName === 'track') {
                loadSubjects('track-subject');
            } else if (tabName === 'summary') {
                loadSubjects('summary-subject');
            } else if (tabName === 'manage') {
                loadCurrentStudents();
                loadCurrentSubjects();
            }
        }

        function getTabIndex(tabName) {
            const tabs = ['attendance', 'track', 'summary', 'manage'];
            return tabs.indexOf(tabName) + 1;
        }

        // Set today's date as default
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('class-date').value = today;
        }

        // Load subjects into select dropdown
        function loadSubjects(selectId) {
            const select = document.getElementById(selectId);
            const subjects = getSubjects();

            select.innerHTML = '<option value="">Choose a subject...</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                select.appendChild(option);
            });
        }

        // Lecture selection
        function selectLecture(lectureNumber) {
            selectedLecture = lectureNumber;

            // Update UI
            document.querySelectorAll('.lecture-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');

            // Update lecture info with enhanced tracking
            const subjectId = document.getElementById('subject-select').value;
            const date = document.getElementById('class-date').value;

            if (subjectId && date) {
                updateLectureInfo(subjectId, date, lectureNumber);
            } else {
                document.getElementById('lecture-info').textContent = `${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture selected`;
            }

            loadStudentsForAttendance();

            // Show lecture sequence info
            if (subjectId) {
                showLectureSequence(subjectId, date);
            }
        }

        // Show lecture sequence and patterns
        function showLectureSequence(subjectId, date) {
            const attendance = getAttendance();
            const subjectAttendance = Object.values(attendance).filter(record => record.subjectId == subjectId);

            if (subjectAttendance.length > 0) {
                // Group by date to show lecture patterns
                const dateGroups = {};
                subjectAttendance.forEach(record => {
                    if (!dateGroups[record.date]) {
                        dateGroups[record.date] = [];
                    }
                    dateGroups[record.date].push(record.lectureNumber);
                });

                const lectureInfoDiv = document.getElementById('lecture-info');
                const currentInfo = lectureInfoDiv.textContent;

                // Show recent lecture pattern
                const recentDates = Object.keys(dateGroups).sort().slice(-3);
                if (recentDates.length > 0) {
                    const patternInfo = recentDates.map(d => {
                        const lectures = dateGroups[d].sort().join(', ');
                        return `${new Date(d).toLocaleDateString()}: L${lectures}`;
                    }).join(' | ');

                    lectureInfoDiv.innerHTML = `${currentInfo}<br><small style="color: var(--text-secondary);">Recent: ${patternInfo}</small>`;
                }
            }
        }

        function getOrdinalSuffix(num) {
            const suffixes = ['th', 'st', 'nd', 'rd'];
            const v = num % 100;
            return suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0];
        }

        function updateLectureInfo(subjectId, date, lectureNumber) {
            const subjects = getSubjects();
            const subject = subjects.find(s => s.id == subjectId);
            const subjectName = subject ? subject.name : 'Unknown Subject';

            const attendance = getAttendance();
            const key = `${date}_${subjectId}_${lectureNumber}`;

            if (attendance[key]) {
                const totalStudents = Object.keys(attendance[key].records).length;
                const presentStudents = Object.values(attendance[key].records).filter(status => status === 'present').length;
                document.getElementById('lecture-info').textContent =
                    `${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture - ${subjectName} (${presentStudents}/${totalStudents} present)`;
            } else {
                document.getElementById('lecture-info').textContent =
                    `${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture - ${subjectName} (Not taken yet)`;
            }
        }

        // Load students for attendance taking
        function loadStudentsForAttendance() {
            const subjectSelect = document.getElementById('subject-select');
            const selectedSubjectId = subjectSelect.value;
            const studentAttendanceDiv = document.getElementById('student-attendance');

            if (!selectedSubjectId || !selectedLecture) {
                studentAttendanceDiv.classList.add('hidden');
                return;
            }

            const students = getStudents();
            studentAttendanceDiv.classList.remove('hidden');

            let html = '<h3 style="margin-bottom: 15px; color: var(--text-primary);">Mark Attendance</h3>';
            students.forEach(student => {
                html += `
                    <div class="student-item">
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-roll">Roll: ${student.roll}</div>
                        </div>
                        <div>
                            <button class="attendance-btn btn-present" onclick="markAttendance('${student.roll}', 'present', this)">
                                ✓ Present
                            </button>
                            <button class="attendance-btn btn-absent" onclick="markAttendance('${student.roll}', 'absent', this)">
                                ✗ Absent
                            </button>
                        </div>
                    </div>
                `;
            });

            studentAttendanceDiv.innerHTML = html;
        }

        // Mark individual student attendance
        function markAttendance(rollNumber, status, clickedButton) {
            currentAttendance[rollNumber] = status;

            const studentItem = clickedButton.closest('.student-item');
            const buttons = studentItem.querySelectorAll('.attendance-btn');

            buttons.forEach(btn => {
                btn.style.opacity = '0.5';
                btn.style.transform = 'scale(0.95)';
                btn.style.boxShadow = 'none';
            });

            clickedButton.style.opacity = '1';
            clickedButton.style.transform = 'scale(1)';
            clickedButton.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        }

        // Save attendance
        function saveAttendance() {
            const subjectSelect = document.getElementById('subject-select');
            const selectedSubjectId = subjectSelect.value;
            const date = document.getElementById('class-date').value;
            const messageDiv = document.getElementById('attendance-message');

            if (!selectedSubjectId || !date) {
                showMessage(messageDiv, 'Please select subject and date', 'error');
                return;
            }

            if (!selectedLecture) {
                showMessage(messageDiv, 'Please select lecture number', 'error');
                return;
            }

            if (Object.keys(currentAttendance).length === 0) {
                showMessage(messageDiv, 'Please mark attendance for at least one student', 'error');
                return;
            }

            const subjects = getSubjects();
            const selectedSubject = subjects.find(s => s.id == selectedSubjectId);
            const subjectName = selectedSubject ? selectedSubject.name : 'Unknown Subject';

            const attendance = getAttendance();
            const key = `${date}_${selectedSubjectId}_${selectedLecture}`;

            if (attendance[key]) {
                if (!confirm(`Attendance already exists for ${selectedLecture}${getOrdinalSuffix(selectedLecture)} lecture of this subject on this date. Do you want to overwrite it?`)) {
                    return;
                }
            }

            attendance[key] = {
                subjectId: selectedSubjectId,
                subject: subjectName,
                date: date,
                lectureNumber: selectedLecture,
                records: currentAttendance,
                timestamp: new Date().toISOString()
            };

            setAttendance(attendance);
            showMessage(messageDiv, `Attendance saved for ${subjectName} - ${selectedLecture}${getOrdinalSuffix(selectedLecture)} lecture on ${date}`, 'success');

            currentAttendance = {};
            loadStudentsForAttendance();
            updateLectureInfo(selectedSubjectId, date, selectedLecture);
        }

        // Show attendance summary for tracking
        function showAttendanceSummary() {
            const subjectSelect = document.getElementById('track-subject');
            const selectedSubjectId = subjectSelect.value;
            const summaryDiv = document.getElementById('attendance-summary');

            if (!selectedSubjectId) {
                summaryDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Please select a subject to view attendance summary.</p>';
                return;
            }

            const attendance = getAttendance();
            const subjectAttendance = Object.values(attendance).filter(record => record.subjectId == selectedSubjectId);

            if (subjectAttendance.length === 0) {
                summaryDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No attendance records found for this subject.</p>';
                return;
            }

            subjectAttendance.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare === 0) {
                    return b.lectureNumber - a.lectureNumber;
                }
                return dateCompare;
            });

            let html = '';
            subjectAttendance.forEach(record => {
                const totalStudents = Object.keys(record.records || record.attendance || {}).length;
                const attendanceRecords = record.records || record.attendance || {};
                const presentStudents = Object.values(attendanceRecords).filter(status => status === 'present').length;
                const absentStudents = totalStudents - presentStudents;
                const percentage = totalStudents > 0 ? ((presentStudents / totalStudents) * 100).toFixed(1) : 0;

                const absentList = [];
                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (status === 'absent') {
                        absentList.push(rollNumber);
                    }
                });

                const lectureInfo = record.lectureNumber ? ` - ${record.lectureNumber}${getOrdinalSuffix(record.lectureNumber)} Lecture` : '';

                html += `
                    <div class="summary-card">
                        <div class="summary-header">
                            <div class="summary-title">${record.subject}${lectureInfo}</div>
                            <div class="summary-percentage">${percentage}%</div>
                        </div>
                        <div class="summary-stats">
                            <div class="stat-item">
                                <div class="stat-value">${presentStudents}</div>
                                <div class="stat-label">Present</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${absentStudents}</div>
                                <div class="stat-label">Absent</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${new Date(record.date).toLocaleDateString()}</div>
                                <div class="stat-label">Date</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        ${absentList.length > 0 ? `
                            <div style="margin-top: 15px; padding: 12px; background: #fff3e0; border-radius: 8px; border-left: 4px solid var(--secondary-color);">
                                <h4 style="color: var(--secondary-dark); margin-bottom: 10px;">🚫 Absent Students (${absentList.length})</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px;">
                                    ${absentList.map(roll => {
                    const student = getStudents().find(s => s.roll === roll);
                    const studentName = student ? student.name.split(' ')[0] : roll;
                    return `<div style="background: var(--secondary-color); color: white; padding: 6px 8px; border-radius: 12px; font-size: 0.8em; text-align: center;">
                                            <div style="font-weight: bold;">${roll}</div>
                                            <div style="font-size: 0.7em; opacity: 0.9;">${studentName}</div>
                                        </div>`;
                }).join('')}
                                </div>
                                <div style="margin-top: 10px; font-size: 0.8em; color: var(--text-secondary);">
                                    📧 Click roll numbers to view student's complete absence history
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            summaryDiv.innerHTML = html;
        }

        // Generate student summary
        function generateStudentSummary() {
            const subjectSelect = document.getElementById('summary-subject');
            const selectedSubjectId = subjectSelect.value;
            const summaryDiv = document.getElementById('summary-content');

            const students = getStudents();
            const attendance = getAttendance();

            let filteredAttendance = Object.values(attendance);
            if (selectedSubjectId) {
                filteredAttendance = filteredAttendance.filter(record => record.subjectId == selectedSubjectId);
            }

            if (filteredAttendance.length === 0) {
                summaryDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No attendance records found.</p>';
                return;
            }

            const studentStats = {};
            students.forEach(student => {
                studentStats[student.roll] = {
                    name: student.name,
                    roll: student.roll,
                    present: 0,
                    absent: 0,
                    total: 0,
                    absentDates: []
                };
            });

            // Collect attendance data and absent dates
            filteredAttendance.forEach(record => {
                const attendanceRecords = record.records || record.attendance || {};
                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (studentStats[rollNumber]) {
                        studentStats[rollNumber].total++;
                        if (status === 'present') {
                            studentStats[rollNumber].present++;
                        } else {
                            studentStats[rollNumber].absent++;
                            // Add absent date with lecture info
                            const lectureInfo = record.lectureNumber ? ` (${record.lectureNumber}${getOrdinalSuffix(record.lectureNumber)} Lec)` : '';
                            studentStats[rollNumber].absentDates.push(`${new Date(record.date).toLocaleDateString()}${lectureInfo}`);
                        }
                    }
                });
            });

            const sortedStats = Object.values(studentStats)
                .filter(stat => stat.total > 0)
                .sort((a, b) => {
                    const percentageA = (a.present / a.total) * 100;
                    const percentageB = (b.present / b.total) * 100;
                    return percentageA - percentageB;
                });

            let html = '<h3 style="margin-bottom: 20px; color: var(--text-primary);">📊 Student Summary</h3>';

            if (sortedStats.length === 0) {
                html += '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No students have attendance records.</p>';
            } else {
                sortedStats.forEach(stat => {
                    const percentage = ((stat.present / stat.total) * 100).toFixed(1);
                    const isLowAttendance = percentage < 75;

                    html += `
                        <div class="summary-card" style="${isLowAttendance ? 'border-left-color: var(--error-color); background: #ffeaea;' : ''}">
                            <div class="summary-header">
                                <div class="summary-title">
                                    ${stat.name} ${isLowAttendance ? '⚠️' : ''}
                                    <div style="font-size: 0.8em; color: var(--text-secondary);">Roll: ${stat.roll}</div>
                                </div>
                                <div class="summary-percentage" style="${isLowAttendance ? 'color: var(--error-color);' : ''}">${percentage}%</div>
                            </div>
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <div class="stat-value" style="color: var(--accent-color);">${stat.present}</div>
                                    <div class="stat-label">Present</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" style="color: var(--error-color);">${stat.absent}</div>
                                    <div class="stat-label">Absent</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${stat.total}</div>
                                    <div class="stat-label">Total</div>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%; ${isLowAttendance ? 'background: linear-gradient(90deg, var(--error-color), var(--warning-color));' : ''}"></div>
                            </div>
                            ${stat.absentDates.length > 0 ? `
                                <div style="margin-top: 15px; padding: 12px; background: #fff3e0; border-radius: 8px; border-left: 3px solid var(--secondary-color);">
                                    <h4 style="color: var(--secondary-dark); margin-bottom: 10px; font-size: 0.9em;">📅 Absent Dates (${stat.absentDates.length})</h4>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px; max-height: 80px; overflow-y: auto;">
                                        ${stat.absentDates.map(date => `<span style="background: var(--secondary-color); color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.75em; white-space: nowrap;">${date}</span>`).join('')}
                                    </div>
                                    ${stat.absentDates.length > 6 ? '<div style="margin-top: 8px; font-size: 0.75em; color: var(--text-secondary);">Scroll to view all dates</div>' : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }

            summaryDiv.innerHTML = html;
        }

        // Export to PDF - Student Performance Report
        function exportStudentPerformancePDF() {
            const subjectSelect = document.getElementById('summary-subject');
            const selectedSubjectId = subjectSelect.value;

            if (!selectedSubjectId) {
                alert('Please select a subject first');
                return;
            }

            const subjects = getSubjects();
            const selectedSubject = subjects.find(s => s.id == selectedSubjectId);
            const subjectName = selectedSubject ? selectedSubject.name : 'Unknown Subject';

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Professional header with background color
            doc.setFillColor(33, 150, 243); // Primary blue
            doc.rect(0, 0, 210, 50, 'F');

            // White text on blue background
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('STUDENT PERFORMANCE REPORT', 105, 25, { align: 'center' });

            doc.setFontSize(16);
            doc.setFont(undefined, 'normal');
            doc.text(`📚 ${subjectName}`, 105, 38, { align: 'center' });

            // Reset text color
            doc.setTextColor(0, 0, 0);

            // Institution info box
            doc.setFillColor(245, 245, 245);
            doc.rect(15, 55, 180, 25, 'F');
            doc.setDrawColor(200, 200, 200);
            doc.rect(15, 55, 180, 25, 'S');

            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('📊 REPORT DETAILS', 20, 65);
            doc.setFont(undefined, 'normal');
            doc.text(`Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, 20, 72);
            doc.text('System: Attendance Tracker Pro', 120, 65);
            doc.text(`Academic Session: ${new Date().getFullYear()}`, 120, 72);

            const students = getStudents();
            const attendance = getAttendance();
            const subjectAttendance = Object.values(attendance).filter(record => record.subjectId == selectedSubjectId);

            if (subjectAttendance.length === 0) {
                doc.setFontSize(14);
                doc.text('❌ No attendance records found for this subject.', 20, 105);
                doc.save(`${subjectName}_Student_Performance_Report.pdf`);
                return;
            }

            // Calculate comprehensive statistics
            const studentStats = {};
            students.forEach(student => {
                studentStats[student.roll] = {
                    name: student.name,
                    roll: student.roll,
                    present: 0,
                    absent: 0,
                    total: 0,
                    absentDates: []
                };
            });

            subjectAttendance.forEach(record => {
                const attendanceRecords = record.records || record.attendance || {};
                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (studentStats[rollNumber]) {
                        studentStats[rollNumber].total++;
                        if (status === 'present') {
                            studentStats[rollNumber].present++;
                        } else {
                            studentStats[rollNumber].absent++;
                            const lectureInfo = record.lectureNumber ? ` (L${record.lectureNumber})` : '';
                            studentStats[rollNumber].absentDates.push(`${new Date(record.date).toLocaleDateString()}${lectureInfo}`);
                        }
                    }
                });
            });

            const sortedStats = Object.values(studentStats)
                .filter(stat => stat.total > 0)
                .sort((a, b) => {
                    const percentageA = (a.present / a.total) * 100;
                    const percentageB = (b.present / b.total) * 100;
                    return percentageB - percentageA;
                });

            // Executive Summary Box
            let yPos = 90;
            doc.setFillColor(240, 248, 255);
            doc.rect(15, yPos, 180, 45, 'F');
            doc.setDrawColor(33, 150, 243);
            doc.setLineWidth(1);
            doc.rect(15, yPos, 180, 45, 'S');

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(33, 150, 243);
            doc.text('📈 EXECUTIVE SUMMARY', 20, yPos + 10);

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');

            const avgAttendance = sortedStats.length > 0 ?
                (sortedStats.reduce((sum, stat) => sum + (stat.present / stat.total * 100), 0) / sortedStats.length).toFixed(1) : 0;
            const lowAttendanceStudents = sortedStats.filter(stat => (stat.present / stat.total * 100) < 75);

            doc.text(`👥 Total Students: ${sortedStats.length}`, 20, yPos + 20);
            doc.text(`📅 Total Classes: ${subjectAttendance.length}`, 20, yPos + 28);
            doc.text(`📊 Average Attendance: ${avgAttendance}%`, 20, yPos + 36);

            doc.text(`⚠️ Below 75%: ${lowAttendanceStudents.length} students`, 110, yPos + 20);
            doc.text(`🏆 Above 90%: ${sortedStats.filter(stat => (stat.present / stat.total * 100) >= 90).length} students`, 110, yPos + 28);
            doc.text(`🎯 Class Average: ${avgAttendance >= 85 ? 'Excellent' : avgAttendance >= 75 ? 'Good' : 'Needs Improvement'}`, 110, yPos + 36);

            // Performance Table
            yPos = 145;
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(33, 150, 243);
            doc.text('🏆 STUDENT PERFORMANCE RANKING', 20, yPos);

            yPos += 10;
            // Table header with background
            doc.setFillColor(33, 150, 243);
            doc.rect(15, yPos, 180, 12, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('#', 18, yPos + 8);
            doc.text('Roll No.', 30, yPos + 8);
            doc.text('Student Name', 60, yPos + 8);
            doc.text('Present', 115, yPos + 8);
            doc.text('Absent', 135, yPos + 8);
            doc.text('Total', 155, yPos + 8);
            doc.text('Percentage', 170, yPos + 8);

            yPos += 12;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);

            sortedStats.forEach((stat, index) => {
                if (yPos > 270) {
                    doc.addPage();
                    // Repeat header on new page
                    doc.setFillColor(33, 150, 243);
                    doc.rect(15, 20, 180, 12, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text('#', 18, 28);
                    doc.text('Roll No.', 30, 28);
                    doc.text('Student Name', 60, 28);
                    doc.text('Present', 115, 28);
                    doc.text('Absent', 135, 28);
                    doc.text('Total', 155, 28);
                    doc.text('Percentage', 170, 28);
                    yPos = 32;
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);
                }

                const percentage = ((stat.present / stat.total) * 100).toFixed(1);
                const rank = index + 1;

                // Alternating row colors
                if (index % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(15, yPos - 2, 180, 8, 'F');
                }

                // Simple numeric ranking
                doc.text(rank.toString(), 18, yPos + 4);
                doc.text(stat.roll, 30, yPos + 4);
                doc.text(stat.name.substring(0, 22), 60, yPos + 4);
                doc.text(stat.present.toString(), 120, yPos + 4);
                doc.text(stat.absent.toString(), 140, yPos + 4);
                doc.text(stat.total.toString(), 160, yPos + 4);

                // Simple percentage display
                doc.setFont(undefined, 'bold');
                doc.text(`${percentage}%`, 172, yPos + 4);
                doc.setFont(undefined, 'normal');

                yPos += 8;
            });

            // Detailed absentee analysis on new page
            doc.addPage();
            yPos = 20;

            // Header for absentee analysis
            doc.setFillColor(255, 193, 7);
            doc.rect(0, 0, 210, 35, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('📅 DETAILED ABSENTEE ANALYSIS', 105, 22, { align: 'center' });

            yPos = 45;
            const studentsWithAbsences = sortedStats.filter(stat => stat.absent > 0);

            if (studentsWithAbsences.length > 0) {
                studentsWithAbsences.forEach(stat => {
                    if (yPos > 260) {
                        doc.addPage();
                        yPos = 20;
                    }

                    const percentage = ((stat.present / stat.total) * 100).toFixed(1);

                    // Student info box
                    if (percentage < 75) {
                        doc.setFillColor(255, 235, 238);
                    } else {
                        doc.setFillColor(248, 249, 250);
                    }
                    doc.rect(15, yPos, 180, 30, 'F');

                    if (percentage < 75) {
                        doc.setDrawColor(244, 67, 54);
                    } else {
                        doc.setDrawColor(224, 224, 224);
                    }
                    doc.rect(15, yPos, 180, 30, 'S');

                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    if (percentage < 75) {
                        doc.setTextColor(211, 47, 47);
                    } else {
                        doc.setTextColor(0, 0, 0);
                    }
                    doc.text(`${stat.name} (${stat.roll}) - ${percentage}%`, 20, yPos + 10);

                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Absent: ${stat.absent}/${stat.total} classes`, 20, yPos + 18);

                    if (stat.absentDates.length > 0) {
                        doc.text('Absent Dates:', 20, yPos + 25);
                        const datesText = stat.absentDates.slice(0, 6).join(', ');
                        doc.text(datesText, 50, yPos + 25);
                        if (stat.absentDates.length > 6) {
                            doc.text(`... and ${stat.absentDates.length - 6} more`, 20, yPos + 32);
                            yPos += 8;
                        }
                    }

                    yPos += 40;
                });
            } else {
                doc.setFontSize(14);
                doc.text('🎉 Excellent! No students have recorded absences.', 20, yPos);
            }

            // Professional footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);

                // Footer background
                doc.setFillColor(248, 249, 250);
                doc.rect(0, 280, 210, 20, 'F');

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(8);
                doc.text(`📄 Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.text('Generated by Attendance Tracker Pro • Confidential Document', 105, 285, { align: 'center' });
                doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 20, 290);
                doc.text(`Subject: ${subjectName}`, 160, 290);
            }

            doc.save(`${subjectName}_Student_Performance_Report.pdf`);
        }

        // Export to PDF - Class Attendance Report
        function exportClassAttendancePDF() {
            const subjectSelect = document.getElementById('summary-subject');
            const selectedSubjectId = subjectSelect.value;

            if (!selectedSubjectId) {
                alert('Please select a subject first');
                return;
            }

            const subjects = getSubjects();
            const selectedSubject = subjects.find(s => s.id == selectedSubjectId);
            const subjectName = selectedSubject ? selectedSubject.name : 'Unknown Subject';

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('CLASS ATTENDANCE REPORT', 105, 25, { align: 'center' });

            doc.setFontSize(18);
            doc.setFont(undefined, 'normal');
            doc.text(`Subject: ${subjectName}`, 105, 40, { align: 'center' });

            // Institution details
            doc.setFontSize(12);
            doc.text('Generated by: Attendance Tracker System', 20, 55);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 65);
            doc.text(`Time: ${new Date().toLocaleTimeString()}`, 20, 75);

            // Line separator
            doc.setLineWidth(0.5);
            doc.line(20, 85, 190, 85);

            const attendance = getAttendance();
            const subjectAttendance = Object.values(attendance).filter(record => record.subjectId == selectedSubjectId);

            if (subjectAttendance.length === 0) {
                doc.setFontSize(14);
                doc.text('No attendance records found for this subject.', 20, 105);
                doc.save(`${subjectName}_Class_Attendance_Report.pdf`);
                return;
            }

            // Sort by date and lecture
            subjectAttendance.sort((a, b) => {
                const dateCompare = new Date(a.date) - new Date(b.date);
                if (dateCompare === 0) {
                    return a.lectureNumber - b.lectureNumber;
                }
                return dateCompare;
            });

            // Summary
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('ATTENDANCE SUMMARY BY CLASS', 20, 100);

            let yPos = 120;
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Date', 20, yPos);
            doc.text('Lecture', 50, yPos);
            doc.text('Total Students', 80, yPos);
            doc.text('Present', 120, yPos);
            doc.text('Absent', 145, yPos);
            doc.text('Attendance %', 170, yPos);

            doc.setLineWidth(0.3);
            doc.line(20, yPos + 3, 200, yPos + 3);

            yPos += 10;
            doc.setFont(undefined, 'normal');

            let totalClasses = 0;
            let totalPresent = 0;
            let totalStudentDays = 0;

            subjectAttendance.forEach(record => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }

                const attendanceRecords = record.records || record.attendance || {};
                const totalStudents = Object.keys(attendanceRecords).length;
                const presentStudents = Object.values(attendanceRecords).filter(status => status === 'present').length;
                const absentStudents = totalStudents - presentStudents;
                const percentage = totalStudents > 0 ? ((presentStudents / totalStudents) * 100).toFixed(1) : 0;

                totalClasses++;
                totalPresent += presentStudents;
                totalStudentDays += totalStudents;

                doc.text(new Date(record.date).toLocaleDateString(), 20, yPos);
                doc.text(`${record.lectureNumber}${getOrdinalSuffix(record.lectureNumber)}`, 50, yPos);
                doc.text(totalStudents.toString(), 90, yPos);
                doc.text(presentStudents.toString(), 130, yPos);
                doc.text(absentStudents.toString(), 155, yPos);

                // Color code percentage
                if (percentage < 70) {
                    doc.setTextColor(255, 0, 0); // Red
                } else if (percentage < 85) {
                    doc.setTextColor(255, 165, 0); // Orange
                } else {
                    doc.setTextColor(0, 128, 0); // Green
                }
                doc.text(`${percentage}%`, 175, yPos);
                doc.setTextColor(0, 0, 0); // Reset

                yPos += 8;
            });

            // Overall statistics
            yPos += 10;
            doc.setLineWidth(0.5);
            doc.line(20, yPos, 200, yPos);
            yPos += 10;

            doc.setFont(undefined, 'bold');
            doc.text('OVERALL STATISTICS', 20, yPos);
            yPos += 15;

            doc.setFont(undefined, 'normal');
            doc.text(`Total Classes Conducted: ${totalClasses}`, 20, yPos);
            yPos += 10;
            doc.text(`Total Student-Days: ${totalStudentDays}`, 20, yPos);
            yPos += 10;
            doc.text(`Total Present: ${totalPresent}`, 20, yPos);
            yPos += 10;
            doc.text(`Total Absent: ${totalStudentDays - totalPresent}`, 20, yPos);
            yPos += 10;

            const overallPercentage = totalStudentDays > 0 ? ((totalPresent / totalStudentDays) * 100).toFixed(1) : 0;
            doc.setFont(undefined, 'bold');
            doc.text(`Overall Attendance Rate: ${overallPercentage}%`, 20, yPos);

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.text('Generated by Attendance Tracker System', 105, 285, { align: 'center' });
            }

            doc.save(`${subjectName}_Class_Attendance_Report.pdf`);
        }

        // Export to PDF - Detailed Analysis Report
        function exportDetailedAnalysisPDF() {
            const subjectSelect = document.getElementById('summary-subject');
            const selectedSubjectId = subjectSelect.value;

            if (!selectedSubjectId) {
                alert('Please select a subject first');
                return;
            }

            const subjects = getSubjects();
            const selectedSubject = subjects.find(s => s.id == selectedSubjectId);
            const subjectName = selectedSubject ? selectedSubject.name : 'Unknown Subject';

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('DETAILED ANALYSIS REPORT', 105, 25, { align: 'center' });

            doc.setFontSize(18);
            doc.setFont(undefined, 'normal');
            doc.text(`Subject: ${subjectName}`, 105, 40, { align: 'center' });

            // Institution details
            doc.setFontSize(12);
            doc.text('Generated by: Attendance Tracker System', 20, 55);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 65);
            doc.text(`Time: ${new Date().toLocaleTimeString()}`, 20, 75);

            // Line separator
            doc.setLineWidth(0.5);
            doc.line(20, 85, 190, 85);

            const students = getStudents();
            const attendance = getAttendance();
            const subjectAttendance = Object.values(attendance).filter(record => record.subjectId == selectedSubjectId);

            if (subjectAttendance.length === 0) {
                doc.setFontSize(14);
                doc.text('No attendance records found for this subject.', 20, 105);
                doc.save(`${subjectName}_Detailed_Analysis_Report.pdf`);
                return;
            }

            // Calculate comprehensive statistics
            const studentStats = {};
            students.forEach(student => {
                studentStats[student.roll] = {
                    name: student.name,
                    roll: student.roll,
                    present: 0,
                    absent: 0,
                    total: 0,
                    lectureWise: {}
                };
            });

            // Lecture-wise analysis
            const lectureStats = { 1: { present: 0, total: 0 }, 2: { present: 0, total: 0 }, 3: { present: 0, total: 0 } };

            subjectAttendance.forEach(record => {
                const attendanceRecords = record.records || record.attendance || {};
                const lectureNum = record.lectureNumber || 1;

                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (studentStats[rollNumber]) {
                        studentStats[rollNumber].total++;
                        if (status === 'present') {
                            studentStats[rollNumber].present++;
                            lectureStats[lectureNum].present++;
                        } else {
                            studentStats[rollNumber].absent++;
                        }
                        lectureStats[lectureNum].total++;

                        if (!studentStats[rollNumber].lectureWise[lectureNum]) {
                            studentStats[rollNumber].lectureWise[lectureNum] = { present: 0, total: 0 };
                        }
                        studentStats[rollNumber].lectureWise[lectureNum].total++;
                        if (status === 'present') {
                            studentStats[rollNumber].lectureWise[lectureNum].present++;
                        }
                    }
                });
            });

            let yPos = 100;

            // Executive Summary
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('EXECUTIVE SUMMARY', 20, yPos);
            yPos += 15;

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');

            const validStats = Object.values(studentStats).filter(stat => stat.total > 0);
            const avgAttendance = validStats.length > 0 ?
                (validStats.reduce((sum, stat) => sum + (stat.present / stat.total * 100), 0) / validStats.length).toFixed(1) : 0;

            doc.text(`• Total Students Enrolled: ${students.length}`, 20, yPos);
            yPos += 10;
            doc.text(`• Students with Attendance Records: ${validStats.length}`, 20, yPos);
            yPos += 10;
            doc.text(`• Total Classes Conducted: ${subjectAttendance.length}`, 20, yPos);
            yPos += 10;
            doc.text(`• Average Class Attendance: ${avgAttendance}%`, 20, yPos);
            yPos += 20;

            // Lecture-wise Performance
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('LECTURE-WISE PERFORMANCE ANALYSIS', 20, yPos);
            yPos += 15;

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');

            [1, 2, 3].forEach(lectureNum => {
                const stats = lectureStats[lectureNum];
                if (stats.total > 0) {
                    const percentage = ((stats.present / stats.total) * 100).toFixed(1);
                    doc.text(`• ${lectureNum}${getOrdinalSuffix(lectureNum)} Lecture: ${percentage}% attendance (${stats.present}/${stats.total})`, 20, yPos);
                    yPos += 10;
                }
            });

            yPos += 10;

            // Attendance Categories
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('STUDENT CATEGORIZATION', 20, yPos);
            yPos += 15;

            const excellentStudents = validStats.filter(stat => (stat.present / stat.total * 100) >= 90);
            const goodStudents = validStats.filter(stat => (stat.present / stat.total * 100) >= 75 && (stat.present / stat.total * 100) < 90);
            const averageStudents = validStats.filter(stat => (stat.present / stat.total * 100) >= 60 && (stat.present / stat.total * 100) < 75);
            const poorStudents = validStats.filter(stat => (stat.present / stat.total * 100) < 60);

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`• Excellent (≥90%): ${excellentStudents.length} students`, 20, yPos);
            yPos += 10;
            doc.text(`• Good (75-89%): ${goodStudents.length} students`, 20, yPos);
            yPos += 10;
            doc.text(`• Average (60-74%): ${averageStudents.length} students`, 20, yPos);
            yPos += 10;
            doc.text(`• Poor (<60%): ${poorStudents.length} students`, 20, yPos);
            yPos += 20;

            // At-Risk Students
            if (poorStudents.length > 0) {
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('AT-RISK STUDENTS (Attendance < 60%)', 20, yPos);
                yPos += 15;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                poorStudents.forEach(student => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    const percentage = ((student.present / student.total) * 100).toFixed(1);
                    doc.text(`• ${student.name} (${student.roll}): ${percentage}% - ${student.present}/${student.total}`, 20, yPos);
                    yPos += 8;
                });
                yPos += 10;
            }

            // New page for detailed breakdown
            doc.addPage();
            yPos = 20;

            // Complete Student List with Details
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('COMPLETE STUDENT ATTENDANCE BREAKDOWN', 20, yPos);
            yPos += 20;

            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('Roll', 20, yPos);
            doc.text('Name', 40, yPos);
            doc.text('Present', 90, yPos);
            doc.text('Absent', 110, yPos);
            doc.text('Total', 130, yPos);
            doc.text('%', 150, yPos);
            doc.text('1st Lec', 165, yPos);
            doc.text('2nd Lec', 180, yPos);
            doc.text('3rd Lec', 195, yPos);

            doc.setLineWidth(0.3);
            doc.line(20, yPos + 3, 210, yPos + 3);

            yPos += 10;
            doc.setFont(undefined, 'normal');

            validStats.sort((a, b) => {
                const percentageA = (a.present / a.total) * 100;
                const percentageB = (b.present / b.total) * 100;
                return percentageB - percentageA;
            });

            validStats.forEach(stat => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }

                const percentage = ((stat.present / stat.total) * 100).toFixed(1);

                doc.text(stat.roll, 20, yPos);
                doc.text(stat.name.substring(0, 20), 40, yPos);
                doc.text(stat.present.toString(), 95, yPos);
                doc.text(stat.absent.toString(), 115, yPos);
                doc.text(stat.total.toString(), 135, yPos);
                doc.text(`${percentage}%`, 150, yPos);

                // Lecture-wise percentages
                [1, 2, 3].forEach((lectureNum, index) => {
                    const lectureData = stat.lectureWise[lectureNum];
                    if (lectureData && lectureData.total > 0) {
                        const lecturePercentage = ((lectureData.present / lectureData.total) * 100).toFixed(0);
                        doc.text(`${lecturePercentage}%`, 165 + (index * 15), yPos);
                    } else {
                        doc.text('N/A', 165 + (index * 15), yPos);
                    }
                });

                yPos += 8;
            });

            // Footer with recommendations
            doc.addPage();
            yPos = 20;

            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('RECOMMENDATIONS', 20, yPos);
            yPos += 20;

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');

            if (parseFloat(avgAttendance) < 75) {
                doc.text('• Overall attendance is below 75%. Consider implementing attendance improvement strategies.', 20, yPos);
                yPos += 15;
            }

            if (poorStudents.length > 0) {
                doc.text(`• ${poorStudents.length} students have attendance below 60%. Individual counseling recommended.`, 20, yPos);
                yPos += 15;
            }

            // Find best and worst performing lecture
            const lecturePerformances = [1, 2, 3].map(num => ({
                lecture: num,
                percentage: lectureStats[num].total > 0 ? (lectureStats[num].present / lectureStats[num].total * 100) : 0
            })).filter(l => l.percentage > 0);

            if (lecturePerformances.length > 1) {
                lecturePerformances.sort((a, b) => b.percentage - a.percentage);
                doc.text(`• Best performing lecture: ${lecturePerformances[0].lecture}${getOrdinalSuffix(lecturePerformances[0].lecture)} (${lecturePerformances[0].percentage.toFixed(1)}%)`, 20, yPos);
                yPos += 10;
                doc.text(`• Lowest performing lecture: ${lecturePerformances[lecturePerformances.length - 1].lecture}${getOrdinalSuffix(lecturePerformances[lecturePerformances.length - 1].lecture)} (${lecturePerformances[lecturePerformances.length - 1].percentage.toFixed(1)}%)`, 20, yPos);
                yPos += 15;
            }

            doc.text('• Regular monitoring and follow-up with at-risk students is recommended.', 20, yPos);
            yPos += 10;
            doc.text('• Consider implementing make-up sessions for students with low attendance.', 20, yPos);

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.text('Generated by Attendance Tracker System', 105, 285, { align: 'center' });
            }

            doc.save(`${subjectName}_Detailed_Analysis_Report.pdf`);
        }

        // Add new student
        function addStudent() {
            const name = document.getElementById('student-name').value.trim();
            const roll = document.getElementById('student-roll').value.trim();
            const messageDiv = document.getElementById('manage-message');

            if (!name || !roll) {
                showMessage(messageDiv, 'Please enter both name and roll number', 'error');
                return;
            }

            const students = getStudents();

            if (students.some(student => student.roll === roll)) {
                showMessage(messageDiv, 'Roll number already exists', 'error');
                return;
            }

            const newStudent = {
                id: Date.now(),
                roll: roll,
                name: name
            };

            students.push(newStudent);
            setStudents(students);

            document.getElementById('student-name').value = '';
            document.getElementById('student-roll').value = '';

            showMessage(messageDiv, `Student ${name} added successfully`, 'success');
            loadCurrentStudents();
        }

        // Bulk import students
        function bulkImportStudents() {
            const bulkText = document.getElementById('bulk-import-text').value.trim();
            const messageDiv = document.getElementById('manage-message');

            if (!bulkText) {
                showMessage(messageDiv, 'Please paste student data', 'error');
                return;
            }

            const lines = bulkText.split('\n').filter(line => line.trim());
            const students = getStudents();
            const newStudents = [];
            const errors = [];
            const duplicates = [];

            lines.forEach((line, index) => {
                const lineNum = index + 1;

                // Handle both comma and tab separated values
                let parts;
                if (line.includes('\t')) {
                    parts = line.split('\t').map(part => part.trim());
                } else if (line.includes(',')) {
                    parts = line.split(',').map(part => part.trim());
                } else {
                    errors.push(`Line ${lineNum}: Invalid format (missing comma or tab)`);
                    return;
                }

                if (parts.length < 2) {
                    errors.push(`Line ${lineNum}: Missing roll number or name`);
                    return;
                }

                const roll = parts[0].trim();
                const name = parts[1].trim();

                if (!roll || !name) {
                    errors.push(`Line ${lineNum}: Empty roll number or name`);
                    return;
                }

                // Check for duplicates in existing students
                if (students.some(student => student.roll === roll)) {
                    duplicates.push(`${roll} (${name})`);
                    return;
                }

                // Check for duplicates in current import
                if (newStudents.some(student => student.roll === roll)) {
                    errors.push(`Line ${lineNum}: Duplicate roll number ${roll} in import data`);
                    return;
                }

                newStudents.push({
                    id: Date.now() + index,
                    roll: roll,
                    name: name
                });
            });

            // Show results
            let message = '';
            if (newStudents.length > 0) {
                students.push(...newStudents);
                setStudents(students);
                message += `Successfully imported ${newStudents.length} students. `;
                loadCurrentStudents();
            }

            if (duplicates.length > 0) {
                message += `${duplicates.length} duplicates skipped: ${duplicates.slice(0, 3).join(', ')}${duplicates.length > 3 ? '...' : ''}. `;
            }

            if (errors.length > 0) {
                message += `${errors.length} errors: ${errors.slice(0, 2).join('; ')}${errors.length > 2 ? '...' : ''}. `;
            }

            const messageType = newStudents.length > 0 ? 'success' : (errors.length > 0 ? 'error' : 'error');
            showMessage(messageDiv, message || 'No valid data found', messageType);

            if (newStudents.length > 0) {
                document.getElementById('bulk-import-text').value = '';
            }
        }

        // Add new subject
        function addSubject() {
            const subjectName = document.getElementById('subject-name').value.trim();
            const messageDiv = document.getElementById('manage-message');

            if (!subjectName) {
                showMessage(messageDiv, 'Please enter subject name', 'error');
                return;
            }

            const subjects = getSubjects();

            if (subjects.some(subject => subject.name === subjectName)) {
                showMessage(messageDiv, 'Subject already exists', 'error');
                return;
            }

            const newSubject = {
                id: Date.now(),
                name: subjectName
            };

            subjects.push(newSubject);
            setSubjects(subjects);

            document.getElementById('subject-name').value = '';

            showMessage(messageDiv, `Subject ${subjectName} added successfully`, 'success');
            loadCurrentSubjects();
        }

        // Load current students for management
        function loadCurrentStudents() {
            const students = getStudents();
            const container = document.getElementById('current-students');

            if (students.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No students added yet.</p>';
                return;
            }

            let html = '<h4 style="margin-bottom: 15px; color: var(--text-primary);">Current Students</h4>';
            students.forEach((student, index) => {
                html += `
                    <div class="student-item">
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-roll">Roll: ${student.roll}</div>
                        </div>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8em;" onclick="removeStudent(${index})">
                            🗑️ Remove
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Load current subjects for management
        function loadCurrentSubjects() {
            const subjects = getSubjects();
            const container = document.getElementById('current-subjects');

            if (subjects.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No subjects added yet.</p>';
                return;
            }

            let html = '<h4 style="margin-bottom: 15px; color: var(--text-primary);">Current Subjects</h4>';
            subjects.forEach((subject, index) => {
                html += `
                    <div class="student-item">
                        <div class="student-info">
                            <div class="student-name">${subject.name}</div>
                        </div>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8em;" onclick="removeSubject(${index})">
                            🗑️ Remove
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Remove student
        function removeStudent(index) {
            if (confirm('Are you sure you want to remove this student?')) {
                const students = getStudents();
                students.splice(index, 1);
                setStudents(students);
                loadCurrentStudents();
                showMessage(document.getElementById('manage-message'), 'Student removed successfully', 'success');
            }
        }

        // Remove subject
        function removeSubject(index) {
            if (confirm('Are you sure you want to remove this subject? This will also remove all attendance records for this subject.')) {
                const subjects = getSubjects();
                const subjectToRemove = subjects[index];
                subjects.splice(index, 1);
                setSubjects(subjects);

                const attendance = getAttendance();
                Object.keys(attendance).forEach(key => {
                    if (attendance[key].subjectId == subjectToRemove.id) {
                        delete attendance[key];
                    }
                });
                setAttendance(attendance);

                loadCurrentSubjects();
                showMessage(document.getElementById('manage-message'), 'Subject and related attendance records removed successfully', 'success');
            }
        }

        // Export data as JSON
        function exportData() {
            const data = {
                students: getStudents(),
                subjects: getSubjects(),
                attendance: getAttendance(),
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Import data from JSON
        function importData() {
            document.getElementById('import-file').click();
        }

        // Handle file import
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (confirm('This will replace all current data. Are you sure?')) {
                        if (data.students) setStudents(data.students);
                        if (data.subjects) setSubjects(data.subjects);
                        if (data.attendance) setAttendance(data.attendance);

                        showMessage(document.getElementById('manage-message'), 'Data imported successfully!', 'success');
                        loadCurrentStudents();
                        loadCurrentSubjects();
                    }
                } catch (error) {
                    showMessage(document.getElementById('manage-message'), 'Invalid file format', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Clear functions
        function clearAllAttendance() {
            if (confirm('Are you sure you want to clear all attendance records? This cannot be undone.')) {
                setAttendance({});
                showMessage(document.getElementById('manage-message'), 'All attendance records cleared', 'success');
            }
        }

        function clearAllStudents() {
            if (confirm('Are you sure you want to clear all students? This will also clear all attendance records.')) {
                setStudents([]);
                setAttendance({});
                showMessage(document.getElementById('manage-message'), 'All students and attendance records cleared', 'success');
                loadCurrentStudents();
            }
        }

        function clearAllSubjects() {
            if (confirm('Are you sure you want to clear all subjects? This will also clear all attendance records.')) {
                setSubjects([]);
                setAttendance({});
                showMessage(document.getElementById('manage-message'), 'All subjects and attendance records cleared', 'success');
                loadCurrentSubjects();
            }
        }

        // Event listeners and initialization
        document.addEventListener('DOMContentLoaded', function () {
            // Subject selection for attendance
            document.getElementById('subject-select').addEventListener('change', function () {
                loadStudentsForAttendance();
                if (selectedLecture) {
                    const subjectId = this.value;
                    const date = document.getElementById('class-date').value;
                    if (subjectId && date) {
                        updateLectureInfo(subjectId, date, selectedLecture);
                    }
                }
            });

            // Date change for attendance
            document.getElementById('class-date').addEventListener('change', function () {
                if (selectedLecture) {
                    const subjectId = document.getElementById('subject-select').value;
                    const date = this.value;
                    if (subjectId && date) {
                        updateLectureInfo(subjectId, date, selectedLecture);
                    }
                }
            });

            // Subject selection for tracking
            document.getElementById('track-subject').addEventListener('change', showAttendanceSummary);

            // Enter key handlers for forms
            document.getElementById('student-name').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') addStudent();
            });

            document.getElementById('student-roll').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') addStudent();
            });

            document.getElementById('subject-name').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') addSubject();
            });

            // Initialize the app
            switchTab('attendance');
        });
    </script>
</body>

</html>