<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracker</title>
    <style>
        :root {
            --primary-color: #2196F3;
            --primary-dark: #1976D2;
            --primary-light: #E3F2FD;
            --secondary-color: #FF9800;
            --secondary-dark: #F57C00;
            --accent-color: #4CAF50;
            --accent-dark: #388E3C;
            --error-color: #F44336;
            --warning-color: #FF9800;
            --surface-color: #FFFFFF;
            --surface-dark: #F5F5F5;
            --text-primary: #212121;
            --text-secondary: #757575;
            --divider-color: #E0E0E0;
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 8px 16px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
            --border-radius-small: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-light) 0%, #f8f9fa 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 16px;
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
            background: var(--surface-color);
            min-height: 100vh;
            box-shadow: var(--shadow-medium);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .tab-content {
            display: none;
            padding: 20px 0;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--divider-color);
            border-radius: var(--border-radius-small);
            font-size: 14px;
            transition: var(--transition);
            background: var(--surface-color);
        }

        textarea {
            font-family: 'Courier New', monospace;
            resize: vertical;
            min-height: 80px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-color), #d32f2f);
        }

        .btn-block {
            width: 100%;
            margin-bottom: 12px;
        }

        .student-list {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--divider-color);
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--divider-color);
            transition: var(--transition);
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-item:hover {
            background: var(--surface-dark);
            margin: 0 -15px;
            padding-left: 15px;
            padding-right: 15px;
            border-radius: var(--border-radius-small);
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .student-roll {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .attendance-btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            margin-left: 6px;
            font-size: 12px;
        }

        .btn-present {
            background: var(--accent-color);
            color: white;
        }

        .btn-absent {
            background: var(--error-color);
            color: white;
        }

        .btn-present:hover {
            background: var(--accent-dark);
        }

        .btn-absent:hover {
            background: #d32f2f;
        }

        .attendance-status {
            padding: 6px 12px;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            font-size: 12px;
            transition: var(--transition);
            min-width: 80px;
            text-align: center;
            display: inline-block;
            margin-left: 6px;
        }

        .present-status {
            background: #e8f5e8;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        .absent-status {
            background: #ffeaea;
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .lecture-btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            margin: 3px;
            background: #e0e0e0;
            color: #333;
            flex: 1;
            font-size: 12px;
        }

        .lecture-btn.selected {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .lecture-btn:hover {
            background: var(--primary-light);
        }

        .lecture-selection {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .summary-card {
            background: var(--surface-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--primary-color);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .summary-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .summary-percentage {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: var(--surface-dark);
            border-radius: var(--border-radius-small);
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: linear-gradient(135deg, var(--surface-color), var(--surface-dark));
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: var(--shadow-heavy);
            border-top: 1px solid var(--divider-color);
            backdrop-filter: blur(10px);
        }

        .tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
            border-radius: var(--border-radius-small);
            min-width: 70px;
        }

        .tab:hover {
            background: var(--primary-light);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .tab-icon {
            font-size: 1.5em;
            margin-bottom: 4px;
        }

        .tab-label {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message {
            padding: 12px;
            border-radius: var(--border-radius-small);
            margin-bottom: 16px;
            font-weight: 500;
            text-align: center;
        }

        .message.success {
            background: #e8f5e8;
            color: var(--accent-dark);
            border: 1px solid var(--accent-color);
        }

        .message.error {
            background: #ffeaea;
            color: #c62828;
            border: 1px solid var(--error-color);
        }

        .hidden {
            display: none !important;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--divider-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--primary-color));
            transition: width 0.3s ease;
        }

        .export-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .danger-zone {
            background: #ffeaea;
            border: 1px solid var(--error-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 30px;
        }

        .danger-zone h3 {
            color: var(--error-color);
            margin-bottom: 15px;
        }

        .danger-zone .btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .bulk-import-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px dashed var(--primary-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
            transition: var(--transition);
        }

        .bulk-import-section:hover {
            background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
            border-color: var(--primary-dark);
        }

        .enhanced-summary-card {
            background: linear-gradient(145deg, var(--surface-color), #f8f9fa);
            border: 1px solid var(--divider-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .enhanced-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        .lecture-sequence-info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 0.85em;
        }

        .summary-type-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--surface-dark);
            border-radius: var(--border-radius);
        }

        .summary-type-btn {
            padding: 10px 8px;
            border: 2px solid var(--divider-color);
            border-radius: var(--border-radius-small);
            background: var(--surface-color);
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
            transition: var(--transition);
        }

        .summary-type-btn:hover {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .summary-type-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-dark);
        }

        .summary-section {
            display: none;
            background: var(--surface-color);
            padding: 15px;
            border-radius: var(--border-radius);
            border: 1px solid var(--divider-color);
            margin-bottom: 20px;
        }

        .summary-section.active {
            display: block;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
                padding-bottom: 90px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .summary-stats {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .export-options {
                grid-template-columns: 1fr;
            }

            .tab-bar {
                padding: 8px 0;
            }

            .tab-icon {
                font-size: 1.2em;
            }

            .tab-label {
                font-size: 0.7em;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìö Attendance Tracker</h1>
            <p>Manage student attendance efficiently</p>
        </div>

        <!-- Take Attendance Tab -->
        <div class="tab-content active" id="attendance">
            <div class="form-group">
                <label for="subject-select">Select Subject:</label>
                <select id="subject-select">
                    <option value="">Choose a subject...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="class-date">Class Date:</label>
                <input type="date" id="class-date">
            </div>

            <div class="form-group">
                <label>Select Lecture:</label>
                <div class="lecture-selection">
                    <button class="lecture-btn" onclick="selectLecture(1)">1st Lecture</button>
                    <button class="lecture-btn" onclick="selectLecture(2)">2nd Lecture</button>
                    <button class="lecture-btn" onclick="selectLecture(3)">3rd Lecture</button>
                </div>
                <div id="lecture-info"
                    style="font-size: 14px; color: var(--text-secondary); text-align: center; margin-top: 8px;">
                    Select lecture number first
                </div>
            </div>

            <div id="student-attendance" class="student-list hidden">
                <!-- Students will be loaded here -->
            </div>

            <button class="btn btn-success btn-block" onclick="saveAttendance()">
                üíæ Save Attendance
            </button>

            <div id="attendance-message" class="message hidden"></div>
        </div>

        <!-- Track Attendance Tab -->
        <div class="tab-content" id="track">
            <div class="form-group">
                <label for="track-subject">Select Subject:</label>
                <select id="track-subject">
                    <option value="">Choose a subject...</option>
                </select>
            </div>

            <div id="attendance-summary" class="attendance-summary">
                <!-- Attendance summary will be loaded here -->
            </div>
        </div>

        <!-- Summary Tab -->
        <div class="tab-content" id="summary">
            <h3 style="margin-bottom: 20px; color: var(--text-primary); text-align: center;">üìä Attendance Summary</h3>

            <!-- Summary Type Selection -->
            <div class="summary-type-selection">
                <button class="summary-type-btn active" onclick="selectSummaryType('student-wise')">
                    üë• Student Wise
                </button>
                <button class="summary-type-btn" onclick="selectSummaryType('subject-wise')">
                    üìö Subject Wise
                </button>
                <button class="summary-type-btn" onclick="selectSummaryType('roll-search')">
                    üîç Roll Search
                </button>
            </div>

            <!-- Student Wise Summary -->
            <div id="student-wise-section" class="summary-section active">
                <h4 style="margin: 20px 0 15px 0; color: var(--primary-color);">üë• Student Wise Summary</h4>
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 15px;">
                    Shows all students with attendance details for each subject including absent dates.
                </p>
                <div class="export-options">
                    <button class="btn btn-success btn-block" onclick="generateStudentWiseSummary()">
                        üìä View Summary
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="exportStudentWisePDF()">
                        üìÑ Export PDF
                    </button>
                </div>
            </div>

            <!-- Subject Wise Summary -->
            <div id="subject-wise-section" class="summary-section">
                <h4 style="margin: 20px 0 15px 0; color: var(--primary-color);">üìö Subject Wise Summary</h4>
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 15px;">
                    Shows attendance records for a specific subject with absent students for each lecture.
                </p>
                <div class="form-group">
                    <label for="subject-wise-select">Select Subject (Required):</label>
                    <select id="subject-wise-select">
                        <option value="">Choose a subject...</option>
                    </select>
                </div>
                <div class="export-options">
                    <button class="btn btn-success btn-block" onclick="generateSubjectWiseSummary()">
                        üìä View Summary
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="exportSubjectWisePDF()">
                        üìÑ Export PDF
                    </button>
                </div>
            </div>

            <!-- Roll Number Search -->
            <div id="roll-search-section" class="summary-section">
                <h4 style="margin: 20px 0 15px 0; color: var(--primary-color);">üîç Roll Number Search</h4>
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 15px;">
                    Search by roll number to see attendance details across all subjects.
                </p>
                <div class="form-group">
                    <label for="roll-search-input">Enter Roll Number (partial or complete):</label>
                    <input type="text" id="roll-search-input" placeholder="e.g., 2021-CS-001 or just 001">
                </div>
                <div class="export-options">
                    <button class="btn btn-success btn-block" onclick="generateRollSearchSummary()">
                        üîç Search & View
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="exportRollSearchPDF()">
                        üìÑ Export PDF
                    </button>
                </div>
            </div>

            <div id="summary-content">
                <!-- Summary content will be loaded here -->
            </div>
        </div>

        <!-- Manage Tab -->
        <div class="tab-content" id="manage">
            <h3 style="margin-bottom: 20px; color: var(--text-primary);">üë• Manage Students</h3>

            <div class="form-group">
                <label for="student-name">Student Name:</label>
                <input type="text" id="student-name" placeholder="Enter student name">
            </div>

            <div class="form-group">
                <label for="student-roll">Roll Number:</label>
                <input type="text" id="student-roll" placeholder="Enter roll number">
            </div>

            <button class="btn btn-success btn-block" onclick="addStudent()">
                ‚ûï Add Student
            </button>

            <h4 style="margin: 20px 0 15px 0; color: var(--text-primary);">üìÑ Bulk Import Students</h4>
            <div class="form-group">
                <label for="bulk-import-text">Paste Excel data (Roll Number, Name):</label>
                <textarea id="bulk-import-text" rows="6"
                    placeholder="Example:&#10;2021-CS-001, John Doe&#10;2021-CS-002, Jane Smith&#10;2021-CS-003, Mike Johnson&#10;&#10;Or tab-separated from Excel copy-paste"></textarea>
            </div>
            <button class="btn btn-secondary btn-block" onclick="bulkImportStudents()">
                üìã Import Students from Text
            </button>

            <h3 style="margin: 30px 0 20px 0; color: var(--text-primary);">üìö Manage Subjects</h3>

            <div class="form-group">
                <label for="subject-name">Subject Name:</label>
                <input type="text" id="subject-name" placeholder="Enter subject name">
            </div>

            <button class="btn btn-success btn-block" onclick="addSubject()">
                ‚ûï Add Subject
            </button>

            <div id="current-students" class="student-list">
                <!-- Current students will be loaded here -->
            </div>

            <div id="current-subjects" class="student-list">
                <!-- Current subjects will be loaded here -->
            </div>

            <h3 style="margin: 30px 0 20px 0; color: var(--text-primary);">üíæ Backup & Import</h3>

            <div class="export-options">
                <button class="btn btn-secondary" onclick="exportData()">
                    üíæ Backup Data
                </button>
                <button class="btn" onclick="importData()">
                    üìÅ Import Data
                </button>
            </div>
            <input type="file" id="import-file" accept=".json" style="display: none;"
                onchange="handleFileImport(event)">

            <div class="danger-zone">
                <h3>‚ö†Ô∏è Danger Zone</h3>
                <button class="btn btn-danger" onclick="clearAllAttendance()">Clear All Attendance</button>
                <button class="btn btn-danger" onclick="clearAllStudents()">Clear All Students</button>
                <button class="btn btn-danger" onclick="clearAllSubjects()">Clear All Subjects</button>
                <div style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary);">
                    ‚ö†Ô∏è Warning: These actions cannot be undone. Export data first if needed.
                </div>
            </div>

            <div id="manage-message" class="message hidden"></div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab active" onclick="switchTab('attendance')">
            <span class="tab-icon">üìù</span>
            <span class="tab-label">Take</span>
        </div>
        <div class="tab" onclick="switchTab('track')">
            <span class="tab-icon">üìä</span>
            <span class="tab-label">Track</span>
        </div>
        <div class="tab" onclick="switchTab('summary')">
            <span class="tab-icon">üìã</span>
            <span class="tab-label">Summary</span>
        </div>
        <div class="tab" onclick="switchTab('manage')">
            <span class="tab-icon">‚öôÔ∏è</span>
            <span class="tab-label">Manage</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Global variables
        let selectedLecture = null;
        let currentAttendance = {};

        // Data storage utilities - ALL FUNCTIONS ARE AT GLOBAL SCOPE
        function getStudents() {
            return JSON.parse(localStorage.getItem('students') || '[]');
        }

        function setStudents(students) {
            localStorage.setItem('students', JSON.stringify(students));
        }

        function getSubjects() {
            return JSON.parse(localStorage.getItem('subjects') || '[]');
        }

        function setSubjects(subjects) {
            localStorage.setItem('subjects', JSON.stringify(subjects));
        }

        function getAttendance() {
            return JSON.parse(localStorage.getItem('attendance') || '{}');
        }

        function setAttendance(attendance) {
            localStorage.setItem('attendance', JSON.stringify(attendance));
        }

        // Show message helper
        function showMessage(element, message, type = 'error') {
            element.textContent = message;
            element.className = `message ${type}`;
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 5000);
        }

        // Tab functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to selected tab
            document.querySelector(`.tab:nth-child(${getTabIndex(tabName)})`).classList.add('active');

            // Load content for the selected tab
            if (tabName === 'attendance') {
                loadSubjects('subject-select');
                setTodayDate();
                selectedLecture = null;
                document.querySelectorAll('.lecture-btn').forEach(btn => btn.classList.remove('selected'));
                document.getElementById('lecture-info').textContent = 'Select lecture number first';
            } else if (tabName === 'track') {
                loadSubjects('track-subject');
            } else if (tabName === 'summary') {
                loadSubjects('subject-wise-select');
                selectSummaryType('student-wise');
            } else if (tabName === 'manage') {
                loadCurrentStudents();
                loadCurrentSubjects();
            }
        }

        function getTabIndex(tabName) {
            const tabs = ['attendance', 'track', 'summary', 'manage'];
            return tabs.indexOf(tabName) + 1;
        }

        // Set today's date as default
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('class-date').value = today;
        }

        // Load subjects into select dropdown
        function loadSubjects(selectId) {
            const select = document.getElementById(selectId);
            const subjects = getSubjects();

            select.innerHTML = '<option value="">Choose a subject...</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                select.appendChild(option);
            });
        }

        // Lecture selection
        function selectLecture(lectureNumber) {
            selectedLecture = lectureNumber;

            // Update UI
            document.querySelectorAll('.lecture-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');

            // Update lecture info with enhanced tracking
            const subjectId = document.getElementById('subject-select').value;
            const date = document.getElementById('class-date').value;

            if (subjectId && date) {
                updateLectureInfo(subjectId, date, lectureNumber);
            } else {
                document.getElementById('lecture-info').textContent = `${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture selected`;
            }

            loadStudentsForAttendance();

            // Show lecture sequence info
            if (subjectId) {
                showLectureSequence(subjectId, date);
            }
        }

        // Show lecture sequence and patterns
        function showLectureSequence(subjectId, date) {
            const attendance = getAttendance();
            const subjectAttendance = Object.values(attendance).filter(record => record.subjectId == subjectId);

            if (subjectAttendance.length > 0) {
                // Group by date to show lecture patterns
                const dateGroups = {};
                subjectAttendance.forEach(record => {
                    if (!dateGroups[record.date]) {
                        dateGroups[record.date] = [];
                    }
                    dateGroups[record.date].push(record.lectureNumber);
                });

                const lectureInfoDiv = document.getElementById('lecture-info');
                const currentInfo = lectureInfoDiv.textContent;

                // Show recent lecture pattern
                const recentDates = Object.keys(dateGroups).sort().slice(-3);
                if (recentDates.length > 0) {
                    const patternInfo = recentDates.map(d => {
                        const lectures = dateGroups[d].sort().join(', ');
                        return `${new Date(d).toLocaleDateString()}: L${lectures}`;
                    }).join(' | ');

                    lectureInfoDiv.innerHTML = `${currentInfo}<br><small style="color: var(--text-secondary);">Recent: ${patternInfo}</small>`;
                }
            }
        }

        function getOrdinalSuffix(num) {
            const suffixes = ['th', 'st', 'nd', 'rd'];
            const v = num % 100;
            return suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0];
        }

        function updateLectureInfo(subjectId, date, lectureNumber) {
            const subjects = getSubjects();
            const subject = subjects.find(s => s.id == subjectId);
            const subjectName = subject ? subject.name : 'Unknown Subject';

            const attendance = getAttendance();
            const key = `${date}_${subjectId}_${lectureNumber}`;

            if (attendance[key]) {
                const totalStudents = Object.keys(attendance[key].records).length;
                const presentStudents = Object.values(attendance[key].records).filter(status => status === 'present').length;
                document.getElementById('lecture-info').textContent =
                    `${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture - ${subjectName} (${presentStudents}/${totalStudents} present)`;
            } else {
                document.getElementById('lecture-info').textContent =
                    `${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture - ${subjectName} (Not taken yet)`;
            }
        }

        // Load students for attendance taking
        function loadStudentsForAttendance() {
            const subjectSelect = document.getElementById('subject-select');
            const selectedSubjectId = subjectSelect.value;
            const studentAttendanceDiv = document.getElementById('student-attendance');

            if (!selectedSubjectId || !selectedLecture) {
                studentAttendanceDiv.classList.add('hidden');
                return;
            }

            const students = getStudents();
            studentAttendanceDiv.classList.remove('hidden');

            // Reset and preset all students as absent
            currentAttendance = {};
            students.forEach(student => {
                currentAttendance[student.roll] = 'absent';
            });

            let html = '<h3 style="margin-bottom: 15px; color: var(--text-primary);">Mark Attendance</h3>';
            html += '<p style="margin-bottom: 15px; padding: 10px; background: #fff3e0; border-radius: 8px; border-left: 4px solid var(--warning-color); font-size: 14px; color: var(--text-primary);">üìù <strong>Quick Mode:</strong> All students are preset as <strong>Absent</strong>. Click "Present" for students who attended.</p>';

            students.forEach(student => {
                html += `
                    <div class="student-item" data-roll="${student.roll}">
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-roll">Roll: ${student.roll}</div>
                        </div>
                        <div>
                            <button class="attendance-btn btn-present" onclick="markAttendance('${student.roll}', 'present', this)">
                                ‚úì Present
                            </button>
                            <span class="attendance-status absent-status">‚úó Absent</span>
                        </div>
                    </div>
                `;
            });

            studentAttendanceDiv.innerHTML = html;
        }

        // Mark individual student attendance
        function markAttendance(rollNumber, status, clickedButton) {
            currentAttendance[rollNumber] = status;

            const studentItem = clickedButton.closest('.student-item');
            const presentBtn = studentItem.querySelector('.btn-present');
            const statusSpan = studentItem.querySelector('.attendance-status');

            if (status === 'present') {
                // Mark as present
                presentBtn.style.opacity = '1';
                presentBtn.style.background = 'var(--accent-color)';
                presentBtn.style.transform = 'scale(1)';
                presentBtn.style.boxShadow = '0 4px 8px rgba(76, 175, 80, 0.3)';
                presentBtn.textContent = '‚úì Present';

                statusSpan.textContent = '‚úì Present';
                statusSpan.className = 'attendance-status present-status';
                statusSpan.style.color = 'var(--accent-color)';
                statusSpan.style.fontWeight = 'bold';

                // Add click handler to revert back to absent
                presentBtn.onclick = () => markAttendance(rollNumber, 'absent', presentBtn);
            } else {
                // Mark as absent (revert)
                presentBtn.style.opacity = '1';
                presentBtn.style.background = 'linear-gradient(135deg, var(--accent-color), var(--accent-dark))';
                presentBtn.style.transform = 'scale(1)';
                presentBtn.style.boxShadow = 'var(--shadow-light)';
                presentBtn.textContent = '‚úì Present';

                statusSpan.textContent = '‚úó Absent';
                statusSpan.className = 'attendance-status absent-status';
                statusSpan.style.color = 'var(--error-color)';
                statusSpan.style.fontWeight = 'normal';

                // Reset click handler to mark present
                presentBtn.onclick = () => markAttendance(rollNumber, 'present', presentBtn);
            }
        }

        // Save attendance
        function saveAttendance() {
            const subjectSelect = document.getElementById('subject-select');
            const selectedSubjectId = subjectSelect.value;
            const date = document.getElementById('class-date').value;
            const messageDiv = document.getElementById('attendance-message');

            if (!selectedSubjectId || !date) {
                showMessage(messageDiv, 'Please select subject and date', 'error');
                return;
            }

            if (!selectedLecture) {
                showMessage(messageDiv, 'Please select lecture number', 'error');
                return;
            }

            if (Object.keys(currentAttendance).length === 0) {
                showMessage(messageDiv, 'Please mark attendance for at least one student', 'error');
                return;
            }

            const subjects = getSubjects();
            const selectedSubject = subjects.find(s => s.id == selectedSubjectId);
            const subjectName = selectedSubject ? selectedSubject.name : 'Unknown Subject';

            // Count present and absent students
            const presentCount = Object.values(currentAttendance).filter(status => status === 'present').length;
            const totalCount = Object.keys(currentAttendance).length;
            const absentCount = totalCount - presentCount;

            const attendance = getAttendance();
            const key = `${date}_${selectedSubjectId}_${selectedLecture}`;

            if (attendance[key]) {
                if (!confirm(`Attendance already exists for ${selectedLecture}${getOrdinalSuffix(selectedLecture)} lecture of this subject on this date. Do you want to overwrite it?`)) {
                    return;
                }
            }

            attendance[key] = {
                subjectId: selectedSubjectId,
                subject: subjectName,
                date: date,
                lectureNumber: selectedLecture,
                records: currentAttendance,
                timestamp: new Date().toISOString()
            };

            setAttendance(attendance);
            showMessage(messageDiv, `‚úÖ Attendance saved! ${presentCount} present, ${absentCount} absent out of ${totalCount} students for ${subjectName} - ${selectedLecture}${getOrdinalSuffix(selectedLecture)} lecture on ${date}`, 'success');

            currentAttendance = {};
            loadStudentsForAttendance();
            updateLectureInfo(selectedSubjectId, date, selectedLecture);
        }

        // Show attendance summary for tracking
        function showAttendanceSummary() {
            const subjectSelect = document.getElementById('track-subject');
            const selectedSubjectId = subjectSelect.value;
            const summaryDiv = document.getElementById('attendance-summary');

            if (!selectedSubjectId) {
                summaryDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Please select a subject to view attendance summary.</p>';
                return;
            }

            const attendance = getAttendance();
            const subjectAttendance = Object.values(attendance).filter(record => record.subjectId == selectedSubjectId);

            if (subjectAttendance.length === 0) {
                summaryDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No attendance records found for this subject.</p>';
                return;
            }

            subjectAttendance.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare === 0) {
                    return b.lectureNumber - a.lectureNumber;
                }
                return dateCompare;
            });

            let html = '';
            subjectAttendance.forEach(record => {
                const totalStudents = Object.keys(record.records || record.attendance || {}).length;
                const attendanceRecords = record.records || record.attendance || {};
                const presentStudents = Object.values(attendanceRecords).filter(status => status === 'present').length;
                const absentStudents = totalStudents - presentStudents;
                const percentage = totalStudents > 0 ? ((presentStudents / totalStudents) * 100).toFixed(1) : 0;

                const absentList = [];
                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (status === 'absent') {
                        absentList.push(rollNumber);
                    }
                });

                const lectureInfo = record.lectureNumber ? ` - ${record.lectureNumber}${getOrdinalSuffix(record.lectureNumber)} Lecture` : '';

                html += `
                    <div class="summary-card">
                        <div class="summary-header">
                            <div class="summary-title">${record.subject}${lectureInfo}</div>
                            <div class="summary-percentage">${percentage}%</div>
                        </div>
                        <div class="summary-stats">
                            <div class="stat-item">
                                <div class="stat-value">${presentStudents}</div>
                                <div class="stat-label">Present</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${absentStudents}</div>
                                <div class="stat-label">Absent</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${new Date(record.date).toLocaleDateString()}</div>
                                <div class="stat-label">Date</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        ${absentList.length > 0 ? `
                            <div style="margin-top: 15px; padding: 12px; background: #fff3e0; border-radius: 8px; border-left: 4px solid var(--secondary-color);">
                                <h4 style="color: var(--secondary-dark); margin-bottom: 10px;">üö´ Absent Students (${absentList.length})</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px;">
                                    ${absentList.map(roll => {
                    const student = getStudents().find(s => s.roll === roll);
                    const studentName = student ? student.name.split(' ')[0] : roll;
                    return `<div style="background: var(--secondary-color); color: white; padding: 6px 8px; border-radius: 12px; font-size: 0.8em; text-align: center;">
                                            <div style="font-weight: bold;">${roll}</div>
                                            <div style="font-size: 0.7em; opacity: 0.9;">${studentName}</div>
                                        </div>`;
                }).join('')}
                                </div>
                                <div style="margin-top: 10px; font-size: 0.8em; color: var(--text-secondary);">
                                    üìß Click roll numbers to view student's complete absence history
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            summaryDiv.innerHTML = html;
        }

        // Summary type selection
        function selectSummaryType(type) {
            // Update buttons
            document.querySelectorAll('.summary-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update sections
            document.querySelectorAll('.summary-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${type}-section`).classList.add('active');

            // Clear previous content
            document.getElementById('summary-content').innerHTML = '';
        }

        // Generate student summary
        // Generate Student Wise Summary
        function generateStudentWiseSummary() {
            const summaryDiv = document.getElementById('summary-content');
            const students = getStudents();
            const attendance = getAttendance();
            const subjects = getSubjects();

            if (students.length === 0) {
                summaryDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No students found.</p>';
                return;
            }

            const attendanceByStudent = {};
            students.forEach(student => {
                attendanceByStudent[student.roll] = {
                    name: student.name,
                    roll: student.roll,
                    subjects: {}
                };
            });

            // Process attendance by subject
            Object.values(attendance).forEach(record => {
                const attendanceRecords = record.records || record.attendance || {};
                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (attendanceByStudent[rollNumber]) {
                        const subjectName = record.subject || 'Unknown Subject';
                        if (!attendanceByStudent[rollNumber].subjects[subjectName]) {
                            attendanceByStudent[rollNumber].subjects[subjectName] = {
                                present: 0,
                                absent: 0,
                                absentDates: []
                            };
                        }

                        if (status === 'present') {
                            attendanceByStudent[rollNumber].subjects[subjectName].present++;
                        } else {
                            attendanceByStudent[rollNumber].subjects[subjectName].absent++;
                            const lectureInfo = record.lectureNumber ? ` (L${record.lectureNumber})` : '';
                            attendanceByStudent[rollNumber].subjects[subjectName].absentDates.push(
                                `${new Date(record.date).toLocaleDateString()}${lectureInfo}`
                            );
                        }
                    }
                });
            });

            let html = '<h3 style="margin-bottom: 20px; color: var(--text-primary);">üë• Student Wise Summary</h3>';

            Object.values(attendanceByStudent).forEach(student => {
                if (Object.keys(student.subjects).length === 0) return;

                html += `
                    <div class="enhanced-summary-card">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                            ${student.name} (${student.roll})
                        </h4>
                `;

                Object.entries(student.subjects).forEach(([subjectName, subjectData]) => {
                    const total = subjectData.present + subjectData.absent;
                    const percentage = total > 0 ? ((subjectData.present / total) * 100).toFixed(1) : 0;
                    const isLowAttendance = percentage < 75;

                    html += `
                        <div style="margin-bottom: 15px; padding: 12px; background: ${isLowAttendance ? '#ffeaea' : '#f8f9fa'}; border-radius: 8px; border-left: 4px solid ${isLowAttendance ? 'var(--error-color)' : 'var(--accent-color)'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: var(--text-primary);">${subjectName}</strong>
                                <span style="color: ${isLowAttendance ? 'var(--error-color)' : 'var(--accent-color)'}; font-weight: bold;">${percentage}%</span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px;">
                                <div style="text-align: center; font-size: 0.9em;">
                                    <div style="color: var(--accent-color); font-weight: bold;">${subjectData.present}</div>
                                    <div style="color: var(--text-secondary);">Present</div>
                                </div>
                                <div style="text-align: center; font-size: 0.9em;">
                                    <div style="color: var(--error-color); font-weight: bold;">${subjectData.absent}</div>
                                    <div style="color: var(--text-secondary);">Absent</div>
                                </div>
                                <div style="text-align: center; font-size: 0.9em;">
                                    <div style="color: var(--text-primary); font-weight: bold;">${total}</div>
                                    <div style="color: var(--text-secondary);">Total</div>
                                </div>
                            </div>
                            ${subjectData.absentDates.length > 0 ? `
                                <div style="margin-top: 10px;">
                                    <strong style="color: var(--error-color); font-size: 0.9em;">Absent Dates:</strong>
                                    <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px;">
                                        ${subjectData.absentDates.map(date => `
                                            <span style="background: var(--error-color); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75em;">${date}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : '<div style="color: var(--accent-color); font-size: 0.9em; margin-top: 8px;">‚úÖ Perfect Attendance!</div>'}
                        </div>
                    `;
                });

                html += '</div>';
            });

            summaryDiv.innerHTML = html;
        }

        // Generate Subject Wise Summary
        function generateSubjectWiseSummary() {
            const subjectId = document.getElementById('subject-wise-select').value;
            const summaryDiv = document.getElementById('summary-content');

            if (!subjectId) {
                summaryDiv.innerHTML = '<p style="color: var(--error-color); text-align: center; padding: 20px;">Please select a subject first.</p>';
                return;
            }

            const subjects = getSubjects();
            const selectedSubject = subjects.find(s => s.id == subjectId);
            const subjectName = selectedSubject ? selectedSubject.name : 'Unknown Subject';

            const attendance = getAttendance();
            const subjectAttendance = Object.values(attendance).filter(record => record.subjectId == subjectId);

            if (subjectAttendance.length === 0) {
                summaryDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No attendance records found for this subject.</p>';
                return;
            }

            // Sort by date and lecture
            subjectAttendance.sort((a, b) => {
                const dateCompare = new Date(a.date) - new Date(b.date);
                if (dateCompare === 0) {
                    return (a.lectureNumber || 1) - (b.lectureNumber || 1);
                }
                return dateCompare;
            });

            let html = `<h3 style="margin-bottom: 20px; color: var(--text-primary);">üìö Subject Wise Summary - ${subjectName}</h3>`;

            subjectAttendance.forEach(record => {
                const attendanceRecords = record.records || record.attendance || {};
                const totalStudents = Object.keys(attendanceRecords).length;
                const presentStudents = Object.values(attendanceRecords).filter(status => status === 'present').length;
                const absentStudents = totalStudents - presentStudents;
                const percentage = totalStudents > 0 ? ((presentStudents / totalStudents) * 100).toFixed(1) : 0;

                const absentList = [];
                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (status === 'absent') {
                        const student = getStudents().find(s => s.roll === rollNumber);
                        absentList.push({
                            roll: rollNumber,
                            name: student ? student.name : 'Unknown'
                        });
                    }
                });

                const lectureInfo = record.lectureNumber ? ` - ${record.lectureNumber}${getOrdinalSuffix(record.lectureNumber)} Lecture` : '';

                html += `
                    <div class="enhanced-summary-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: var(--primary-color); margin: 0;">
                                üìÖ ${new Date(record.date).toLocaleDateString()}${lectureInfo}
                            </h4>
                            <span style="background: ${percentage >= 75 ? 'var(--accent-color)' : 'var(--error-color)'}; color: white; padding: 4px 12px; border-radius: 15px; font-weight: bold;">
                                ${percentage}%
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                            <div style="text-align: center; padding: 10px; background: var(--surface-dark); border-radius: 8px;">
                                <div style="color: var(--accent-color); font-size: 1.2em; font-weight: bold;">${presentStudents}</div>
                                <div style="color: var(--text-secondary); font-size: 0.9em;">Present</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--surface-dark); border-radius: 8px;">
                                <div style="color: var(--error-color); font-size: 1.2em; font-weight: bold;">${absentStudents}</div>
                                <div style="color: var(--text-secondary); font-size: 0.9em;">Absent</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--surface-dark); border-radius: 8px;">
                                <div style="color: var(--text-primary); font-size: 1.2em; font-weight: bold;">${totalStudents}</div>
                                <div style="color: var(--text-secondary); font-size: 0.9em;">Total</div>
                            </div>
                        </div>

                        ${absentList.length > 0 ? `
                            <div style="background: #fff3e0; border: 1px solid var(--warning-color); border-radius: 8px; padding: 12px;">
                                <h5 style="color: var(--warning-color); margin-bottom: 10px;">üö´ Absent Students (${absentList.length})</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                                    ${absentList.map(student => `
                                        <div style="background: white; border: 1px solid var(--divider-color); border-radius: 6px; padding: 8px; display: flex; justify-content: space-between;">
                                            <strong style="color: var(--text-primary);">${student.name}</strong>
                                            <span style="color: var(--text-secondary); font-size: 0.9em;">${student.roll}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : `
                            <div style="background: #e8f5e8; border: 1px solid var(--accent-color); border-radius: 8px; padding: 12px; text-align: center;">
                                <span style="color: var(--accent-color); font-weight: bold;">‚úÖ Perfect Attendance - No Absentees!</span>
                            </div>
                        `}
                    </div>
                `;
            });

            summaryDiv.innerHTML = html;
        }

        // Generate Roll Search Summary
        function generateRollSearchSummary() {
            const searchTerm = document.getElementById('roll-search-input').value.trim();
            const summaryDiv = document.getElementById('summary-content');

            if (!searchTerm) {
                summaryDiv.innerHTML = '<p style="color: var(--error-color); text-align: center; padding: 20px;">Please enter a roll number to search.</p>';
                return;
            }

            const students = getStudents();
            const matchingStudents = students.filter(student =>
                student.roll.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (matchingStudents.length === 0) {
                summaryDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No students found matching the search term.</p>';
                return;
            }

            const attendance = getAttendance();
            const subjects = getSubjects();

            let html = `<h3 style="margin-bottom: 20px; color: var(--text-primary);">üîç Roll Search Results for "${searchTerm}"</h3>`;

            matchingStudents.forEach(student => {
                html += `
                    <div class="enhanced-summary-card">
                        <h4 style="color: var(--primary-color); margin-bottom: 20px;">
                            ${student.name} (${student.roll})
                        </h4>
                `;

                const studentSubjects = {};

                // Process attendance for this student
                Object.values(attendance).forEach(record => {
                    const attendanceRecords = record.records || record.attendance || {};
                    if (attendanceRecords[student.roll]) {
                        const subjectName = record.subject || 'Unknown Subject';
                        if (!studentSubjects[subjectName]) {
                            studentSubjects[subjectName] = {
                                present: 0,
                                absent: 0,
                                absentDates: []
                            };
                        }

                        if (attendanceRecords[student.roll] === 'present') {
                            studentSubjects[subjectName].present++;
                        } else {
                            studentSubjects[subjectName].absent++;
                            const lectureInfo = record.lectureNumber ? ` (L${record.lectureNumber})` : '';
                            studentSubjects[subjectName].absentDates.push(
                                `${new Date(record.date).toLocaleDateString()}${lectureInfo}`
                            );
                        }
                    }
                });

                if (Object.keys(studentSubjects).length === 0) {
                    html += '<p style="color: var(--text-secondary);">No attendance records found for this student.</p>';
                } else {
                    Object.entries(studentSubjects).forEach(([subjectName, subjectData]) => {
                        const total = subjectData.present + subjectData.absent;
                        const percentage = total > 0 ? ((subjectData.present / total) * 100).toFixed(1) : 0;

                        html += `
                            <div style="margin-bottom: 15px; padding: 15px; background: var(--surface-dark); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h5 style="color: var(--text-primary); margin: 0;">üìö ${subjectName}</h5>
                                    <span style="background: ${percentage >= 75 ? 'var(--accent-color)' : 'var(--error-color)'}; color: white; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.9em;">
                                        ${percentage}%
                                    </span>
                                </div>

                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 12px;">
                                    <div style="text-align: center; background: white; padding: 8px; border-radius: 6px;">
                                        <div style="color: var(--accent-color); font-weight: bold; font-size: 1.1em;">${subjectData.present}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.8em;">Present</div>
                                    </div>
                                    <div style="text-align: center; background: white; padding: 8px; border-radius: 6px;">
                                        <div style="color: var(--error-color); font-weight: bold; font-size: 1.1em;">${subjectData.absent}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.8em;">Absent</div>
                                    </div>
                                    <div style="text-align: center; background: white; padding: 8px; border-radius: 6px;">
                                        <div style="color: var(--text-primary); font-weight: bold; font-size: 1.1em;">${total}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.8em;">Total</div>
                                    </div>
                                </div>

                                ${subjectData.absentDates.length > 0 ? `
                                    <div style="background: #fff3e0; border-radius: 6px; padding: 10px;">
                                        <strong style="color: var(--warning-color); font-size: 0.9em;">üìÖ Absent Dates (${subjectData.absentDates.length}):</strong>
                                        <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px;">
                                            ${subjectData.absentDates.map(date => `
                                                <span style="background: var(--warning-color); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75em;">${date}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : `
                                    <div style="background: #e8f5e8; border-radius: 6px; padding: 8px; text-align: center;">
                                        <span style="color: var(--accent-color); font-weight: bold; font-size: 0.9em;">‚úÖ Perfect Attendance!</span>
                                    </div>
                                `}
                            </div>
                        `;
                    });
                }

                html += '</div>';
            });

            summaryDiv.innerHTML = html;
        }

        // Export Student Wise Summary to PDF
        function exportStudentWisePDF() {
            const students = getStudents();
            const attendance = getAttendance();

            if (students.length === 0) {
                alert('No students found to export.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Set default font to handle text encoding properly
            doc.setFont("helvetica");

            // Helper function to sanitize text for PDF
            function sanitizeText(text) {
                return String(text).replace(/[^\x00-\x7F]/g, "");
            }            // Professional header
            doc.setFillColor(26, 35, 126); // Deep blue
            doc.rect(0, 0, 210, 45, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('STUDENT WISE ATTENDANCE REPORT', 105, 25, { align: 'center' });

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Generated: ${new Date().toLocaleDateString()} | All Subjects Overview`, 105, 35, { align: 'center' });

            // Reset colors
            doc.setTextColor(0, 0, 0);
            let yPos = 55;

            // Process each student
            const attendanceByStudent = {};
            students.forEach(student => {
                attendanceByStudent[student.roll] = {
                    name: student.name,
                    roll: student.roll,
                    subjects: {}
                };
            });

            Object.values(attendance).forEach(record => {
                const attendanceRecords = record.records || record.attendance || {};
                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (attendanceByStudent[rollNumber]) {
                        const subjectName = record.subject || 'Unknown Subject';
                        if (!attendanceByStudent[rollNumber].subjects[subjectName]) {
                            attendanceByStudent[rollNumber].subjects[subjectName] = {
                                present: 0, absent: 0, absentDates: []
                            };
                        }

                        if (status === 'present') {
                            attendanceByStudent[rollNumber].subjects[subjectName].present++;
                        } else {
                            attendanceByStudent[rollNumber].subjects[subjectName].absent++;
                            const lectureInfo = record.lectureNumber ? ` (L${record.lectureNumber})` : '';
                            attendanceByStudent[rollNumber].subjects[subjectName].absentDates.push(
                                `${new Date(record.date).toLocaleDateString()}${lectureInfo}`
                            );
                        }
                    }
                });
            });

            Object.values(attendanceByStudent).forEach(student => {
                if (Object.keys(student.subjects).length === 0) return;

                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }

                // Student header with background
                doc.setFillColor(240, 248, 255);
                doc.rect(15, yPos, 180, 15, 'F');
                doc.setDrawColor(33, 150, 243);
                doc.rect(15, yPos, 180, 15, 'S');

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(33, 150, 243);
                doc.text(`${sanitizeText(student.name)} (${sanitizeText(student.roll)})`, 20, yPos + 10);

                yPos += 20;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');

                Object.entries(student.subjects).forEach(([subjectName, subjectData]) => {
                    const total = subjectData.present + subjectData.absent;
                    const percentage = total > 0 ? ((subjectData.present / total) * 100).toFixed(1) : 0;

                    // Subject header
                    doc.setFont(undefined, 'bold');
                    doc.text(`Subject: ${sanitizeText(subjectName)}`, 20, yPos);
                    doc.text(`${percentage}%`, 170, yPos);
                    yPos += 8;

                    // Stats
                    doc.setFont(undefined, 'normal');
                    doc.text(`Present: ${subjectData.present} | Absent: ${subjectData.absent} | Total: ${total}`, 25, yPos);
                    yPos += 6;

                    // Absent dates
                    if (subjectData.absentDates.length > 0) {
                        doc.setFontSize(8);
                        doc.text('Absent Dates:', 25, yPos);
                        yPos += 4;

                        let datesText = subjectData.absentDates.join(', ');
                        const lines = doc.splitTextToSize(datesText, 160);
                        lines.forEach(line => {
                            doc.text(line, 35, yPos);
                            yPos += 4;
                        });
                    }

                    doc.setFontSize(10);
                    yPos += 4;
                });

                yPos += 10;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Page ${i} of ${pageCount} | Student Wise Report | Generated by Attendance Tracker`, 105, 290, { align: 'center' });
            }

            doc.save('Student_Wise_Attendance_Report.pdf');
        }

        // Export Subject Wise Summary to PDF
        function exportSubjectWisePDF() {
            const subjectId = document.getElementById('subject-wise-select').value;

            if (!subjectId) {
                alert('Please select a subject first.');
                return;
            }

            const subjects = getSubjects();
            const selectedSubject = subjects.find(s => s.id == subjectId);
            const subjectName = selectedSubject ? selectedSubject.name : 'Unknown Subject';

            const attendance = getAttendance();
            const subjectAttendance = Object.values(attendance).filter(record => record.subjectId == subjectId);

            if (subjectAttendance.length === 0) {
                alert('No attendance records found for this subject.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Set default font to handle text encoding properly
            doc.setFont("helvetica");

            // Helper function to sanitize text for PDF
            function sanitizeText(text) {
                return String(text).replace(/[^\x00-\x7F]/g, "");
            }

            // Professional header
            doc.setFillColor(76, 175, 80); // Green
            doc.rect(0, 0, 210, 45, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('SUBJECT WISE ATTENDANCE REPORT', 105, 25, { align: 'center' });

            doc.setFontSize(14);
            doc.setFont(undefined, 'normal');
            doc.text(`Subject: ${sanitizeText(subjectName)}`, 105, 35, { align: 'center' });

            doc.setTextColor(0, 0, 0);
            let yPos = 55;

            // Sort attendance records
            subjectAttendance.sort((a, b) => {
                const dateCompare = new Date(a.date) - new Date(b.date);
                if (dateCompare === 0) {
                    return (a.lectureNumber || 1) - (b.lectureNumber || 1);
                }
                return dateCompare;
            });

            subjectAttendance.forEach(record => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }

                const attendanceRecords = record.records || record.attendance || {};
                const totalStudents = Object.keys(attendanceRecords).length;
                const presentStudents = Object.values(attendanceRecords).filter(status => status === 'present').length;
                const absentStudents = totalStudents - presentStudents;
                const percentage = totalStudents > 0 ? ((presentStudents / totalStudents) * 100).toFixed(1) : 0;

                // Class header
                doc.setFillColor(245, 245, 245);
                doc.rect(15, yPos, 180, 20, 'F');
                doc.setDrawColor(200, 200, 200);
                doc.rect(15, yPos, 180, 20, 'S');

                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                const lectureInfo = record.lectureNumber ? ` - ${record.lectureNumber}${getOrdinalSuffix(record.lectureNumber)} Lecture` : '';
                doc.text(`Date: ${new Date(record.date).toLocaleDateString()}${lectureInfo}`, 20, yPos + 8);
                doc.text(`${percentage}% Attendance`, 160, yPos + 8);

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Present: ${presentStudents} | Absent: ${absentStudents} | Total: ${totalStudents}`, 20, yPos + 15);

                yPos += 25;

                // Absent students list
                const absentList = [];
                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (status === 'absent') {
                        const student = getStudents().find(s => s.roll === rollNumber);
                        absentList.push(`${student ? student.name : 'Unknown'} (${rollNumber})`);
                    }
                });

                if (absentList.length > 0) {
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Absent Students (${absentList.length}):`, 20, yPos);
                    yPos += 6;

                    doc.setFont(undefined, 'normal');
                    absentList.forEach(student => {
                        if (yPos > 280) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(`‚Ä¢ ${student}`, 25, yPos);
                        yPos += 5;
                    });
                } else {
                    doc.setFontSize(10);
                    doc.setTextColor(76, 175, 80);
                    doc.text('‚úÖ Perfect Attendance - No Absentees!', 20, yPos);
                    doc.setTextColor(0, 0, 0);
                    yPos += 8;
                }

                yPos += 15;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Page ${i} of ${pageCount} | ${sanitizeText(subjectName)} Report | Generated by Attendance Tracker`, 105, 290, { align: 'center' });
            }

            doc.save(`${sanitizeText(subjectName)}_Subject_Wise_Report.pdf`);
        }

        // Export Roll Search Summary to PDF
        function exportRollSearchPDF() {
            const searchTerm = document.getElementById('roll-search-input').value.trim();

            if (!searchTerm) {
                alert('Please enter a roll number to search.');
                return;
            }

            const students = getStudents();
            const matchingStudents = students.filter(student =>
                student.roll.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (matchingStudents.length === 0) {
                alert('No students found matching the search term.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Set default font to handle text encoding properly
            doc.setFont("helvetica");

            // Helper function to sanitize text for PDF
            function sanitizeText(text) {
                return String(text).replace(/[^\x00-\x7F]/g, "");
            }

            // Professional header
            doc.setFillColor(156, 39, 176); // Purple
            doc.rect(0, 0, 210, 45, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('ROLL NUMBER SEARCH REPORT', 105, 25, { align: 'center' });

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Search Term: "${sanitizeText(searchTerm)}" | Found: ${matchingStudents.length} student(s)`, 105, 35, { align: 'center' });

            doc.setTextColor(0, 0, 0);
            let yPos = 55;

            const attendance = getAttendance();

            matchingStudents.forEach(student => {
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }

                // Student header
                doc.setFillColor(240, 240, 255);
                doc.rect(15, yPos, 180, 15, 'F');
                doc.setDrawColor(156, 39, 176);
                doc.rect(15, yPos, 180, 15, 'S');

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(156, 39, 176);
                doc.text(`${sanitizeText(student.name)} (${sanitizeText(student.roll)})`, 20, yPos + 10);

                yPos += 20;
                doc.setTextColor(0, 0, 0);

                // Process subjects for this student
                const studentSubjects = {};
                Object.values(attendance).forEach(record => {
                    const attendanceRecords = record.records || record.attendance || {};
                    if (attendanceRecords[student.roll]) {
                        const subjectName = record.subject || 'Unknown Subject';
                        if (!studentSubjects[subjectName]) {
                            studentSubjects[subjectName] = {
                                present: 0, absent: 0, absentDates: []
                            };
                        }

                        if (attendanceRecords[student.roll] === 'present') {
                            studentSubjects[subjectName].present++;
                        } else {
                            studentSubjects[subjectName].absent++;
                            const lectureInfo = record.lectureNumber ? ` (L${record.lectureNumber})` : '';
                            studentSubjects[subjectName].absentDates.push(
                                `${new Date(record.date).toLocaleDateString()}${lectureInfo}`
                            );
                        }
                    }
                });

                if (Object.keys(studentSubjects).length === 0) {
                    doc.setFontSize(12);
                    doc.text('No attendance records found for this student.', 20, yPos);
                    yPos += 20;
                } else {
                    Object.entries(studentSubjects).forEach(([subjectName, subjectData]) => {
                        const total = subjectData.present + subjectData.absent;
                        const percentage = total > 0 ? ((subjectData.present / total) * 100).toFixed(1) : 0;

                        // Subject info
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text(`Subject: ${sanitizeText(subjectName)}`, 20, yPos);
                        doc.text(`${percentage}%`, 170, yPos);
                        yPos += 8;

                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        doc.text(`Present: ${subjectData.present} | Absent: ${subjectData.absent} | Total: ${total}`, 25, yPos);
                        yPos += 6;

                        // Absent dates
                        if (subjectData.absentDates.length > 0) {
                            doc.setFontSize(9);
                            doc.text(`Absent Dates (${subjectData.absentDates.length}):`, 25, yPos);
                            yPos += 4;

                            subjectData.absentDates.forEach(date => {
                                if (yPos > 280) {
                                    doc.addPage();
                                    yPos = 20;
                                }
                                doc.text(`‚Ä¢ ${date}`, 30, yPos);
                                yPos += 4;
                            });
                        } else {
                            doc.setFontSize(9);
                            doc.setTextColor(76, 175, 80);
                            doc.text('‚úÖ Perfect Attendance!', 25, yPos);
                            doc.setTextColor(0, 0, 0);
                            yPos += 6;
                        }

                        yPos += 8;
                    });
                }

                yPos += 10;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Page ${i} of ${pageCount} | Roll Search: "${sanitizeText(searchTerm)}" | Generated by Attendance Tracker`, 105, 290, { align: 'center' });
            }

            doc.save(`Roll_Search_${sanitizeText(searchTerm)}_Report.pdf`);
        }

        // Add new student
        function addStudent() {
            const name = document.getElementById('student-name').value.trim();
            const roll = document.getElementById('student-roll').value.trim();
            const messageDiv = document.getElementById('manage-message');

            if (!name || !roll) {
                showMessage(messageDiv, 'Please enter both name and roll number', 'error');
                return;
            }

            const students = getStudents();

            if (students.some(student => student.roll === roll)) {
                showMessage(messageDiv, 'Roll number already exists', 'error');
                return;
            }

            const newStudent = {
                id: Date.now(),
                roll: roll,
                name: name
            };

            students.push(newStudent);
            setStudents(students);

            document.getElementById('student-name').value = '';
            document.getElementById('student-roll').value = '';

            showMessage(messageDiv, `Student ${name} added successfully`, 'success');
            loadCurrentStudents();
        }

        // Bulk import students
        function bulkImportStudents() {
            const bulkText = document.getElementById('bulk-import-text').value.trim();
            const messageDiv = document.getElementById('manage-message');

            if (!bulkText) {
                showMessage(messageDiv, 'Please paste student data', 'error');
                return;
            }

            const lines = bulkText.split('\n').filter(line => line.trim());
            const students = getStudents();
            const newStudents = [];
            const errors = [];
            const duplicates = [];

            lines.forEach((line, index) => {
                const lineNum = index + 1;

                // Handle both comma and tab separated values
                let parts;
                if (line.includes('\t')) {
                    parts = line.split('\t').map(part => part.trim());
                } else if (line.includes(',')) {
                    parts = line.split(',').map(part => part.trim());
                } else {
                    errors.push(`Line ${lineNum}: Invalid format (missing comma or tab)`);
                    return;
                }

                if (parts.length < 2) {
                    errors.push(`Line ${lineNum}: Missing roll number or name`);
                    return;
                }

                const roll = parts[0].trim();
                const name = parts[1].trim();

                if (!roll || !name) {
                    errors.push(`Line ${lineNum}: Empty roll number or name`);
                    return;
                }

                // Check for duplicates in existing students
                if (students.some(student => student.roll === roll)) {
                    duplicates.push(`${roll} (${name})`);
                    return;
                }

                // Check for duplicates in current import
                if (newStudents.some(student => student.roll === roll)) {
                    errors.push(`Line ${lineNum}: Duplicate roll number ${roll} in import data`);
                    return;
                }

                newStudents.push({
                    id: Date.now() + index,
                    roll: roll,
                    name: name
                });
            });

            // Show results
            let message = '';
            if (newStudents.length > 0) {
                students.push(...newStudents);
                setStudents(students);
                message += `Successfully imported ${newStudents.length} students. `;
                loadCurrentStudents();
            }

            if (duplicates.length > 0) {
                message += `${duplicates.length} duplicates skipped: ${duplicates.slice(0, 3).join(', ')}${duplicates.length > 3 ? '...' : ''}. `;
            }

            if (errors.length > 0) {
                message += `${errors.length} errors: ${errors.slice(0, 2).join('; ')}${errors.length > 2 ? '...' : ''}. `;
            }

            const messageType = newStudents.length > 0 ? 'success' : (errors.length > 0 ? 'error' : 'error');
            showMessage(messageDiv, message || 'No valid data found', messageType);

            if (newStudents.length > 0) {
                document.getElementById('bulk-import-text').value = '';
            }
        }

        // Add new subject
        function addSubject() {
            const subjectName = document.getElementById('subject-name').value.trim();
            const messageDiv = document.getElementById('manage-message');

            if (!subjectName) {
                showMessage(messageDiv, 'Please enter subject name', 'error');
                return;
            }

            const subjects = getSubjects();

            if (subjects.some(subject => subject.name === subjectName)) {
                showMessage(messageDiv, 'Subject already exists', 'error');
                return;
            }

            const newSubject = {
                id: Date.now(),
                name: subjectName
            };

            subjects.push(newSubject);
            setSubjects(subjects);

            document.getElementById('subject-name').value = '';

            showMessage(messageDiv, `Subject ${subjectName} added successfully`, 'success');
            loadCurrentSubjects();
        }

        // Load current students for management
        function loadCurrentStudents() {
            const students = getStudents();
            const container = document.getElementById('current-students');

            if (students.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No students added yet.</p>';
                return;
            }

            let html = '<h4 style="margin-bottom: 15px; color: var(--text-primary);">Current Students</h4>';
            students.forEach((student, index) => {
                html += `
                    <div class="student-item">
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-roll">Roll: ${student.roll}</div>
                        </div>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8em;" onclick="removeStudent(${index})">
                            üóëÔ∏è Remove
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Load current subjects for management
        function loadCurrentSubjects() {
            const subjects = getSubjects();
            const container = document.getElementById('current-subjects');

            if (subjects.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No subjects added yet.</p>';
                return;
            }

            let html = '<h4 style="margin-bottom: 15px; color: var(--text-primary);">Current Subjects</h4>';
            subjects.forEach((subject, index) => {
                html += `
                    <div class="student-item">
                        <div class="student-info">
                            <div class="student-name">${subject.name}</div>
                        </div>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8em;" onclick="removeSubject(${index})">
                            üóëÔ∏è Remove
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Remove student
        function removeStudent(index) {
            if (confirm('Are you sure you want to remove this student?')) {
                const students = getStudents();
                students.splice(index, 1);
                setStudents(students);
                loadCurrentStudents();
                showMessage(document.getElementById('manage-message'), 'Student removed successfully', 'success');
            }
        }

        // Remove subject
        function removeSubject(index) {
            if (confirm('Are you sure you want to remove this subject? This will also remove all attendance records for this subject.')) {
                const subjects = getSubjects();
                const subjectToRemove = subjects[index];
                subjects.splice(index, 1);
                setSubjects(subjects);

                const attendance = getAttendance();
                Object.keys(attendance).forEach(key => {
                    if (attendance[key].subjectId == subjectToRemove.id) {
                        delete attendance[key];
                    }
                });
                setAttendance(attendance);

                loadCurrentSubjects();
                showMessage(document.getElementById('manage-message'), 'Subject and related attendance records removed successfully', 'success');
            }
        }

        // Export data as JSON
        function exportData() {
            const data = {
                students: getStudents(),
                subjects: getSubjects(),
                attendance: getAttendance(),
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Import data from JSON
        function importData() {
            document.getElementById('import-file').click();
        }

        // Handle file import
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (confirm('This will replace all current data. Are you sure?')) {
                        if (data.students) setStudents(data.students);
                        if (data.subjects) setSubjects(data.subjects);
                        if (data.attendance) setAttendance(data.attendance);

                        showMessage(document.getElementById('manage-message'), 'Data imported successfully!', 'success');
                        loadCurrentStudents();
                        loadCurrentSubjects();
                    }
                } catch (error) {
                    showMessage(document.getElementById('manage-message'), 'Invalid file format', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Clear functions
        function clearAllAttendance() {
            if (confirm('Are you sure you want to clear all attendance records? This cannot be undone.')) {
                setAttendance({});
                showMessage(document.getElementById('manage-message'), 'All attendance records cleared', 'success');
            }
        }

        function clearAllStudents() {
            if (confirm('Are you sure you want to clear all students? This will also clear all attendance records.')) {
                setStudents([]);
                setAttendance({});
                showMessage(document.getElementById('manage-message'), 'All students and attendance records cleared', 'success');
                loadCurrentStudents();
            }
        }

        function clearAllSubjects() {
            if (confirm('Are you sure you want to clear all subjects? This will also clear all attendance records.')) {
                setSubjects([]);
                setAttendance({});
                showMessage(document.getElementById('manage-message'), 'All subjects and attendance records cleared', 'success');
                loadCurrentSubjects();
            }
        }

        // Event listeners and initialization
        document.addEventListener('DOMContentLoaded', function () {
            // Subject selection for attendance
            document.getElementById('subject-select').addEventListener('change', function () {
                loadStudentsForAttendance();
                if (selectedLecture) {
                    const subjectId = this.value;
                    const date = document.getElementById('class-date').value;
                    if (subjectId && date) {
                        updateLectureInfo(subjectId, date, selectedLecture);
                    }
                }
            });

            // Date change for attendance
            document.getElementById('class-date').addEventListener('change', function () {
                if (selectedLecture) {
                    const subjectId = document.getElementById('subject-select').value;
                    const date = this.value;
                    if (subjectId && date) {
                        updateLectureInfo(subjectId, date, selectedLecture);
                    }
                }
            });

            // Subject selection for tracking
            document.getElementById('track-subject').addEventListener('change', showAttendanceSummary);

            // Enter key handlers for forms
            document.getElementById('student-name').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') addStudent();
            });

            document.getElementById('student-roll').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') addStudent();
            });

            document.getElementById('subject-name').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') addSubject();
            });

            // Initialize the app
            switchTab('attendance');
        });
    </script>
</body>

</html>