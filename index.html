<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance App</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            background: #f5f5f5;
            color: #222;
        }

        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background: #fff;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
            z-index: 100;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 16px;
            cursor: pointer;
            border-top: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .tab.active {
            border-top: 2px solid #1976d2;
            color: #1976d2;
            font-weight: 500;
        }

        .container {
            padding: 16px;
            padding-bottom: 64px;
            max-width: 480px;
            margin: 0 auto;
        }

        .attendance-btns {
            display: flex;
            justify-content: space-between;
            margin-top: 32px;
        }

        .btn {
            flex: 1;
            margin: 0 8px;
            padding: 32px 0;
            font-size: 24px;
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn.present {
            background: #43a047;
        }

        .btn.absent {
            background: #e53935;
        }

        .lecture-btn.selected {
            background: #2196f3 !important;
            color: white !important;
        }

        .track-lecture-btn.selected {
            background: #2196f3 !important;
            color: white !important;
        }

        .btn:active {
            opacity: 0.8;
        }

        .input,
        select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        .list {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            margin: 16px 0;
            padding: 8px;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 14px;
            cursor: pointer;
        }

        .action-btn.delete {
            background: #e53935;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
        }

        .summary-table th,
        .summary-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        .summary-table th {
            background: #f0f0f0;
        }

        .summary-table tr:last-child td {
            border-bottom: none;
        }

        .top-bar {
            background: #1976d2;
            color: #fff;
            padding: 16px;
            text-align: center;
            font-size: 20px;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .auth-section {
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 14px;
        }

        .sync-status.online {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .sync-status.offline {
            background: #ffeaa7;
            color: #d68910;
        }

        .sync-status.error {
            background: #ffebee;
            color: #c62828;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .container {
                padding: 8px;
            }

            .btn {
                font-size: 20px;
                padding: 24px 0;
            }

            .top-bar {
                font-size: 18px;
                padding: 12px;
            }
        }
    </style>
</head>

<body>
    <div class="top-bar">
        Attendance App
        <div class="sync-status offline" id="sync-status">
            <span>‚óè</span> Offline Mode
        </div>
    </div>
    <div class="container">
        <!-- Take Attendance Tab -->
        <div id="tab-attendance" class="tab-content">
            <div style="margin-bottom: 20px;">
                <select id="attendance-subject" class="input">
                    <option value="">Select Subject</option>
                </select>
                <input type="date" id="attendance-date" class="input">
            </div>

            <!-- Lecture Selection -->
            <div style="margin-bottom: 20px;">
                <div style="font-size: 16px; font-weight: 500; margin-bottom: 10px; color: #333;">Select Lecture:</div>
                <div class="lecture-selection" style="display: flex; gap: 8px;">
                    <button class="btn lecture-btn" id="lecture-1" data-lecture="1"
                        style="flex: 1; background: #e0e0e0; color: #333;">
                        1st Lecture
                    </button>
                    <button class="btn lecture-btn" id="lecture-2" data-lecture="2"
                        style="flex: 1; background: #e0e0e0; color: #333;">
                        2nd Lecture
                    </button>
                    <button class="btn lecture-btn" id="lecture-3" data-lecture="3"
                        style="flex: 1; background: #e0e0e0; color: #333;">
                        3rd Lecture
                    </button>
                </div>
                <div id="lecture-info" style="margin-top: 10px; font-size: 14px; color: #666; text-align: center;">
                    Select lecture number first
                </div>
            </div>

            <div id="attendance-student-card"
                style="text-align: center; background: #fff; padding: 24px; border-radius: 12px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                >
                <div id="student-info" style="margin-bottom: 20px;">
                    <div style="font-size: 24px; font-weight: 500;" id="student-roll">Roll: -</div>
                    <div style="font-size: 20px; color: #666;" id="student-name">Name: -</div>
                </div>
                <div class="attendance-btns">
                    <button class="btn" id="start-attendance"
                        style="background: #2196f3; margin-bottom: 16px; display: block; width: 100%;">
                        üöÄ Start Attendance
                    </button>
                    <button class="btn present" id="mark-present" style="display: none;">Present</button>
                    <button class="btn absent" id="mark-absent" style="display: none;">Absent</button>
                </div>
                <div style="margin-top: 20px;">
                    <button class="action-btn" id="finish-attendance"
                        style="display: none; background: #43a047; font-size: 16px; padding: 12px 24px;">
                        ‚úì Done - Sync Data
                    </button>
                </div>
            </div>
            <div style="text-align: center; color: #666;">
                <div id="attendance-progress">Select subject and date to start</div>
            </div>
        </div>

        <!-- Track/Edit Attendance Tab -->
        <div id="tab-track" class="tab-content hidden">
            <div style="margin-bottom: 20px;">
                <select id="track-subject" class="input">
                    <option value="">Select Subject</option>
                </select>
                <input type="date" id="track-date" class="input">

                <!-- Lecture Selection for Track Tab -->
                <div style="margin-top: 10px;">
                    <div style="font-size: 14px; margin-bottom: 8px; color: #333;">Lecture:</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn track-lecture-btn" id="track-lecture-1" data-lecture="1"
                            style="flex: 1; background: #e0e0e0; color: #333; font-size: 14px; padding: 8px;">
                            1st
                        </button>
                        <button class="btn track-lecture-btn" id="track-lecture-2" data-lecture="2"
                            style="flex: 1; background: #e0e0e0; color: #333; font-size: 14px; padding: 8px;">
                            2nd
                        </button>
                        <button class="btn track-lecture-btn" id="track-lecture-3" data-lecture="3"
                            style="flex: 1; background: #e0e0e0; color: #333; font-size: 14px; padding: 8px;">
                            3rd
                        </button>
                    </div>
                </div>

                <button class="action-btn" id="load-attendance" style="margin-top: 10px;">Load Attendance</button>
            </div>
            <div id="track-list"></div>
        </div>

        <!-- Summary Tab -->
        <div id="tab-summary" class="tab-content hidden">
            <div style="margin-bottom: 20px;">
                <select id="summary-type" class="input">
                    <option value="student">Student-wise Summary</option>
                    <option value="subject">Subject-wise Summary</option>
                </select>
                <select id="summary-subject" class="input">
                    <option value="">All Subjects</option>
                </select>
                <div style="display: flex; gap: 8px; margin: 8px 0;">
                    <input type="date" id="summary-date-from" class="input" placeholder="From Date (Optional)"
                        style="flex: 1;">
                    <input type="date" id="summary-date-to" class="input" placeholder="To Date (Optional)"
                        style="flex: 1;">
                </div>
                <button class="action-btn" id="generate-summary">Generate Summary</button>
                <button class="action-btn" id="download-pdf" style="background: #e91e63;">Download PDF</button>
            </div>
            <div id="summary-content"></div>
        </div>

        <!-- Manage Tab -->
        <div id="tab-manage" class="tab-content hidden">
            <!-- Device Sync -->
            <div class="auth-section">
                <h3>Device Sync</h3>
                <div id="sync-section">
                    <div style="margin-bottom: 16px;">
                        <input type="text" id="sync-code" placeholder="Enter your sync code" class="input">
                        <button class="action-btn" id="connect-sync">Connect</button>
                    </div>
                    <div id="sync-info" class="hidden">
                        <p>Sync Code: <strong id="current-sync-code"></strong></p>
                        <button class="action-btn" id="disconnect-sync">Disconnect</button>
                        <button class="action-btn" id="manual-sync">Sync Now</button>
                    </div>
                    <button class="action-btn" id="generate-code" style="background: #e91e63;">Generate New
                        Code</button>
                </div>
                <p style="font-size:12px;color:#666;">
                    <strong>Recommended:</strong> Use "Backup Data" and "Import Data" below for reliable cross-device
                    sync.
                    Sync codes work but may have limitations due to free services.
                </p>
            </div>

            <!-- Data Management -->
            <div style="margin-bottom:16px; border-bottom: 1px solid #eee; padding-bottom: 16px;">
                <h3>Local Data Management</h3>
                <button class="action-btn" id="backup-btn">Backup Data</button>
                <input type="file" id="import-file" accept="application/json" style="display:none">
                <button class="action-btn" id="import-btn">Import Data</button>
                <button class="action-btn delete" id="delete-all-btn">Delete All Records</button>
            </div>
            <div id="manage-message" style="color:#e53935;font-weight:500;margin-bottom:16px;"></div>

            <!-- Students Management -->
            <div style="margin-bottom: 24px;">
                <h3>Students</h3>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <input type="text" id="new-student-roll" placeholder="Roll Number" class="input" style="flex: 1;">
                    <input type="text" id="new-student-name" placeholder="Student Name" class="input" style="flex: 2;">
                    <button class="action-btn" id="add-student">Add</button>
                </div>
                <div id="students-list" class="list"></div>
            </div>

            <!-- Subjects Management -->
            <div>
                <h3>Subjects</h3>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <input type="text" id="subject-name" placeholder="Subject Name" class="input" style="flex: 1;">
                    <button class="action-btn" id="add-subject">Add</button>
                </div>
                <div id="subjects-list" class="list"></div>
            </div>
        </div>
    </div>
    <div class="tab-bar">
        <div class="tab active" data-tab="attendance">Take Attendance</div>
        <div class="tab" data-tab="track">Track/Edit</div>
        <div class="tab" data-tab="summary">Summary</div>
        <div class="tab" data-tab="manage">Manage</div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Free Cloud Sync using a simple, reliable solution
        let syncCode = localStorage.getItem('syncCode') || null;
        let isConnected = !!syncCode;

        // Update sync status indicator
        function updateSyncStatus(status = 'offline', message = 'Offline Mode') {
            const syncStatus = document.getElementById('sync-status');
            if (!syncStatus) return;

            syncStatus.className = `sync-status ${status}`;

            const statusMessages = {
                'online': '‚óè Cloud Synced',
                'offline': '‚óè Offline Mode',
                'syncing': '‚óè Syncing...',
                'error': '‚óè Sync Error'
            };

            syncStatus.innerHTML = `<span>‚óè</span> ${statusMessages[status] || message}`;
        }

        // Generate a simple sync code using current timestamp
        function generateSyncCode() {
            try {
                updateSyncStatus('syncing', 'Creating sync code...');

                // Generate a simple unique code
                const timestamp = Date.now();
                const randomNum = Math.floor(Math.random() * 10000);
                syncCode = `att_${timestamp}_${randomNum}`;

                localStorage.setItem('syncCode', syncCode);
                isConnected = true;
                updateSyncUI();

                // Try to save initial data to cloud
                syncToCloud().then(() => {
                    updateSyncStatus('online');
                    showMessage('Sync code generated successfully! Share this code with other devices.', 'success');
                }).catch(() => {
                    // Even if cloud fails, we have a local sync code
                    updateSyncStatus('offline');
                    showMessage('Sync code generated! Note: Cloud sync may be limited. Use backup/import for reliable sync.', 'warning');
                });

            } catch (error) {
                console.error('Error generating sync code:', error);
                updateSyncStatus('error');
                showMessage('Failed to generate sync code. Try again.', 'error');
            }
        }

        // Connect to existing sync code
        function connectToSync() {
            const inputCode = document.getElementById('sync-code').value.trim();
            if (!inputCode) {
                showMessage('Please enter a sync code', 'error');
                return;
            }

            try {
                updateSyncStatus('syncing', 'Connecting...');

                syncCode = inputCode;
                localStorage.setItem('syncCode', syncCode);
                isConnected = true;
                updateSyncUI();

                // Try to load data from cloud
                loadFromCloud().then(() => {
                    updateSyncStatus('online');
                    showMessage('Connected! Data synced successfully.', 'success');
                }).catch(() => {
                    updateSyncStatus('offline');
                    showMessage('Connected with sync code. Cloud sync may be limited. Use backup/import for reliable sync.', 'warning');
                });

                // Refresh current tab
                const activeTab = document.querySelector('.tab.active')?.dataset.tab;
                if (activeTab === 'manage') loadManageTab();

            } catch (error) {
                console.error('Error connecting to sync:', error);
                updateSyncStatus('error');
                showMessage('Failed to connect. Check your sync code.', 'error');
            }
        }

        // Sync data to cloud (with fallback)
        async function syncToCloud() {
            if (!isConnected || !syncCode) return Promise.reject('Not connected');

            try {
                updateSyncStatus('syncing');

                const data = getAllAppData();

                // Try multiple free services for backup
                const services = [
                    // Service 1: JSONBin.io
                    () => fetch('https://api.jsonbin.io/v3/b', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ syncCode, data, timestamp: Date.now() })
                    }),
                    // Service 2: HTTPBin (for testing)
                    () => fetch('https://httpbin.org/post', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ syncCode, data, timestamp: Date.now() })
                    })
                ];

                // Try first service
                try {
                    const response = await services[0]();
                    if (response.ok) {
                        updateSyncStatus('online');
                        return Promise.resolve();
                    }
                } catch (e) {
                    console.log('Primary sync service failed, using local storage only');
                }

                // If cloud fails, still mark as "synced" locally
                updateSyncStatus('offline');
                return Promise.reject('Cloud sync unavailable');

            } catch (error) {
                console.error('Error syncing to cloud:', error);
                updateSyncStatus('error');
                return Promise.reject(error);
            }
        }

        // Load data from cloud (with fallback)
        async function loadFromCloud() {
            if (!isConnected || !syncCode) return Promise.reject('Not connected');

            try {
                updateSyncStatus('syncing');

                // For now, we'll rely on manual backup/import for cross-device sync
                // This ensures the app works reliably without depending on external services

                updateSyncStatus('offline');
                return Promise.reject('Using local storage only');

            } catch (error) {
                console.error('Error loading from cloud:', error);
                updateSyncStatus('error');
                return Promise.reject(error);
            }
        }

        // Disconnect from sync
        function disconnectSync() {
            if (confirm('Disconnect from sync? Local data will remain.')) {
                syncCode = null;
                localStorage.removeItem('syncCode');
                isConnected = false;
                updateSyncUI();
                updateSyncStatus('offline');
                showMessage('Disconnected from sync', 'success');
            }
        }        // Update sync UI
        function updateSyncUI() {
            const syncInfo = document.getElementById('sync-info');
            const currentSyncCode = document.getElementById('current-sync-code');

            if (isConnected && syncCode) {
                syncInfo.classList.remove('hidden');
                currentSyncCode.textContent = syncCode;
                document.getElementById('sync-code').value = '';
            } else {
                syncInfo.classList.add('hidden');
            }
        }

        // Show message to user
        function showMessage(message, type = 'error') {
            const manageMsg = document.getElementById('manage-message');
            if (!manageMsg) return;

            manageMsg.textContent = message;
            if (type === 'success') {
                manageMsg.style.color = '#43a047';
            } else if (type === 'warning') {
                manageMsg.style.color = '#f57c00';
            } else {
                manageMsg.style.color = '#e53935';
            }
            setTimeout(() => manageMsg.textContent = '', 6000);
        }

        // Auto-sync when data changes (removed - now manual only)
        function autoSync() {
            // No auto-sync - manual sync only via "Done" button
        }        // Data storage utilities (modified for manual sync)
        function getStudents() {
            return JSON.parse(localStorage.getItem('students') || '[]');
        }

        function setStudents(students) {
            localStorage.setItem('students', JSON.stringify(students));
            // No auto-sync for students/subjects management
        }

        function getSubjects() {
            return JSON.parse(localStorage.getItem('subjects') || '[]');
        }

        function setSubjects(subjects) {
            localStorage.setItem('subjects', JSON.stringify(subjects));
            // No auto-sync for students/subjects management
        }

        function getAttendance() {
            return JSON.parse(localStorage.getItem('attendance') || '{}');
        }

        function setAttendance(attendance) {
            localStorage.setItem('attendance', JSON.stringify(attendance));
            // No auto-sync for attendance - manual sync only
        }

        // Helper function to get attendance as array for existing functions
        function getAttendanceArray() {
            const attendanceObj = getAttendance();
            return Object.values(attendanceObj);
        }

        // Manual sync function for "Done" button
        function finishAndSync() {
            // Always complete the attendance session first
            resetAttendanceSession();

            // Try to sync only if connected, but don't show errors for failed sync
            if (isConnected) {
                updateSyncStatus('syncing', 'Syncing attendance...');
                syncToCloud().then(() => {
                    updateSyncStatus('online', 'Data saved locally and synced');
                }).catch(() => {
                    updateSyncStatus('offline', 'Data saved locally (sync unavailable)');
                });
            } else {
                updateSyncStatus('offline', 'Data saved locally');
            }
        }

        function resetAttendanceSession() {
            currentAttendanceSession = null;
            currentStudentIndex = 0;
            selectedLecture = null;

            document.getElementById('finish-attendance').style.display = 'none';
            document.getElementById('start-attendance').style.display = 'block';
            document.getElementById('mark-present').style.display = 'none';
            document.getElementById('mark-absent').style.display = 'none';
            document.getElementById('student-roll').textContent = 'Roll: -';
            document.getElementById('student-name').textContent = 'Name: -';
            document.getElementById('attendance-progress').textContent = 'Ready to take attendance';

            // Reset lecture selection
            document.querySelectorAll('.lecture-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById('lecture-info').textContent = 'Select lecture number first';
            document.getElementById('lecture-info').style.color = '#666';
        }

        // Global variables
        let currentStudentIndex = 0;
        let currentAttendanceSession = null;
        let selectedLecture = null;
        let selectedTrackLecture = null;

        // Tab management
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Load tab-specific data
            if (tabName === 'attendance') loadAttendanceTab();
            if (tabName === 'track') loadTrackTab();
            if (tabName === 'summary') loadSummaryTab();
            if (tabName === 'manage') loadManageTab();
        }

        // Attendance Tab Functions
        function loadAttendanceTab() {
            loadSubjectOptions('attendance-subject');
            document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
            resetAttendanceSession(); // Initialize the UI properly
        }

        function loadSubjectOptions(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select Subject</option>';
            getSubjects().forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                select.appendChild(option);
            });
        }

        // Lecture selection function
        function selectLecture(lectureNumber) {
            selectedLecture = lectureNumber;

            // Update UI - remove selected class from all buttons
            document.querySelectorAll('.lecture-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Add selected class to clicked button
            document.getElementById(`lecture-${lectureNumber}`).classList.add('selected');

            // Update lecture info
            const subjectId = document.getElementById('attendance-subject').value;
            const date = document.getElementById('attendance-date').value;

            if (subjectId && date) {
                updateLectureInfo(subjectId, date, lectureNumber);
            } else {
                document.getElementById('lecture-info').textContent = `${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture selected`;
            }
        }

        // Helper function for ordinal numbers (1st, 2nd, 3rd)
        function getOrdinalSuffix(number) {
            const lastDigit = number % 10;
            const lastTwoDigits = number % 100;

            if (lastTwoDigits >= 11 && lastTwoDigits <= 13) {
                return 'th';
            }

            switch (lastDigit) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        // Function to update lecture info and check for existing attendance
        function updateLectureInfo(subjectId, date, lectureNumber) {
            const subjects = getSubjects();
            const subject = subjects.find(s => s.id === subjectId);
            const subjectName = subject ? subject.name : 'Unknown';

            // Calculate total lecture count for this subject (semester total)
            const attendance = getAttendance();
            let totalSemesterLectures = 0;

            // Count all lectures for this subject across all dates (semester total)
            Object.keys(attendance).forEach(key => {
                const [sessionDate, sessionSubjectId, sessionLecture] = key.split('_');
                if (sessionSubjectId === subjectId && sessionDate < date) {
                    totalSemesterLectures++;
                }
            });

            // Count lectures on this specific date (to show which lecture of the day this will be)
            let lecturesThisDay = 0;
            Object.keys(attendance).forEach(key => {
                const [sessionDate, sessionSubjectId, sessionLecture] = key.split('_');
                if (sessionSubjectId === subjectId && sessionDate === date && parseInt(sessionLecture) < lectureNumber) {
                    lecturesThisDay++;
                }
            });

            // Check if this specific lecture already exists
            const key = `${date}_${subjectId}_${lectureNumber}`;
            const exists = attendance[key];

            let infoText = `${subjectName} - ${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture of the day`;

            // Show semester count if there are previous lectures
            const upcomingSemesterLecture = totalSemesterLectures + lecturesThisDay + 1;
            if (totalSemesterLectures > 0 || lecturesThisDay > 0) {
                infoText += ` (${upcomingSemesterLecture}${getOrdinalSuffix(upcomingSemesterLecture)} lecture this semester)`;
            }

            if (exists) {
                infoText += ' ‚ö†Ô∏è Already taken';
                document.getElementById('lecture-info').style.color = '#e53935';
            } else {
                document.getElementById('lecture-info').style.color = '#43a047';
            }

            document.getElementById('lecture-info').textContent = infoText;
        }

        function startAttendance() {
            const subjectId = document.getElementById('attendance-subject').value;
            const date = document.getElementById('attendance-date').value;

            if (!subjectId || !date) {
                alert('Please select subject and date');
                return;
            }

            if (!selectedLecture) {
                alert('Please select lecture number (1st, 2nd, or 3rd)');
                return;
            }

            const students = getStudents();
            if (students.length === 0) {
                alert('No students found. Add students first.');
                return;
            }

            // Check if attendance already exists for this date, subject, and lecture
            const existingAttendance = getAttendance();
            const key = `${date}_${subjectId}_${selectedLecture}`;

            if (existingAttendance[key]) {
                if (!confirm(`Attendance already exists for ${selectedLecture}${getOrdinalSuffix(selectedLecture)} lecture of this subject on this date. Do you want to overwrite it?`)) {
                    return;
                }
            }

            currentAttendanceSession = {
                subjectId: subjectId,
                date: date,
                lectureNumber: selectedLecture,
                records: []
            };
            currentStudentIndex = 0;

            // Hide start button and show attendance buttons
            document.getElementById('start-attendance').style.display = 'none';
            document.getElementById('mark-present').style.display = 'inline-block';
            document.getElementById('mark-absent').style.display = 'inline-block';

            showCurrentStudent();
        }

        function showCurrentStudent() {
            const students = getStudents();
            if (currentStudentIndex >= students.length) {
                finishAttendance();
                return;
            }

            const student = students[currentStudentIndex];
            document.getElementById('student-roll').textContent = `Roll: ${student.roll}`;
            document.getElementById('student-name').textContent = `Name: ${student.name}`;
            document.getElementById('attendance-progress').textContent =
                `Student ${currentStudentIndex + 1} of ${students.length}`;
        }

        function markAttendance(status) {
            if (!currentAttendanceSession) {
                alert('Please click "Start Attendance" first');
                return;
            }

            const students = getStudents();
            const student = students[currentStudentIndex];

            currentAttendanceSession.records.push({
                studentId: student.id,
                roll: student.roll,
                name: student.name,
                status: status
            });

            currentStudentIndex++;
            showCurrentStudent();
        }

        function finishAttendance() {
            const attendance = getAttendance();
            const key = `${currentAttendanceSession.date}_${currentAttendanceSession.subjectId}_${currentAttendanceSession.lectureNumber}`;

            // Store attendance with unique key (date_subject_lecture) to prevent duplicates
            attendance[key] = {
                id: Date.now(),
                subjectId: currentAttendanceSession.subjectId,
                date: currentAttendanceSession.date,
                lectureNumber: currentAttendanceSession.lectureNumber,
                records: currentAttendanceSession.records
            };
            setAttendance(attendance);

            // Show Done button
            document.getElementById('finish-attendance').style.display = 'block';
            document.getElementById('student-roll').textContent = 'Attendance Complete!';
            document.getElementById('student-name').textContent = 'Click "Done" to sync data';
            document.getElementById('attendance-progress').textContent = 'All students marked';
        }

        // Track lecture selection function
        function selectTrackLecture(lectureNumber) {
            selectedTrackLecture = lectureNumber;

            // Update UI - remove selected class from all track lecture buttons
            document.querySelectorAll('.track-lecture-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Add selected class to clicked button
            document.getElementById(`track-lecture-${lectureNumber}`).classList.add('selected');
        }

        // Track Tab Functions
        function loadTrackTab() {
            loadSubjectOptions('track-subject');
        }

        function loadAttendanceForEdit() {
            const subjectId = document.getElementById('track-subject').value;
            const date = document.getElementById('track-date').value;

            if (!subjectId || !date) {
                alert('Please select subject and date');
                return;
            }

            if (!selectedTrackLecture) {
                alert('Please select lecture number (1st, 2nd, or 3rd)');
                return;
            }

            const attendance = getAttendance();
            const key = `${date}_${subjectId}_${selectedTrackLecture}`;
            const session = attendance[key];

            const trackList = document.getElementById('track-list');
            trackList.innerHTML = '';

            if (!session) {
                trackList.innerHTML = '<div style="text-align:center;color:#666;">No attendance found for this date.</div>';
                return;
            }

            session.records.forEach((record, index) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div>
                        <strong>${record.roll}</strong> - ${record.name}
                    </div>
                    <div class="actions">
                        <button class="action-btn ${record.status === 'present' ? '' : 'delete'}" 
                                onclick="toggleAttendance('${session.id}', ${index})">
                            ${record.status === 'present' ? 'Present' : 'Absent'}
                        </button>
                    </div>
                `;
                trackList.appendChild(item);
            });
        }

        function toggleAttendance(sessionId, recordIndex) {
            const attendance = getAttendance();
            const session = attendance.find(a => a.id == sessionId);
            const record = session.records[recordIndex];
            record.status = record.status === 'present' ? 'absent' : 'present';
            setAttendance(attendance);
            loadAttendanceForEdit();
        }

        // Summary Tab Functions
        function loadSummaryTab() {
            loadSubjectOptions('summary-subject');
        }

        function generateSummary() {
            const type = document.getElementById('summary-type').value;
            const subjectFilter = document.getElementById('summary-subject').value;
            const dateFrom = document.getElementById('summary-date-from').value;
            const dateTo = document.getElementById('summary-date-to').value;

            const students = getStudents();
            const subjects = getSubjects();
            let attendance = getAttendanceArray(); // Use array version

            // Apply filters
            if (subjectFilter) {
                attendance = attendance.filter(a => a.subjectId === subjectFilter);
            }

            if (dateFrom) {
                attendance = attendance.filter(a => a.date >= dateFrom);
            }

            if (dateTo) {
                attendance = attendance.filter(a => a.date <= dateTo);
            }

            const summaryContent = document.getElementById('summary-content');

            if (type === 'student') {
                generateStudentSummary(students, subjects, attendance, summaryContent);
            } else {
                generateSubjectSummary(students, subjects, attendance, summaryContent);
            }
        } function generateStudentSummary(students, subjects, attendance, container) {
            let html = '<table class="summary-table"><thead><tr><th>Roll</th><th>Name</th><th>Present</th><th>Absent</th><th>Total</th><th>Percentage</th></tr></thead><tbody>';

            students.forEach(student => {
                let present = 0, absent = 0;
                const absentDates = [];

                attendance.forEach(session => {
                    const record = session.records.find(r => r.studentId === student.id);
                    if (record) {
                        if (record.status === 'present') present++;
                        else {
                            absent++;
                            const subject = subjects.find(s => s.id === session.subjectId);
                            absentDates.push(`${session.date} (${subject ? subject.name : 'Unknown'})`);
                        }
                    }
                });

                const total = present + absent;
                const percentage = total > 0 ? ((present / total) * 100).toFixed(1) : 0;

                html += `<tr>
                    <td>${student.roll}</td>
                    <td>${student.name}</td>
                    <td>${present}</td>
                    <td>${absent}</td>
                    <td>${total}</td>
                    <td>${percentage}%</td>
                </tr>`;

                if (absentDates.length > 0) {
                    html += `<tr><td colspan="6" style="font-size:12px;color:#666;padding-left:20px;">Absent on: ${absentDates.join(', ')}</td></tr>`;
                }
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function generateSubjectSummary(students, subjects, attendance, container) {
            let html = '<table class="summary-table"><thead><tr><th>Subject</th><th>Date</th><th>Lecture</th><th>Present</th><th>Absent</th><th>Total</th></tr></thead><tbody>';

            attendance.forEach(session => {
                const subject = subjects.find(s => s.id === session.subjectId);
                const present = session.records.filter(r => r.status === 'present').length;
                const absent = session.records.filter(r => r.status === 'absent').length;
                const lectureInfo = session.lectureNumber ? `${session.lectureNumber}${getOrdinalSuffix(session.lectureNumber)}` : 'N/A';

                html += `<tr>
                    <td>${subject ? subject.name : 'Unknown (ID: ' + session.subjectId + ')'}</td>
                    <td>${session.date}</td>
                    <td>${lectureInfo}</td>
                    <td>${present}</td>
                    <td>${absent}</td>
                    <td>${present + absent}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        } function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const type = document.getElementById('summary-type').value;
            const subjectFilter = document.getElementById('summary-subject').value;
            const dateFrom = document.getElementById('summary-date-from').value;
            const dateTo = document.getElementById('summary-date-to').value;

            const students = getStudents();
            const subjects = getSubjects();
            let attendance = getAttendanceArray();

            // Apply filters
            if (subjectFilter) {
                attendance = attendance.filter(a => a.subjectId === subjectFilter);
            }
            if (dateFrom) {
                attendance = attendance.filter(a => a.date >= dateFrom);
            }
            if (dateTo) {
                attendance = attendance.filter(a => a.date <= dateTo);
            }

            if (type === 'student') {
                generateStudentPDF(doc, students, subjects, attendance, subjectFilter);
            } else {
                generateSubjectPDF(doc, students, subjects, attendance, subjectFilter);
            }

            // Save the PDF
            const fileName = type === 'student' ? 'Student_Attendance_Report.pdf' : 'Subject_Attendance_Report.pdf';
            doc.save(fileName);
        }

        function generateStudentPDF(doc, students, subjects, attendance, subjectFilter) {
            // Header
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Student Attendance Report', 105, 20, { align: 'center' });

            // Date and filters
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const dateGenerated = new Date().toLocaleDateString();
            doc.text(`Generated on: ${dateGenerated}`, 20, 35);

            if (subjectFilter) {
                const subject = subjects.find(s => s.id === subjectFilter);
                doc.text(`Subject: ${subject ? subject.name : 'Unknown'}`, 20, 42);
            }

            let yPos = 55;

            // Sort students by roll number
            const sortedStudents = [...students].sort((a, b) => a.roll.localeCompare(b.roll));

            sortedStudents.forEach((student, index) => {
                // Check if we need a new page
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }

                let present = 0, absent = 0;
                const absentDetails = [];

                // Group attendance by date
                const attendanceByDate = {};
                attendance.forEach(session => {
                    const record = session.records.find(r => r.studentId === student.id);
                    if (record) {
                        if (!attendanceByDate[session.date]) {
                            attendanceByDate[session.date] = [];
                        }
                        const subject = subjects.find(s => s.id === session.subjectId);
                        const lectureInfo = session.lectureNumber ? `Lecture ${session.lectureNumber}` : '';
                        attendanceByDate[session.date].push({
                            subject: subject ? subject.name : 'Unknown',
                            lecture: lectureInfo,
                            status: record.status
                        });

                        if (record.status === 'present') {
                            present++;
                        } else {
                            absent++;
                        }
                    }
                });

                const total = present + absent;
                const percentage = total > 0 ? ((present / total) * 100).toFixed(1) : 0;

                // Student header
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${student.roll} - ${student.name}`, 20, yPos);

                // Statistics
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Present: ${present} | Absent: ${absent} | Total: ${total} | Attendance: ${percentage}%`, 20, yPos + 8);
                yPos += 18;

                // Absent dates details
                if (absent > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Absent Details:', 25, yPos);
                    yPos += 8;
                    doc.setFont(undefined, 'normal');

                    Object.keys(attendanceByDate).sort().forEach(date => {
                        const dayAttendance = attendanceByDate[date];
                        const absentSessions = dayAttendance.filter(session => session.status === 'absent');

                        if (absentSessions.length > 0) {
                            doc.text(`‚Ä¢ ${date}:`, 30, yPos);
                            yPos += 6;

                            absentSessions.forEach(session => {
                                doc.text(`  - ${session.subject} ${session.lecture}`, 35, yPos);
                                yPos += 5;
                            });
                            yPos += 3;
                        }
                    });
                } else {
                    doc.setFont(undefined, 'italic');
                    doc.text('No absences recorded', 25, yPos);
                    yPos += 8;
                }

                yPos += 10; // Space between students
            });
        }

        function generateSubjectPDF(doc, students, subjects, attendance, subjectFilter) {
            // Header
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Subject-wise Attendance Report', 105, 20, { align: 'center' });

            // Date and filters
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const dateGenerated = new Date().toLocaleDateString();
            doc.text(`Generated on: ${dateGenerated}`, 20, 35);

            let yPos = 50;

            // Group attendance by date and subject
            const attendanceByDateSubject = {};
            attendance.forEach(session => {
                const key = `${session.date}_${session.subjectId}_${session.lectureNumber || 1}`;
                attendanceByDateSubject[key] = session;
            });

            // Sort by date, then subject
            const sortedKeys = Object.keys(attendanceByDateSubject).sort();

            sortedKeys.forEach(key => {
                const session = attendanceByDateSubject[key];
                const subject = subjects.find(s => s.id === session.subjectId);
                const subjectName = subject ? subject.name : 'Unknown';
                const lectureInfo = session.lectureNumber ? `${session.lectureNumber}${getOrdinalSuffix(session.lectureNumber)} Lecture` : '';

                // Check if we need a new page
                if (yPos > 220) {
                    doc.addPage();
                    yPos = 20;
                }

                // Date header
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`${session.date} - ${subjectName} (${lectureInfo})`, 20, yPos);
                yPos += 10;

                const presentStudents = [];
                const absentStudents = [];

                session.records.forEach(record => {
                    const student = students.find(s => s.id === record.studentId);
                    if (student) {
                        if (record.status === 'present') {
                            presentStudents.push(student);
                        } else {
                            absentStudents.push(student);
                        }
                    }
                });

                // Sort students by roll number
                presentStudents.sort((a, b) => a.roll.localeCompare(b.roll));
                absentStudents.sort((a, b) => a.roll.localeCompare(b.roll));

                // Statistics
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Present: ${presentStudents.length} | Absent: ${absentStudents.length} | Total: ${presentStudents.length + absentStudents.length}`, 20, yPos);
                yPos += 10;

                // Present students
                if (presentStudents.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Present Students:', 20, yPos);
                    yPos += 6;
                    doc.setFont(undefined, 'normal');

                    presentStudents.forEach(student => {
                        doc.text(`‚Ä¢ ${student.roll} - ${student.name}`, 25, yPos);
                        yPos += 5;
                    });
                    yPos += 5;
                }

                // Absent students
                if (absentStudents.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Absent Students:', 20, yPos);
                    yPos += 6;
                    doc.setFont(undefined, 'normal');

                    absentStudents.forEach(student => {
                        doc.text(`‚Ä¢ ${student.roll} - ${student.name}`, 25, yPos);
                        yPos += 5;
                    });
                    yPos += 5;
                } else {
                    doc.setFont(undefined, 'italic');
                    doc.text('No absent students', 25, yPos);
                    yPos += 8;
                }

                yPos += 10; // Space between sessions
            });
        }        // Manage Tab Functions
        function loadManageTab() {
            loadStudentsList();
            loadSubjectsList();
        }

        function addStudent() {
            const rollElement = document.getElementById('new-student-roll');
            const nameElement = document.getElementById('new-student-name');

            if (!rollElement || !nameElement) {
                alert('Error: Could not find input fields. Make sure you are on the Manage tab.');
                return;
            }

            const roll = rollElement.value.trim();
            const name = nameElement.value.trim();

            if (!roll || !name) {
                alert('Please enter both roll number and name');
                return;
            }

            const students = getStudents();

            if (students.find(s => s.roll === roll)) {
                alert('Student with this roll number already exists');
                return;
            }

            const newStudent = {
                id: Date.now(),
                roll: roll,
                name: name
            };

            students.push(newStudent);

            setStudents(students);
            rollElement.value = '';
            nameElement.value = '';
            loadStudentsList();
        }

        function deleteStudent(id) {
            if (confirm('Are you sure you want to delete this student?')) {
                const students = getStudents().filter(s => s.id !== id);
                setStudents(students);
                loadStudentsList();
            }
        }

        function loadStudentsList() {
            const students = getStudents();
            const list = document.getElementById('students-list');

            if (students.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#666;">No students added yet.</div>';
                return;
            }

            list.innerHTML = students.map(student => `
                <div class="list-item">
                    <div><strong>${student.roll}</strong> - ${student.name}</div>
                    <div class="actions">
                        <button class="action-btn delete" onclick="deleteStudent(${student.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function addSubject() {
            const name = document.getElementById('subject-name').value.trim();

            if (!name) {
                alert('Please enter subject name');
                return;
            }

            const subjects = getSubjects();
            if (subjects.find(s => s.name === name)) {
                alert('Subject with this name already exists');
                return;
            }

            subjects.push({
                id: Date.now(),
                name: name
            });

            setSubjects(subjects);
            document.getElementById('subject-name').value = '';
            loadSubjectsList();
        }

        function deleteSubject(id) {
            if (confirm('Are you sure you want to delete this subject?')) {
                const subjects = getSubjects().filter(s => s.id !== id);
                setSubjects(subjects);
                loadSubjectsList();
            }
        }

        function loadSubjectsList() {
            const subjects = getSubjects();
            const list = document.getElementById('subjects-list');

            if (subjects.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#666;">No subjects added yet.</div>';
                return;
            }

            list.innerHTML = subjects.map(subject => `
                <div class="list-item">
                    <div>${subject.name}</div>
                    <div class="actions">
                        <button class="action-btn delete" onclick="deleteSubject(${subject.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Utility: get all app data
        function getAllAppData() {
            return {
                students: getStudents(),
                subjects: getSubjects(),
                attendance: getAttendance(),
            };
        }

        // Utility: set all app data
        function setAllAppData(data) {
            if (data.students) setStudents(data.students);
            if (data.subjects) setSubjects(data.subjects);
            if (data.attendance) setAttendance(data.attendance);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize sync status
            updateSyncUI();
            if (isConnected) {
                updateSyncStatus('online');
                loadFromCloud(); // Load latest data on startup
            } else {
                updateSyncStatus('offline');
            }

            // Sync event listeners
            document.getElementById('generate-code').addEventListener('click', generateSyncCode);
            document.getElementById('connect-sync').addEventListener('click', connectToSync);
            document.getElementById('disconnect-sync').addEventListener('click', disconnectSync);
            document.getElementById('manual-sync').addEventListener('click', loadFromCloud);

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Attendance tab
            document.getElementById('attendance-subject').addEventListener('change', () => {
                if (currentAttendanceSession) {
                    if (confirm('This will restart attendance taking. Continue?')) {
                        currentAttendanceSession = null;
                        currentStudentIndex = 0;
                    }
                }
            });

            // Lecture selection buttons
            document.getElementById('lecture-1').addEventListener('click', () => selectLecture(1));
            document.getElementById('lecture-2').addEventListener('click', () => selectLecture(2));
            document.getElementById('lecture-3').addEventListener('click', () => selectLecture(3));

            // Subject/date change listeners
            document.getElementById('attendance-subject').addEventListener('change', () => {
                if (selectedLecture) {
                    const subjectId = document.getElementById('attendance-subject').value;
                    const date = document.getElementById('attendance-date').value;
                    if (subjectId && date) {
                        updateLectureInfo(subjectId, date, selectedLecture);
                    }
                }
            });

            document.getElementById('attendance-date').addEventListener('change', () => {
                if (selectedLecture) {
                    const subjectId = document.getElementById('attendance-subject').value;
                    const date = document.getElementById('attendance-date').value;
                    if (subjectId && date) {
                        updateLectureInfo(subjectId, date, selectedLecture);
                    }
                }
            });

            document.getElementById('start-attendance').addEventListener('click', startAttendance);
            document.getElementById('mark-present').addEventListener('click', () => markAttendance('present'));
            document.getElementById('mark-absent').addEventListener('click', () => markAttendance('absent'));
            document.getElementById('finish-attendance').addEventListener('click', finishAndSync);

            // Track tab
            document.getElementById('track-lecture-1').addEventListener('click', () => selectTrackLecture(1));
            document.getElementById('track-lecture-2').addEventListener('click', () => selectTrackLecture(2));
            document.getElementById('track-lecture-3').addEventListener('click', () => selectTrackLecture(3));
            document.getElementById('load-attendance').addEventListener('click', loadAttendanceForEdit);

            // Summary tab
            document.getElementById('generate-summary').addEventListener('click', generateSummary);
            document.getElementById('download-pdf').addEventListener('click', downloadPDF);

            // Manage tab
            document.getElementById('add-student').addEventListener('click', addStudent);
            document.getElementById('add-subject').addEventListener('click', addSubject);

            // Enter key support
            document.getElementById('new-student-roll').addEventListener('keypress', e => {
                if (e.key === 'Enter') document.getElementById('new-student-name').focus();
            });
            document.getElementById('new-student-name').addEventListener('keypress', e => {
                if (e.key === 'Enter') addStudent();
            });
            document.getElementById('subject-name').addEventListener('keypress', e => {
                if (e.key === 'Enter') addSubject();
            });

            // Backup/Import functionality
            const backupBtn = document.getElementById('backup-btn');
            const importBtn = document.getElementById('import-btn');
            const importFile = document.getElementById('import-file');
            const deleteAllBtn = document.getElementById('delete-all-btn');
            const manageMsg = document.getElementById('manage-message');

            if (backupBtn) {
                backupBtn.onclick = function () {
                    const data = getAllAppData();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'attendance_backup_' + new Date().toISOString().slice(0, 10) + '.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };
            }

            if (importBtn && importFile) {
                importBtn.onclick = function () {
                    importFile.click();
                };
                importFile.onchange = function (e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        try {
                            const data = JSON.parse(evt.target.result);
                            setAllAppData(data);
                            manageMsg.textContent = 'Data imported successfully!';
                            manageMsg.style.color = '#43a047';
                            setTimeout(() => manageMsg.textContent = '', 3000);
                            loadManageTab();
                        } catch (err) {
                            manageMsg.textContent = 'Invalid file format!';
                            manageMsg.style.color = '#e53935';
                            setTimeout(() => manageMsg.textContent = '', 3000);
                        }
                    };
                    reader.readAsText(file);
                };
            }

            if (deleteAllBtn) {
                deleteAllBtn.onclick = function () {
                    if (confirm('Are you sure you want to delete ALL records? This cannot be undone.')) {
                        localStorage.removeItem('students');
                        localStorage.removeItem('subjects');
                        localStorage.removeItem('attendance');
                        manageMsg.textContent = 'All records deleted.';
                        manageMsg.style.color = '#e53935';
                        setTimeout(() => manageMsg.textContent = '', 3000);
                        loadManageTab();
                    }
                };
            }

            // Initialize
            loadAttendanceTab();
        });
    </script>
</body>

</html>