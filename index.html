<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracker</title>
    <style>
        :root {
            --primary-color: #2196F3;
            --primary-dark: #1976D2;
            --primary-light: #E3F2FD;
            --secondary-color: #FF9800;
            --secondary-dark: #F57C00;
            --accent-color: #4CAF50;
            --accent-dark: #388E3C;
            --error-color: #F44336;
            --warning-color: #FF9800;
            --surface-color: #FFFFFF;
            --surface-dark: #F5F5F5;
            --text-primary: #212121;
            --text-secondary: #757575;
            --divider-color: #E0E0E0;
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 8px 16px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
            --border-radius-small: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-light) 0%, #f8f9fa 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 16px;
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
            background: var(--surface-color);
            min-height: 100vh;
            box-shadow: var(--shadow-medium);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .tab-content {
            display: none;
            padding: 20px 0;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--divider-color);
            border-radius: var(--border-radius-small);
            font-size: 16px;
            transition: var(--transition);
            background: var(--surface-color);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-color), #d32f2f);
        }

        .btn-block {
            width: 100%;
            margin-bottom: 12px;
        }

        .student-list {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--divider-color);
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--divider-color);
            transition: var(--transition);
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-item:hover {
            background: var(--surface-dark);
            margin: 0 -20px;
            padding-left: 20px;
            padding-right: 20px;
            border-radius: var(--border-radius-small);
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .student-roll {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .attendance-btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            margin-left: 8px;
        }

        .btn-present {
            background: var(--accent-color);
            color: white;
        }

        .btn-absent {
            background: var(--error-color);
            color: white;
        }

        .btn-present:hover {
            background: var(--accent-dark);
        }

        .btn-absent:hover {
            background: #d32f2f;
        }

        .lecture-btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            margin: 4px;
            background: #e0e0e0;
            color: #333;
            flex: 1;
        }

        .lecture-btn.selected {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .lecture-btn:hover {
            background: var(--primary-light);
        }

        .lecture-selection {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .summary-card {
            background: var(--surface-color);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--primary-color);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .summary-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .summary-percentage {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: var(--surface-dark);
            border-radius: var(--border-radius-small);
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: linear-gradient(135deg, var(--surface-color), var(--surface-dark));
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: var(--shadow-heavy);
            border-top: 1px solid var(--divider-color);
            backdrop-filter: blur(10px);
        }

        .tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
            border-radius: var(--border-radius-small);
            min-width: 70px;
        }

        .tab:hover {
            background: var(--primary-light);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .tab-icon {
            font-size: 1.5em;
            margin-bottom: 4px;
        }

        .tab-label {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message {
            padding: 12px;
            border-radius: var(--border-radius-small);
            margin-bottom: 16px;
            font-weight: 500;
            text-align: center;
        }

        .message.success {
            background: #e8f5e8;
            color: var(--accent-dark);
            border: 1px solid var(--accent-color);
        }

        .message.error {
            background: #ffeaea;
            color: #c62828;
            border: 1px solid var(--error-color);
        }

        .hidden {
            display: none !important;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--divider-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--primary-color));
            transition: width 0.3s ease;
        }

        .attendance-summary {
            margin-top: 20px;
        }

        .class-summary {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--primary-color);
        }

        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .class-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .class-date {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .absent-students {
            background: #fff3e0;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius-small);
            padding: 15px;
            margin-top: 15px;
        }

        .absent-students h4 {
            color: var(--secondary-dark);
            margin-bottom: 10px;
            font-size: 1em;
        }

        .absent-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .absent-roll {
            background: var(--secondary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .export-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .danger-zone {
            background: #ffeaea;
            border: 1px solid var(--error-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 30px;
        }

        .danger-zone h3 {
            color: var(--error-color);
            margin-bottom: 15px;
        }

        .danger-zone .btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
                padding-bottom: 90px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .summary-stats {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .export-options {
                grid-template-columns: 1fr;
            }

            .tab-bar {
                padding: 8px 0;
            }

            .tab-icon {
                font-size: 1.2em;
            }

            .tab-label {
                font-size: 0.7em;
            }
        }

        /* Tecno Camon 40 specific optimizations */
        @media (max-width: 400px) and (max-height: 800px) {
            .container {
                padding: 10px;
                padding-bottom: 80px;
            }

            .header {
                padding: 15px 0;
                margin-bottom: 20px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            input,
            select,
            textarea {
                padding: 10px 12px;
            }

            .student-list {
                padding: 15px;
            }

            .summary-card {
                padding: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>📚 Attendance Tracker</h1>
            <p>Manage student attendance efficiently</p>
        </div>

        <!-- Take Attendance Tab -->
        <div class="tab-content active" id="attendance">
            <div class="form-group">
                <label for="subject-select">Select Subject:</label>
                <select id="subject-select">
                    <option value="">Choose a subject...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="class-date">Class Date:</label>
                <input type="date" id="class-date">
            </div>

            <!-- Lecture Selection -->
            <div class="form-group">
                <label>Select Lecture:</label>
                <div class="lecture-selection">
                    <button class="lecture-btn" id="lecture-1" data-lecture="1">
                        1st Lecture
                    </button>
                    <button class="lecture-btn" id="lecture-2" data-lecture="2">
                        2nd Lecture
                    </button>
                    <button class="lecture-btn" id="lecture-3" data-lecture="3">
                        3rd Lecture
                    </button>
                </div>
                <div id="lecture-info"
                    style="font-size: 14px; color: var(--text-secondary); text-align: center; margin-top: 8px;">
                    Select lecture number first
                </div>
            </div>

            <div id="student-attendance" class="student-list hidden">
                <!-- Students will be loaded here -->
            </div>

            <button class="btn btn-success btn-block" id="save-attendance">
                💾 Save Attendance
            </button>

            <div id="attendance-message" class="message hidden"></div>
        </div>

        <!-- Track Attendance Tab -->
        <div class="tab-content" id="track">
            <div class="form-group">
                <label for="track-subject">Select Subject:</label>
                <select id="track-subject">
                    <option value="">Choose a subject...</option>
                </select>
            </div>

            <div id="attendance-summary" class="attendance-summary">
                <!-- Attendance summary will be loaded here -->
            </div>
        </div>

        <!-- Summary Tab -->
        <div class="tab-content" id="summary">
            <div class="form-group">
                <label for="summary-subject">Select Subject:</label>
                <select id="summary-subject">
                    <option value="">Choose a subject...</option>
                </select>
            </div>

            <div id="student-summary">
                <!-- Student summaries will be loaded here -->
            </div>

            <div class="export-options">
                <button class="btn btn-secondary" id="export-pdf">
                    📄 Export PDF
                </button>
                <button class="btn" id="export-data">
                    📊 Export Data
                </button>
            </div>
        </div>

        <!-- Manage Tab -->
        <div class="tab-content" id="manage">
            <h3 style="margin-bottom: 20px; color: var(--text-primary);">👥 Manage Students</h3>

            <div class="form-group">
                <label for="student-name">Student Name:</label>
                <input type="text" id="student-name" placeholder="Enter student name">
            </div>

            <div class="form-group">
                <label for="student-roll">Roll Number:</label>
                <input type="text" id="student-roll" placeholder="Enter roll number">
            </div>

            <button class="btn btn-success btn-block" id="add-student">
                ➕ Add Student
            </button>

            <h3 style="margin: 30px 0 20px 0; color: var(--text-primary);">📚 Manage Subjects</h3>

            <div class="form-group">
                <label for="subject-name">Subject Name:</label>
                <input type="text" id="subject-name" placeholder="Enter subject name">
            </div>

            <button class="btn btn-success btn-block" id="add-subject">
                ➕ Add Subject
            </button>

            <div id="current-students" class="student-list">
                <!-- Current students will be loaded here -->
            </div>

            <div id="current-subjects" class="student-list">
                <!-- Current subjects will be loaded here -->
            </div>

            <h3 style="margin: 30px 0 20px 0; color: var(--text-primary);">💾 Backup & Import</h3>

            <div class="export-options">
                <button class="btn btn-secondary" id="backup-data">
                    💾 Backup Data
                </button>
                <button class="btn" id="import-data">
                    📁 Import Data
                </button>
            </div>
            <input type="file" id="import-file" accept=".json" style="display: none;">

            <div class="danger-zone">
                <h3>⚠️ Danger Zone</h3>
                <button class="btn btn-danger" id="clear-attendance">Clear All Attendance</button>
                <button class="btn btn-danger" id="clear-students">Clear All Students</button>
                <button class="btn btn-danger" id="clear-subjects">Clear All Subjects</button>
                <div style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary);">
                    ⚠️ Warning: These actions cannot be undone. Export data first if needed.
                </div>
            </div>

            <div id="manage-message" class="message hidden"></div>
        </div>
    </div>
    <div class="tab-bar">
        <div class="tab active" data-tab="attendance">
            <span class="tab-icon">📝</span>
            <span class="tab-label">Take</span>
        </div>
        <div class="tab" data-tab="track">
            <span class="tab-icon">📊</span>
            <span class="tab-label">Track</span>
        </div>
        <div class="tab" data-tab="summary">
            <span class="tab-icon">📋</span>
            <span class="tab-label">Summary</span>
        </div>
        <div class="tab" data-tab="manage">
            <span class="tab-icon">⚙️</span>
            <span class="tab-label">Manage</span>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Data storage utilities
        function getStudents() {
            return JSON.parse(localStorage.getItem('students') || '[]');
        }

        function setStudents(students) {
            localStorage.setItem('students', JSON.stringify(students));
        }

        function getSubjects() {
            return JSON.parse(localStorage.getItem('subjects') || '[]');
        }

        function setSubjects(subjects) {
            localStorage.setItem('subjects', JSON.stringify(subjects));
        }

        function getAttendance() {
            return JSON.parse(localStorage.getItem('attendance') || '{}');
        }

        function setAttendance(attendance) {
            localStorage.setItem('attendance', JSON.stringify(attendance));
        }

        // Tab functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to selected tab
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

            // Load content for the selected tab
            if (tabName === 'attendance') {
                loadSubjects('subject-select');
                setTodayDate();
                selectedLecture = null;
                // Reset lecture selection UI
                document.querySelectorAll('.lecture-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                document.getElementById('lecture-info').textContent = 'Select lecture number first';
            } else if (tabName === 'track') {
                loadSubjects('track-subject');
            } else if (tabName === 'summary') {
                loadSubjects('summary-subject');
            } else if (tabName === 'manage') {
                loadCurrentStudents();
                loadCurrentSubjects();
            }
        }

        // Set today's date as default
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('class-date').value = today;
        }

        // Load subjects into select dropdown
        function loadSubjects(selectId) {
            const select = document.getElementById(selectId);
            const subjects = getSubjects();

            select.innerHTML = '<option value="">Choose a subject...</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                select.appendChild(option);
            });
        }

        // Load students for attendance taking
        function loadStudentsForAttendance() {
            const subjectSelect = document.getElementById('subject-select');
            const selectedSubjectId = subjectSelect.value;
            const studentAttendanceDiv = document.getElementById('student-attendance');

            if (!selectedSubjectId || !selectedLecture) {
                studentAttendanceDiv.classList.add('hidden');
                return;
            }

            const students = getStudents();
            studentAttendanceDiv.classList.remove('hidden');

            let html = '<h3 style="margin-bottom: 15px; color: var(--text-primary);">Mark Attendance</h3>';
            students.forEach(student => {
                html += `
                    <div class="student-item">
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-roll">Roll: ${student.roll}</div>
                        </div>
                        <div>
                            <button class="attendance-btn btn-present" 
                                    onclick="markAttendance('${student.roll}', 'present')">
                                ✓ Present
                            </button>
                            <button class="attendance-btn btn-absent" 
                                    onclick="markAttendance('${student.roll}', 'absent')">
                                ✗ Absent
                            </button>
                        </div>
                    </div>
                `;
            });

            studentAttendanceDiv.innerHTML = html;
        }

        // Lecture selection function
        function selectLecture(lectureNumber) {
            selectedLecture = lectureNumber;

            // Update UI - remove selected class from all buttons
            document.querySelectorAll('.lecture-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Add selected class to clicked button
            document.getElementById(`lecture-${lectureNumber}`).classList.add('selected');

            // Update lecture info
            const subjectId = document.getElementById('subject-select').value;
            const date = document.getElementById('class-date').value;

            if (subjectId && date) {
                updateLectureInfo(subjectId, date, lectureNumber);
            } else {
                document.getElementById('lecture-info').textContent = `${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture selected`;
            }

            // Load students if subject is selected
            loadStudentsForAttendance();
        }

        // Helper function to get ordinal suffix
        function getOrdinalSuffix(num) {
            const suffixes = ['th', 'st', 'nd', 'rd'];
            const v = num % 100;
            return suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0];
        }

        // Update lecture info
        function updateLectureInfo(subjectId, date, lectureNumber) {
            const subjects = getSubjects();
            const subject = subjects.find(s => s.id == subjectId);
            const subjectName = subject ? subject.name : 'Unknown Subject';

            const attendance = getAttendance();
            const key = `${date}_${subjectId}_${lectureNumber}`;

            if (attendance[key]) {
                const totalStudents = Object.keys(attendance[key].records).length;
                const presentStudents = Object.values(attendance[key].records).filter(status => status === 'present').length;
                document.getElementById('lecture-info').textContent =
                    `${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture - ${subjectName} (${presentStudents}/${totalStudents} present)`;
            } else {
                document.getElementById('lecture-info').textContent =
                    `${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture - ${subjectName} (Not taken yet)`;
            }
        }

        // Track which students have been marked
        let currentAttendance = {};
        let selectedLecture = null;

        // Mark individual student attendance
        function markAttendance(rollNumber, status) {
            currentAttendance[rollNumber] = status;

            // Update button states
            const studentItem = event.target.closest('.student-item');
            const buttons = studentItem.querySelectorAll('.attendance-btn');

            buttons.forEach(btn => {
                btn.style.opacity = '0.5';
                btn.style.transform = 'scale(0.95)';
            });

            event.target.style.opacity = '1';
            event.target.style.transform = 'scale(1)';
            event.target.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        }

        // Save attendance for the class
        function saveAttendance() {
            const subjectSelect = document.getElementById('subject-select');
            const selectedSubjectId = subjectSelect.value;
            const date = document.getElementById('class-date').value;
            const messageDiv = document.getElementById('attendance-message');

            if (!selectedSubjectId || !date) {
                showMessage(messageDiv, 'Please select subject and date', 'error');
                return;
            }

            if (!selectedLecture) {
                showMessage(messageDiv, 'Please select lecture number', 'error');
                return;
            }

            if (Object.keys(currentAttendance).length === 0) {
                showMessage(messageDiv, 'Please mark attendance for at least one student', 'error');
                return;
            }

            // Get subject name for display
            const subjects = getSubjects();
            const selectedSubject = subjects.find(s => s.id == selectedSubjectId);
            const subjectName = selectedSubject ? selectedSubject.name : 'Unknown Subject';

            const attendance = getAttendance();
            const key = `${date}_${selectedSubjectId}_${selectedLecture}`;

            // Check if attendance already exists
            if (attendance[key]) {
                if (!confirm(`Attendance already exists for ${selectedLecture}${getOrdinalSuffix(selectedLecture)} lecture of this subject on this date. Do you want to overwrite it?`)) {
                    return;
                }
            }

            attendance[key] = {
                subjectId: selectedSubjectId,
                subject: subjectName,
                date: date,
                lectureNumber: selectedLecture,
                records: currentAttendance,
                timestamp: new Date().toISOString()
            };

            setAttendance(attendance);
            showMessage(messageDiv, `Attendance saved for ${subjectName} - ${selectedLecture}${getOrdinalSuffix(selectedLecture)} lecture on ${date}`, 'success');

            // Reset current attendance
            currentAttendance = {};
            loadStudentsForAttendance();

            // Update lecture info
            updateLectureInfo(selectedSubjectId, date, selectedLecture);
        }

        // Show attendance summary for tracking
        function showAttendanceSummary() {
            const subjectSelect = document.getElementById('track-subject');
            const selectedSubjectId = subjectSelect.value;
            const summaryDiv = document.getElementById('attendance-summary');

            if (!selectedSubjectId) {
                summaryDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Please select a subject to view attendance summary.</p>';
                return;
            }

            const attendance = getAttendance();
            const subjectAttendance = Object.values(attendance).filter(record => record.subjectId == selectedSubjectId);

            if (subjectAttendance.length === 0) {
                summaryDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No attendance records found for this subject.</p>';
                return;
            }

            // Sort by date and lecture number (newest first)
            subjectAttendance.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare === 0) {
                    return b.lectureNumber - a.lectureNumber;
                }
                return dateCompare;
            });

            let html = '';
            subjectAttendance.forEach(record => {
                const totalStudents = Object.keys(record.records || record.attendance || {}).length;
                const attendanceRecords = record.records || record.attendance || {};
                const presentStudents = Object.values(attendanceRecords).filter(status => status === 'present').length;
                const absentStudents = totalStudents - presentStudents;
                const percentage = totalStudents > 0 ? ((presentStudents / totalStudents) * 100).toFixed(1) : 0;

                // Get absent students list
                const absentList = [];
                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (status === 'absent') {
                        absentList.push(rollNumber);
                    }
                });

                const lectureInfo = record.lectureNumber ? ` - ${record.lectureNumber}${getOrdinalSuffix(record.lectureNumber)} Lecture` : '';

                html += `
                    <div class="class-summary">
                        <div class="class-header">
                            <div class="class-title">${record.subject}${lectureInfo}</div>
                            <div class="class-date">${new Date(record.date).toLocaleDateString()}</div>
                        </div>
                        <div class="summary-stats">
                            <div class="stat-item">
                                <div class="stat-value">${presentStudents}</div>
                                <div class="stat-label">Present</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${absentStudents}</div>
                                <div class="stat-label">Absent</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${percentage}%</div>
                                <div class="stat-label">Attendance</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        ${absentList.length > 0 ? `
                            <div class="absent-students">
                                <h4>🚫 Absent Students (${absentList.length})</h4>
                                <div class="absent-list">
                                    ${absentList.map(roll => `<span class="absent-roll">${roll}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            summaryDiv.innerHTML = html;
        }

        // Show student-wise summary
        function showStudentSummary() {
            const subjectSelect = document.getElementById('summary-subject');
            const selectedSubjectId = subjectSelect.value;
            const summaryDiv = document.getElementById('student-summary');

            if (!selectedSubjectId) {
                summaryDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Please select a subject to view student summary.</p>';
                return;
            }

            const students = getStudents();
            const attendance = getAttendance();
            const subjectAttendance = Object.values(attendance).filter(record => record.subjectId == selectedSubjectId);

            if (subjectAttendance.length === 0) {
                summaryDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No attendance records found for this subject.</p>';
                return;
            }

            // Get subject name
            const subjects = getSubjects();
            const selectedSubject = subjects.find(s => s.id == selectedSubjectId);
            const subjectName = selectedSubject ? selectedSubject.name : 'Unknown Subject';

            // Calculate student statistics
            const studentStats = {};
            students.forEach(student => {
                studentStats[student.roll] = {
                    name: student.name,
                    roll: student.roll,
                    present: 0,
                    absent: 0,
                    total: 0
                };
            });

            subjectAttendance.forEach(record => {
                const attendanceRecords = record.records || record.attendance || {};
                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (studentStats[rollNumber]) {
                        studentStats[rollNumber].total++;
                        if (status === 'present') {
                            studentStats[rollNumber].present++;
                        } else {
                            studentStats[rollNumber].absent++;
                        }
                    }
                });
            });

            // Sort students by attendance percentage (lowest first to highlight absent students)
            const sortedStats = Object.values(studentStats)
                .filter(stat => stat.total > 0)
                .sort((a, b) => {
                    const percentageA = (a.present / a.total) * 100;
                    const percentageB = (b.present / b.total) * 100;
                    return percentageA - percentageB;
                });

            let html = `<h3 style="margin-bottom: 20px; color: var(--text-primary);">📊 Student Summary for ${subjectName}</h3>`;

            if (sortedStats.length === 0) {
                html += '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No students have attendance records for this subject.</p>';
            } else {
                sortedStats.forEach(stat => {
                    const percentage = ((stat.present / stat.total) * 100).toFixed(1);
                    const isLowAttendance = percentage < 75;

                    html += `
                        <div class="summary-card" style="${isLowAttendance ? 'border-left-color: var(--error-color); background: #ffeaea;' : ''}">
                            <div class="summary-header">
                                <div class="summary-title">
                                    ${stat.name} ${isLowAttendance ? '⚠️' : ''}
                                    <div style="font-size: 0.8em; color: var(--text-secondary);">Roll: ${stat.roll}</div>
                                </div>
                                <div class="summary-percentage" style="${isLowAttendance ? 'color: var(--error-color);' : ''}">${percentage}%</div>
                            </div>
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <div class="stat-value" style="color: var(--accent-color);">${stat.present}</div>
                                    <div class="stat-label">Present</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" style="color: var(--error-color);">${stat.absent}</div>
                                    <div class="stat-label">Absent</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${stat.total}</div>
                                    <div class="stat-label">Total Classes</div>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%; ${isLowAttendance ? 'background: linear-gradient(90deg, var(--error-color), var(--warning-color));' : ''}"></div>
                            </div>
                        </div>
                    `;
                });
            }

            summaryDiv.innerHTML = html;
        }

        // Add new student
        function addStudent() {
            const name = document.getElementById('student-name').value.trim();
            const roll = document.getElementById('student-roll').value.trim();
            const messageDiv = document.getElementById('manage-message');

            if (!name || !roll) {
                showMessage(messageDiv, 'Please enter both name and roll number', 'error');
                return;
            }

            const students = getStudents();

            // Check if roll number already exists
            if (students.some(student => student.roll === roll)) {
                showMessage(messageDiv, 'Roll number already exists', 'error');
                return;
            }

            const newStudent = {
                id: Date.now(),
                roll: roll,
                name: name
            };

            students.push(newStudent);
            setStudents(students);

            // Clear inputs
            document.getElementById('student-name').value = '';
            document.getElementById('student-roll').value = '';

            showMessage(messageDiv, `Student ${name} added successfully`, 'success');
            loadCurrentStudents();
        }

        // Add new subject
        function addSubject() {
            const subjectName = document.getElementById('subject-name').value.trim();
            const messageDiv = document.getElementById('manage-message');

            if (!subjectName) {
                showMessage(messageDiv, 'Please enter subject name', 'error');
                return;
            }

            const subjects = getSubjects();

            // Check if subject already exists
            if (subjects.some(subject => subject.name === subjectName)) {
                showMessage(messageDiv, 'Subject already exists', 'error');
                return;
            }

            const newSubject = {
                id: Date.now(),
                name: subjectName
            };

            subjects.push(newSubject);
            setSubjects(subjects);

            // Clear input
            document.getElementById('subject-name').value = '';

            showMessage(messageDiv, `Subject ${subjectName} added successfully`, 'success');
            loadCurrentSubjects();
        }

        // Load current students for management
        function loadCurrentStudents() {
            const students = getStudents();
            const container = document.getElementById('current-students');

            if (students.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No students added yet.</p>';
                return;
            }

            let html = '<h4 style="margin-bottom: 15px; color: var(--text-primary);">Current Students</h4>';
            students.forEach((student, index) => {
                html += `
                    <div class="student-item">
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-roll">Roll: ${student.roll}</div>
                        </div>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8em;" 
                                onclick="removeStudent(${index})">
                            🗑️ Remove
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Load current subjects for management
        function loadCurrentSubjects() {
            const subjects = getSubjects();
            const container = document.getElementById('current-subjects');

            if (subjects.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No subjects added yet.</p>';
                return;
            }

            let html = '<h4 style="margin-bottom: 15px; color: var(--text-primary);">Current Subjects</h4>';
            subjects.forEach((subject, index) => {
                html += `
                    <div class="student-item">
                        <div class="student-info">
                            <div class="student-name">${subject.name}</div>
                        </div>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8em;" 
                                onclick="removeSubject(${index})">
                            🗑️ Remove
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Remove student
        function removeStudent(index) {
            if (confirm('Are you sure you want to remove this student?')) {
                const students = getStudents();
                students.splice(index, 1);
                setStudents(students);
                loadCurrentStudents();
                showMessage(document.getElementById('manage-message'), 'Student removed successfully', 'success');
            }
        }

        // Remove subject
        function removeSubject(index) {
            if (confirm('Are you sure you want to remove this subject? This will also remove all attendance records for this subject.')) {
                const subjects = getSubjects();
                const subjectToRemove = subjects[index];
                subjects.splice(index, 1);
                setSubjects(subjects);

                // Remove attendance records for this subject
                const attendance = getAttendance();
                Object.keys(attendance).forEach(key => {
                    if (attendance[key].subjectId == subjectToRemove.id) {
                        delete attendance[key];
                    }
                });
                setAttendance(attendance);

                loadCurrentSubjects();
                showMessage(document.getElementById('manage-message'), 'Subject and related attendance records removed successfully', 'success');
            }
        }

        // Export to PDF
        function exportToPDF() {
            const subjectSelect = document.getElementById('summary-subject');
            const selectedSubjectId = subjectSelect.value;

            if (!selectedSubjectId) {
                alert('Please select a subject first');
                return;
            }

            // Get subject name
            const subjects = getSubjects();
            const selectedSubject = subjects.find(s => s.id == selectedSubjectId);
            const subjectName = selectedSubject ? selectedSubject.name : 'Unknown Subject';

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Title
            doc.setFontSize(20);
            doc.text(`Attendance Report - ${subjectName}`, 20, 30);

            // Date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 45);

            const students = getStudents();
            const attendance = getAttendance();
            const subjectAttendance = Object.values(attendance).filter(record => record.subjectId == selectedSubjectId);

            if (subjectAttendance.length === 0) {
                doc.text('No attendance records found for this subject.', 20, 70);
                doc.save(`${subjectName}_attendance_report.pdf`);
                return;
            }

            // Calculate statistics
            const studentStats = {};
            students.forEach(student => {
                studentStats[student.roll] = {
                    name: student.name,
                    roll: student.roll,
                    present: 0,
                    absent: 0,
                    total: 0
                };
            });

            subjectAttendance.forEach(record => {
                const attendanceRecords = record.records || record.attendance || {};
                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (studentStats[rollNumber]) {
                        studentStats[rollNumber].total++;
                        if (status === 'present') {
                            studentStats[rollNumber].present++;
                        } else {
                            studentStats[rollNumber].absent++;
                        }
                    }
                });
            });

            // Summary section
            doc.setFontSize(14);
            doc.text('Summary:', 20, 70);

            let yPos = 85;
            doc.setFontSize(10);

            // Sort by attendance percentage (lowest first)
            const sortedStats = Object.values(studentStats)
                .filter(stat => stat.total > 0)
                .sort((a, b) => {
                    const percentageA = (a.present / a.total) * 100;
                    const percentageB = (b.present / b.total) * 100;
                    return percentageA - percentageB;
                });

            // Collect all absent students from all classes
            const allAbsentStudents = new Set();
            subjectAttendance.forEach(record => {
                const attendanceRecords = record.records || record.attendance || {};
                Object.entries(attendanceRecords).forEach(([rollNumber, status]) => {
                    if (status === 'absent') {
                        allAbsentStudents.add(rollNumber);
                    }
                });
            });

            // Add absent students section at the top
            if (allAbsentStudents.size > 0) {
                doc.setFontSize(12);
                doc.text('ABSENT STUDENTS (All Classes):', 20, yPos);
                yPos += 10;

                doc.setFontSize(10);
                const absentArray = Array.from(allAbsentStudents).sort();
                let line = '';
                absentArray.forEach((roll, index) => {
                    if (line.length + roll.length > 50) {
                        doc.text(line, 20, yPos);
                        yPos += 8;
                        line = roll;
                    } else {
                        line += (line ? ', ' : '') + roll;
                    }
                });
                if (line) {
                    doc.text(line, 20, yPos);
                    yPos += 15;
                }
            }

            // Student-wise summary
            doc.setFontSize(12);
            doc.text('Student-wise Summary:', 20, yPos);
            yPos += 15;

            doc.setFontSize(9);
            sortedStats.forEach(stat => {
                const percentage = ((stat.present / stat.total) * 100).toFixed(1);
                const text = `${stat.name} (${stat.roll}): ${stat.present}/${stat.total} (${percentage}%)`;

                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.text(text, 20, yPos);
                yPos += 8;
            });

            // Class-wise details
            if (yPos > 200) {
                doc.addPage();
                yPos = 20;
            } else {
                yPos += 10;
            }

            doc.setFontSize(12);
            doc.text('Class-wise Details:', 20, yPos);
            yPos += 15;

            doc.setFontSize(9);
            subjectAttendance.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(record => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }

                const attendanceRecords = record.records || record.attendance || {};
                const totalStudents = Object.keys(attendanceRecords).length;
                const presentStudents = Object.values(attendanceRecords).filter(status => status === 'present').length;
                const percentage = ((presentStudents / totalStudents) * 100).toFixed(1);

                const lectureInfo = record.lectureNumber ? ` - ${record.lectureNumber}${getOrdinalSuffix(record.lectureNumber)} Lecture` : '';
                doc.text(`Date: ${new Date(record.date).toLocaleDateString()}${lectureInfo} - ${presentStudents}/${totalStudents} (${percentage}%)`, 20, yPos);
                yPos += 8;

                // Show absent students for this class
                const absentStudents = Object.entries(attendanceRecords)
                    .filter(([roll, status]) => status === 'absent')
                    .map(([roll, status]) => roll);

                if (absentStudents.length > 0) {
                    doc.text(`Absent: ${absentStudents.join(', ')}`, 25, yPos);
                    yPos += 8;
                }
                yPos += 3;
            });

            doc.save(`${subjectName}_attendance_report.pdf`);
        }

        // Export data as JSON
        function exportData() {
            const data = {
                students: getStudents(),
                subjects: getSubjects(),
                attendance: getAttendance(),
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Import data from JSON
        function importData() {
            document.getElementById('import-file').click();
        }

        // Handle file import
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (confirm('This will replace all current data. Are you sure?')) {
                        if (data.students) setStudents(data.students);
                        if (data.subjects) setSubjects(data.subjects);
                        if (data.attendance) setAttendance(data.attendance);

                        showMessage(document.getElementById('manage-message'), 'Data imported successfully!', 'success');
                        loadCurrentStudents();
                        loadCurrentSubjects();
                    }
                } catch (error) {
                    showMessage(document.getElementById('manage-message'), 'Invalid file format', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Clear functions
        function clearAllAttendance() {
            if (confirm('Are you sure you want to clear all attendance records? This cannot be undone.')) {
                setAttendance({});
                showMessage(document.getElementById('manage-message'), 'All attendance records cleared', 'success');
            }
        }

        function clearAllStudents() {
            if (confirm('Are you sure you want to clear all students? This will also clear all attendance records.')) {
                setStudents([]);
                setAttendance({});
                showMessage(document.getElementById('manage-message'), 'All students and attendance records cleared', 'success');
                loadCurrentStudents();
            }
        }

        function clearAllSubjects() {
            if (confirm('Are you sure you want to clear all subjects? This will also clear all attendance records.')) {
                setSubjects([]);
                setAttendance({});
                showMessage(document.getElementById('manage-message'), 'All subjects and attendance records cleared', 'success');
                loadCurrentSubjects();
            }
        }

        // Show message helper
        function showMessage(element, message, type = 'error') {
            element.textContent = message;
            element.className = `message ${type}`;
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 5000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Tab functionality
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.dataset.tab);
                });
            });

            // Subject selection for attendance
            document.getElementById('subject-select').addEventListener('change', function () {
                loadStudentsForAttendance();
                if (selectedLecture) {
                    const subjectId = this.value;
                    const date = document.getElementById('class-date').value;
                    if (subjectId && date) {
                        updateLectureInfo(subjectId, date, selectedLecture);
                    }
                }
            });

            // Date change for attendance
            document.getElementById('class-date').addEventListener('change', function () {
                if (selectedLecture) {
                    const subjectId = document.getElementById('subject-select').value;
                    const date = this.value;
                    if (subjectId && date) {
                        updateLectureInfo(subjectId, date, selectedLecture);
                    }
                }
            });

            // Lecture selection buttons
            document.getElementById('lecture-1').addEventListener('click', () => selectLecture(1));
            document.getElementById('lecture-2').addEventListener('click', () => selectLecture(2));
            document.getElementById('lecture-3').addEventListener('click', () => selectLecture(3));

            // Subject selection for tracking
            document.getElementById('track-subject').addEventListener('change', showAttendanceSummary);

            // Subject selection for summary
            document.getElementById('summary-subject').addEventListener('change', showStudentSummary);

            // Save attendance button
            document.getElementById('save-attendance').addEventListener('click', saveAttendance);

            // Add student button
            document.getElementById('add-student').addEventListener('click', addStudent);

            // Add subject button
            document.getElementById('add-subject').addEventListener('click', addSubject);

            // Export buttons
            document.getElementById('export-pdf').addEventListener('click', exportToPDF);
            document.getElementById('export-data').addEventListener('click', exportData);

            // Import data
            document.getElementById('import-data').addEventListener('click', importData);
            document.getElementById('backup-data').addEventListener('click', exportData);
            document.getElementById('import-file').addEventListener('change', handleFileImport);

            // Clear buttons
            document.getElementById('clear-attendance').addEventListener('click', clearAllAttendance);
            document.getElementById('clear-students').addEventListener('click', clearAllStudents);
            document.getElementById('clear-subjects').addEventListener('click', clearAllSubjects);

            // Enter key handlers for forms
            document.getElementById('student-name').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') addStudent();
            });

            document.getElementById('student-roll').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') addStudent();
            });

            document.getElementById('subject-name').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') addSubject();
            });

            // Initialize the app
            switchTab('attendance');
        });
    </script>
</body>

</html>