<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Attendance App</title>
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #a5b4fc;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-light: #ffffff;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --radius: 12px;
            --radius-lg: 16px;
            --tab-active: #6366f1;
            --tab-inactive: #9ca3af;
            --tab-bg: #ffffff;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            font-weight: 600;
            font-size: 18px;
        }

        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background: var(--tab-bg);
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.12);
            z-index: 100;
            border-top: 1px solid var(--border-color);
            padding: 12px 8px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            height: calc(80px + env(safe-area-inset-bottom));
            backdrop-filter: blur(20px);
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 60px;
            position: relative;
            border-radius: 12px;
            margin: 0 2px;
            color: var(--tab-inactive);
        }

        .tab::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }

        .tab.active {
            color: var(--text-light);
            font-weight: 600;
            transform: translateY(-2px);
        }

        .tab.active::before {
            opacity: 1;
            width: calc(100% - 4px);
            height: calc(100% - 4px);
        }

        .container {
            padding: 80px 16px 20px 16px;
            padding-bottom: calc(100px + env(safe-area-inset-bottom));
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px 20px 0 0;
            margin-top: 60px;
            box-shadow: var(--shadow-xl);
        }

        .attendance-btns {
            display: flex;
            gap: 16px;
            margin-top: 32px;
        }

        .btn {
            flex: 1;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
            position: relative;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn.present {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }

        .btn.absent {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
        }

        .btn:active {
            transform: scale(0.95);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .lecture-btn,
        .track-lecture-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            font-weight: 600;
            min-height: 48px;
            font-size: 16px;
        }

        .lecture-btn.selected,
        .track-lecture-btn.selected {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-color: var(--primary-color);
            box-shadow: var(--shadow);
        }

        .input,
        select {
            width: 100%;
            padding: 16px 20px;
            margin: 8px 0;
            border-radius: var(--radius);
            border: 2px solid var(--border-color);
            font-size: 16px;
            font-family: inherit;
            background: var(--bg-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 52px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .list {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin: 20px 0;
            overflow: hidden;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            min-height: 64px;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:active {
            background: var(--bg-primary);
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .action-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 44px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.delete {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .summary-table th,
        .summary-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            font-size: 14px;
        }

        .summary-table th {
            background: var(--bg-primary);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-table tr:last-child td {
            border-bottom: none;
        }

        .top-bar {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 20px 16px;
            padding-top: calc(20px + env(safe-area-inset-top));
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 99;
            box-shadow: var(--shadow);
        }

        .auth-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin: 20px 0;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .hidden {
            display: none;
        }

        /* Tecno Camon 40 Specific Optimizations */
        @media screen and (min-width: 393px) and (max-width: 430px) {
            .container {
                max-width: 100%;
                padding: 16px 20px;
            }

            .btn {
                padding: 18px;
                font-size: 17px;
                min-height: 54px;
            }

            .tab {
                font-size: 12px;
                padding: 6px 2px;
            }

            .input,
            select {
                padding: 14px 16px;
                font-size: 16px;
            }
        }

        /* Enhanced touch targets for mobile */
        @media (max-width: 768px) {

            .btn,
            .action-btn,
            .input,
            select,
            .tab {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
            }

            .lecture-btn,
            .track-lecture-btn {
                min-height: 44px;
                font-size: 15px;
            }

            .list-item {
                min-height: 60px;
                padding: 14px 18px;
            }

            .attendance-btns {
                gap: 12px;
                margin-top: 24px;
            }

            .top-bar {
                font-size: 18px;
                padding: 16px;
                padding-top: calc(16px + env(safe-area-inset-top));
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #0f172a;
                --bg-secondary: #1e293b;
                --text-primary: #f8fafc;
                --text-secondary: #94a3b8;
                --border-color: #334155;
            }
        }

        /* Gesture and scroll optimizations */
        .container {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* Better focus states for accessibility */
        .btn:focus-visible,
        .action-btn:focus-visible,
        .input:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
    </style>
</head>

<body>
    <div class="top-bar">
        Attendance App
    </div>
    <div class="container">
        <!-- Take Attendance Tab -->
        <div id="tab-attendance" class="tab-content">
            <div style="margin-bottom: 20px;">
                <select id="attendance-subject" class="input">
                    <option value="">Select Subject</option>
                </select>
                <input type="date" id="attendance-date" class="input">
            </div>

            <!-- Lecture Selection -->
            <div style="margin-bottom: 20px;">
                <div style="font-size: 16px; font-weight: 500; margin-bottom: 10px; color: #333;">Select Lecture:</div>
                <div class="lecture-selection" style="display: flex; gap: 8px;">
                    <button class="btn lecture-btn" id="lecture-1" data-lecture="1"
                        style="flex: 1; background: #e0e0e0; color: #333;">
                        1st Lecture
                    </button>
                    <button class="btn lecture-btn" id="lecture-2" data-lecture="2"
                        style="flex: 1; background: #e0e0e0; color: #333;">
                        2nd Lecture
                    </button>
                    <button class="btn lecture-btn" id="lecture-3" data-lecture="3"
                        style="flex: 1; background: #e0e0e0; color: #333;">
                        3rd Lecture
                    </button>
                </div>
                <div id="lecture-info" style="margin-top: 10px; font-size: 14px; color: #666; text-align: center;">
                    Select lecture number first
                </div>
            </div>

            <div id="attendance-student-card"
                style="text-align: center; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); padding: 32px; border-radius: 20px; margin: 20px 0; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2);">
                <div id="student-info" style="margin-bottom: 24px;">
                    <div style="font-size: 28px; font-weight: 700; color: var(--primary-color);" id="student-roll">Roll:
                        -</div>
                    <div style="font-size: 20px; color: var(--text-secondary); margin-top: 4px;" id="student-name">Name:
                        -</div>
                </div>
                <div class="attendance-btns">
                    <button class="btn" id="start-attendance"
                        style="background: #2196f3; margin-bottom: 16px; display: block; width: 100%;">
                        üöÄ Start Attendance
                    </button>
                    <button class="btn present" id="mark-present" style="display: none;">Present</button>
                    <button class="btn absent" id="mark-absent" style="display: none;">Absent</button>
                </div>
                <div style="margin-top: 20px;">
                    <button class="action-btn" id="finish-attendance"
                        style="display: none; background: #43a047; font-size: 16px; padding: 12px 24px;">
                        ‚úì Done - Sync Data
                    </button>
                </div>
            </div>
            <div style="text-align: center; color: #666;">
                <div id="attendance-progress">Select subject and date to start</div>
            </div>
        </div>

        <!-- Track/Edit Attendance Tab -->
        <div id="tab-track" class="tab-content hidden">
            <div style="margin-bottom: 20px;">
                <select id="track-subject" class="input">
                    <option value="">Select Subject</option>
                </select>
                <input type="date" id="track-date" class="input">

                <!-- Lecture Selection for Track Tab -->
                <div style="margin-top: 10px;">
                    <div style="font-size: 14px; margin-bottom: 8px; color: #333;">Lecture:</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn track-lecture-btn" id="track-lecture-1" data-lecture="1"
                            style="flex: 1; background: #e0e0e0; color: #333; font-size: 14px; padding: 8px;">
                            1st
                        </button>
                        <button class="btn track-lecture-btn" id="track-lecture-2" data-lecture="2"
                            style="flex: 1; background: #e0e0e0; color: #333; font-size: 14px; padding: 8px;">
                            2nd
                        </button>
                        <button class="btn track-lecture-btn" id="track-lecture-3" data-lecture="3"
                            style="flex: 1; background: #e0e0e0; color: #333; font-size: 14px; padding: 8px;">
                            3rd
                        </button>
                    </div>
                </div>

                <button class="action-btn" id="load-attendance" style="margin-top: 10px;">Load Attendance</button>
            </div>
            <div id="track-list"></div>
        </div>

        <!-- Summary Tab -->
        <div id="tab-summary" class="tab-content hidden">
            <div style="margin-bottom: 20px;">
                <select id="summary-type" class="input">
                    <option value="student">Student-wise Summary</option>
                    <option value="subject">Subject-wise Summary</option>
                    <option value="specific-student">Specific Student Summary</option>
                </select>

                <!-- Specific Student Search -->
                <div id="specific-student-section" class="hidden"
                    style="margin: 8px 0; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                    <input type="text" id="student-roll-search" class="input"
                        placeholder="Enter roll number (e.g., 2024-CS-001)" style="margin-bottom: 8px;">
                    <button class="action-btn" onclick="generateSpecificStudentSummary()" style="background: #2196f3;">
                        üîç Search Student
                    </button>
                </div>

                <select id="summary-subject" class="input">
                    <option value="">All Subjects</option>
                </select>
                <div style="display: flex; gap: 8px; margin: 8px 0;">
                    <input type="date" id="summary-date-from" class="input" placeholder="From Date (Optional)"
                        style="flex: 1;">
                    <input type="date" id="summary-date-to" class="input" placeholder="To Date (Optional)"
                        style="flex: 1;">
                </div>
                <button class="action-btn" id="generate-summary">Generate Summary</button>
                <button class="action-btn" id="download-pdf" style="background: #e91e63;">Download PDF</button>
            </div>
            <div id="summary-content"></div>
        </div>

        <!-- Manage Tab -->
        <div id="tab-manage" class="tab-content hidden">
            <!-- Data Management -->
            <div style="margin-bottom:16px; border-bottom: 1px solid #eee; padding-bottom: 16px;">
                <h3>Data Management</h3>
                <button class="action-btn" id="backup-btn">Backup Data</button>
                <input type="file" id="import-file" accept="application/json" style="display:none">
                <button class="action-btn" id="import-btn">Import Data</button>
                <button class="action-btn delete" id="delete-all-btn">Delete All Records</button>
            </div>
            <div id="manage-message" style="color:#e53935;font-weight:500;margin-bottom:16px;"></div>

            <!-- Students Management -->
            <div style="margin-bottom: 24px;">
                <h3>Students</h3>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <input type="text" id="new-student-roll" placeholder="Roll Number" class="input" style="flex: 1;">
                    <input type="text" id="new-student-name" placeholder="Student Name" class="input" style="flex: 2;">
                    <button class="action-btn" id="add-student">Add</button>
                </div>
                <div id="students-list" class="list"></div>

                <!-- Bulk Import Students -->
                <div
                    style="margin-top: 16px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <h4 style="margin: 0 0 12px 0; color: #2196f3;">üìã Bulk Import Students</h4>
                    <p style="margin: 0 0 12px 0; font-size: 14px; color: #666;">
                        Copy and paste data from Excel. Format: Roll Number, Student Name (one per line)
                    </p>
                    <textarea id="bulk-student-data"
                        placeholder="Example:&#10;2024-CS-001, John Doe&#10;2024-CS-002, Jane Smith&#10;2024-CS-003, Ali Khan"
                        class="input" style="min-height: 120px; font-family: monospace; font-size: 14px;"></textarea>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="action-btn" onclick="importStudents()">üì• Import Students</button>
                        <button class="action-btn" onclick="clearBulkData()" style="background: #999;">Clear</button>
                    </div>
                    <div id="import-status" style="margin-top: 8px; font-size: 14px;"></div>
                </div>
            </div>

            <!-- Subjects Management -->
            <div>
                <h3>Subjects</h3>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <input type="text" id="subject-name" placeholder="Subject Name" class="input" style="flex: 1;">
                    <button class="action-btn" id="add-subject">Add</button>
                </div>
                <div id="subjects-list" class="list"></div>
            </div>

            <!-- Data Management -->
            <div style="margin-top: 32px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                <h3 style="color: #e53935;">‚ö†Ô∏è Data Management</h3>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn" id="clear-attendance" style="background: #ff9800; color: white;">
                        üóëÔ∏è Clear All Attendance
                    </button>
                    <button class="btn" id="clear-all-data" style="background: #e53935; color: white;">
                        üí• Clear Everything
                    </button>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 8px;">
                    ‚ö†Ô∏è Warning: These actions cannot be undone. Export data first if needed.
                </div>
            </div>
        </div>
    </div>
    <div class="tab-bar">
        <div class="tab active" data-tab="attendance">
            <span class="tab-icon">üìù</span>
            <span class="tab-label">Take</span>
        </div>
        <div class="tab" data-tab="track">
            <span class="tab-icon">üìä</span>
            <span class="tab-label">Track</span>
        </div>
        <div class="tab" data-tab="summary">
            <span class="tab-icon">üìã</span>
            <span class="tab-label">Summary</span>
        </div>
        <div class="tab" data-tab="manage">
            <span class="tab-icon">‚öôÔ∏è</span>
            <span class="tab-label">Manage</span>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Data storage utilities

        function getStudents() {
            return JSON.parse(localStorage.getItem('students') || '[]');
        }

        // Generate a simple sync code using current timestamp
        function generateSyncCode() {
            try {
                updateSyncStatus('syncing', 'Creating sync code...');

                // Generate a simple unique code
                const timestamp = Date.now();
                const randomNum = Math.floor(Math.random() * 10000);
                syncCode = `att_${timestamp}_${randomNum}`;

                localStorage.setItem('syncCode', syncCode);
                isConnected = true;
                updateSyncUI();

                // Try to save initial data to cloud
                syncToCloud().then(() => {
                    updateSyncStatus('online');
                    showMessage('Sync code generated successfully! Share this code with other devices.', 'success');
                }).catch(() => {
                    // Even if cloud fails, we have a local sync code
                    updateSyncStatus('offline');
                    showMessage('Sync code generated! Note: Cloud sync may be limited. Use backup/import for reliable sync.', 'warning');
                });

            } catch (error) {
                console.error('Error generating sync code:', error);
                updateSyncStatus('error');
                showMessage('Failed to generate sync code. Try again.', 'error');
            }
        }

        // Connect to existing sync code
        function connectToSync() {
            const inputCode = document.getElementById('sync-code').value.trim();
            if (!inputCode) {
                showMessage('Please enter a sync code', 'error');
                return;
            }

            try {
                updateSyncStatus('syncing', 'Connecting...');

                syncCode = inputCode;
                localStorage.setItem('syncCode', syncCode);
                isConnected = true;
                updateSyncUI();

                // Try to load data from cloud
                loadFromCloud().then(() => {
                    updateSyncStatus('online');
                    showMessage('Connected! Data synced successfully.', 'success');
                }).catch(() => {
                    updateSyncStatus('offline');
                    showMessage('Connected with sync code. Cloud sync may be limited. Use backup/import for reliable sync.', 'warning');
                });

                // Refresh current tab
                const activeTab = document.querySelector('.tab.active')?.dataset.tab;
                if (activeTab === 'manage') loadManageTab();

            } catch (error) {
                console.error('Error connecting to sync:', error);
                updateSyncStatus('error');
                showMessage('Failed to connect. Check your sync code.', 'error');
            }
        }

        // Sync data to cloud (with fallback)
        async function syncToCloud() {
            if (!isConnected || !syncCode) return Promise.reject('Not connected');

            try {
                updateSyncStatus('syncing');

                const data = getAllAppData();

                // Try multiple free services for backup
                const services = [
                    // Service 1: JSONBin.io
                    () => fetch('https://api.jsonbin.io/v3/b', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ syncCode, data, timestamp: Date.now() })
                    }),
                    // Service 2: HTTPBin (for testing)
                    () => fetch('https://httpbin.org/post', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ syncCode, data, timestamp: Date.now() })
                    })
                ];

                // Try first service (suppress blocked request errors)
                try {
                    const response = await services[0]();
                    if (response.ok) {
                        updateSyncStatus('online');
                        return Promise.resolve();
                    }
                } catch (e) {
                    // Silently handle blocked requests - this is normal
                    // Browser extensions/ad blockers often block external tracking
                }

                // If cloud fails, still mark as "synced" locally
                updateSyncStatus('offline');
                return Promise.reject('Cloud sync unavailable');

            } catch (error) {
                // Suppress external service errors in console
                updateSyncStatus('error');
                return Promise.reject(error);
            }
        }

        // Load data from cloud (with fallback)
        async function loadFromCloud() {
            if (!isConnected || !syncCode) return Promise.reject('Not connected');

            try {
                updateSyncStatus('syncing');

                // For now, we'll rely on manual backup/import for cross-device sync
                // This ensures the app works reliably without depending on external services

                updateSyncStatus('offline');
                return Promise.reject('Using local storage only');

            } catch (error) {
                console.error('Error loading from cloud:', error);
                updateSyncStatus('error');
                return Promise.reject(error);
            }
        }

        // Disconnect from sync
        function disconnectSync() {
            if (confirm('Disconnect from sync? Local data will remain.')) {
                syncCode = null;
                localStorage.removeItem('syncCode');
                isConnected = false;
                updateSyncUI();
                updateSyncStatus('offline');
                showMessage('Disconnected from sync', 'success');
            }
        }        // Update sync UI
        function updateSyncUI() {
            const syncInfo = document.getElementById('sync-info');
            const currentSyncCode = document.getElementById('current-sync-code');

            if (isConnected && syncCode) {
                syncInfo.classList.remove('hidden');
                currentSyncCode.textContent = syncCode;
                document.getElementById('sync-code').value = '';
            } else {
                syncInfo.classList.add('hidden');
            }
        }

        // Show message to user
        function showMessage(message, type = 'error') {
            const manageMsg = document.getElementById('manage-message');
            if (!manageMsg) return;

            manageMsg.textContent = message;
            if (type === 'success') {
                manageMsg.style.color = '#43a047';
            } else if (type === 'warning') {
                manageMsg.style.color = '#f57c00';
            } else {
                manageMsg.style.color = '#e53935';
            }
            setTimeout(() => manageMsg.textContent = '', 6000);
        }

        // Auto-sync when data changes (removed - now manual only)
        function autoSync() {
            // No auto-sync - manual sync only via "Done" button
        }        // Data storage utilities (modified for manual sync)
        function getStudents() {
            return JSON.parse(localStorage.getItem('students') || '[]');
        }

        function setStudents(students) {
            localStorage.setItem('students', JSON.stringify(students));
            // No auto-sync for students/subjects management
        }

        function getSubjects() {
            return JSON.parse(localStorage.getItem('subjects') || '[]');
        }

        function setSubjects(subjects) {
            localStorage.setItem('subjects', JSON.stringify(subjects));
            // No auto-sync for students/subjects management
        }

        function getAttendance() {
            return JSON.parse(localStorage.getItem('attendance') || '{}');
        }

        function setAttendance(attendance) {
            localStorage.setItem('attendance', JSON.stringify(attendance));
            // No auto-sync for attendance - manual sync only
        }

        // Helper function to get attendance as array for existing functions
        function getAttendanceArray() {
            const attendanceObj = getAttendance();
            return Object.values(attendanceObj);
        }

        // Helper function to find subject by ID (handles type conversion)
        function findSubjectById(subjects, subjectId) {
            return subjects.find(s => String(s.id) === String(subjectId));
        }

        // Manual sync function for "Done" button
        function finishAndSync() {
            // Always complete the attendance session first
            resetAttendanceSession();

            // Try to sync only if connected, but don't show errors for failed sync
            if (isConnected) {
                updateSyncStatus('syncing', 'Syncing attendance...');
                syncToCloud().then(() => {
                    updateSyncStatus('online', 'Data saved locally and synced');
                }).catch(() => {
                    updateSyncStatus('offline', 'Data saved locally (sync unavailable)');
                });
            } else {
                updateSyncStatus('offline', 'Data saved locally');
            }
        }

        function resetAttendanceSession() {
            currentAttendanceSession = null;
            currentStudentIndex = 0;
            selectedLecture = null;

            document.getElementById('finish-attendance').style.display = 'none';
            document.getElementById('start-attendance').style.display = 'block';
            document.getElementById('mark-present').style.display = 'none';
            document.getElementById('mark-absent').style.display = 'none';
            document.getElementById('student-roll').textContent = 'Roll: -';
            document.getElementById('student-name').textContent = 'Name: -';
            document.getElementById('attendance-progress').textContent = 'Ready to take attendance';

            // Reset lecture selection
            document.querySelectorAll('.lecture-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById('lecture-info').textContent = 'Select lecture number first';
            document.getElementById('lecture-info').style.color = '#666';
        }

        // Global variables
        let currentStudentIndex = 0;
        let currentAttendanceSession = null;
        let selectedLecture = null;
        let selectedTrackLecture = null;

        // Tab management
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Load tab-specific data
            if (tabName === 'attendance') loadAttendanceTab();
            if (tabName === 'track') loadTrackTab();
            if (tabName === 'summary') loadSummaryTab();
            if (tabName === 'manage') loadManageTab();
        }

        // Attendance Tab Functions
        function loadAttendanceTab() {
            loadSubjectOptions('attendance-subject');
            document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
            resetAttendanceSession(); // Initialize the UI properly
        }

        function loadSubjectOptions(selectId) {
            const select = document.getElementById(selectId);
            const subjects = getSubjects();

            select.innerHTML = '<option value="">Select Subject</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                select.appendChild(option);
            });
        }        // Lecture selection function
        function selectLecture(lectureNumber) {
            selectedLecture = lectureNumber;

            // Update UI - remove selected class from all buttons
            document.querySelectorAll('.lecture-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Add selected class to clicked button
            document.getElementById(`lecture-${lectureNumber}`).classList.add('selected');

            // Update lecture info
            const subjectId = document.getElementById('attendance-subject').value;
            const date = document.getElementById('attendance-date').value;

            if (subjectId && date) {
                updateLectureInfo(subjectId, date, lectureNumber);
            } else {
                document.getElementById('lecture-info').textContent = `${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture selected`;
            }
        }

        // Helper function for ordinal numbers (1st, 2nd, 3rd)
        function getOrdinalSuffix(number) {
            const lastDigit = number % 10;
            const lastTwoDigits = number % 100;

            if (lastTwoDigits >= 11 && lastTwoDigits <= 13) {
                return 'th';
            }

            switch (lastDigit) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        // Function to update lecture info and check for existing attendance
        function updateLectureInfo(subjectId, date, lectureNumber) {
            const subjects = getSubjects();
            const subject = findSubjectById(subjects, subjectId);

            const subjectName = subject ? subject.name : 'Unknown';            // Calculate total lecture count for this subject (semester total)
            const attendance = getAttendance();
            let totalSemesterLectures = 0;

            // Count all lectures for this subject across all dates (semester total)
            Object.keys(attendance).forEach(key => {
                const [sessionDate, sessionSubjectId, sessionLecture] = key.split('_');
                if (sessionSubjectId === subjectId && sessionDate < date) {
                    totalSemesterLectures++;
                }
            });

            // Count lectures on this specific date (to show which lecture of the day this will be)
            let lecturesThisDay = 0;
            Object.keys(attendance).forEach(key => {
                const [sessionDate, sessionSubjectId, sessionLecture] = key.split('_');
                if (sessionSubjectId === subjectId && sessionDate === date && parseInt(sessionLecture) < lectureNumber) {
                    lecturesThisDay++;
                }
            });

            // Check if this specific lecture already exists
            const key = `${date}_${subjectId}_${lectureNumber}`;
            const exists = attendance[key];

            let infoText = `${subjectName} - ${lectureNumber}${getOrdinalSuffix(lectureNumber)} lecture of the day`;

            // Show semester count if there are previous lectures
            const upcomingSemesterLecture = totalSemesterLectures + lecturesThisDay + 1;
            if (totalSemesterLectures > 0 || lecturesThisDay > 0) {
                infoText += ` (${upcomingSemesterLecture}${getOrdinalSuffix(upcomingSemesterLecture)} lecture this semester)`;
            }

            if (exists) {
                infoText += ' ‚ö†Ô∏è Already taken';
                document.getElementById('lecture-info').style.color = '#e53935';
            } else {
                document.getElementById('lecture-info').style.color = '#43a047';
            }

            document.getElementById('lecture-info').textContent = infoText;
        }

        function startAttendance() {
            const subjectId = document.getElementById('attendance-subject').value;
            const date = document.getElementById('attendance-date').value;

            if (!subjectId || !date) {
                alert('Please select subject and date');
                return;
            }

            if (!selectedLecture) {
                alert('Please select lecture number (1st, 2nd, or 3rd)');
                return;
            }

            const students = getStudents();
            if (students.length === 0) {
                alert('No students found. Add students first.');
                return;
            }

            // Check if attendance already exists for this date, subject, and lecture
            const existingAttendance = getAttendance();
            const key = `${date}_${subjectId}_${selectedLecture}`;

            if (existingAttendance[key]) {
                if (!confirm(`Attendance already exists for ${selectedLecture}${getOrdinalSuffix(selectedLecture)} lecture of this subject on this date. Do you want to overwrite it?`)) {
                    return;
                }
            }

            currentAttendanceSession = {
                subjectId: subjectId,
                date: date,
                lectureNumber: selectedLecture,
                records: []
            };
            currentStudentIndex = 0;

            // Hide start button and show attendance buttons
            document.getElementById('start-attendance').style.display = 'none';
            document.getElementById('mark-present').style.display = 'inline-block';
            document.getElementById('mark-absent').style.display = 'inline-block';

            showCurrentStudent();
        }

        function showCurrentStudent() {
            const students = getStudents();
            if (currentStudentIndex >= students.length) {
                finishAttendance();
                return;
            }

            const student = students[currentStudentIndex];
            document.getElementById('student-roll').textContent = `Roll: ${student.roll}`;
            document.getElementById('student-name').textContent = `Name: ${student.name}`;
            document.getElementById('attendance-progress').textContent =
                `Student ${currentStudentIndex + 1} of ${students.length}`;
        }

        function markAttendance(status) {
            if (!currentAttendanceSession) {
                alert('Please click "Start Attendance" first');
                return;
            }

            const students = getStudents();
            const student = students[currentStudentIndex];

            currentAttendanceSession.records.push({
                studentId: student.id,
                roll: student.roll,
                name: student.name,
                status: status
            });

            currentStudentIndex++;
            showCurrentStudent();
        }

        function finishAttendance() {
            const attendance = getAttendance();
            const key = `${currentAttendanceSession.date}_${currentAttendanceSession.subjectId}_${currentAttendanceSession.lectureNumber}`;

            // Store attendance with unique key (date_subject_lecture) to prevent duplicates
            attendance[key] = {
                id: Date.now(),
                subjectId: currentAttendanceSession.subjectId,
                date: currentAttendanceSession.date,
                lectureNumber: currentAttendanceSession.lectureNumber,
                records: currentAttendanceSession.records
            };
            setAttendance(attendance);

            // Show Done button
            document.getElementById('finish-attendance').style.display = 'block';
            document.getElementById('student-roll').textContent = 'Attendance Complete!';
            document.getElementById('student-name').textContent = 'Click "Done" to sync data';
            document.getElementById('attendance-progress').textContent = 'All students marked';
        }

        // Track lecture selection function
        function selectTrackLecture(lectureNumber) {
            selectedTrackLecture = lectureNumber;

            // Update UI - remove selected class from all track lecture buttons
            document.querySelectorAll('.track-lecture-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Add selected class to clicked button
            document.getElementById(`track-lecture-${lectureNumber}`).classList.add('selected');
        }

        // Track Tab Functions
        function loadTrackTab() {
            loadSubjectOptions('track-subject');

            // Debug logging to help identify "Unknown" subject issues
            const subjects = getSubjects();
            const attendance = getAttendanceArray();

            console.log('Debug - Subjects:', subjects);
            console.log('Debug - Subjects count:', subjects.length);
            console.log('Debug - Attendance sessions:', attendance.length);

            // Check for orphaned subject IDs in attendance
            const subjectIds = subjects.map(s => s.id);
            const attendanceSubjectIds = [...new Set(attendance.map(a => a.subjectId))];
            const orphanedIds = attendanceSubjectIds.filter(id => !subjectIds.includes(id));

            if (orphanedIds.length > 0) {
                console.warn('Found orphaned subject IDs in attendance:', orphanedIds);
                console.log('Available subject IDs:', subjectIds);
            }
        }

        function loadAttendanceForEdit() {
            const subjectId = document.getElementById('track-subject').value;
            const date = document.getElementById('track-date').value;

            if (!subjectId || !date) {
                alert('Please select subject and date');
                return;
            }

            if (!selectedTrackLecture) {
                alert('Please select lecture number (1st, 2nd, or 3rd)');
                return;
            }

            const attendance = getAttendance();
            const key = `${date}_${subjectId}_${selectedTrackLecture}`;
            const session = attendance[key];

            const trackList = document.getElementById('track-list');
            trackList.innerHTML = '';

            if (!session) {
                trackList.innerHTML = '<div style="text-align:center;color:#666;">No attendance found for this date.</div>';
                return;
            }

            session.records.forEach((record, index) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div>
                        <strong>${record.roll}</strong> - ${record.name}
                    </div>
                    <div class="actions">
                        <button class="btn ${record.status === 'present' ? 'present' : 'absent'}" 
                                onclick="toggleAttendance('${key}', ${index})"
                                style="min-width: 80px;">
                            ${record.status === 'present' ? '‚úì Present' : '‚úó Absent'}
                        </button>
                    </div>
                `;
                trackList.appendChild(item);
            });
        }

        function toggleAttendance(attendanceKey, recordIndex) {
            const attendance = getAttendance();
            const session = attendance[attendanceKey];

            if (session && session.records[recordIndex]) {
                const record = session.records[recordIndex];
                record.status = record.status === 'present' ? 'absent' : 'present';

                // Update the attendance
                attendance[attendanceKey] = session;
                setAttendance(attendance);

                // Reload the display
                loadAttendanceForEdit();
            }
        }

        // Summary Tab Functions
        function loadSummaryTab() {
            loadSubjectOptions('summary-subject');
        }

        function generateSummary() {
            const type = document.getElementById('summary-type').value;
            const subjectFilter = document.getElementById('summary-subject').value;
            const dateFrom = document.getElementById('summary-date-from').value;
            const dateTo = document.getElementById('summary-date-to').value;

            const students = getStudents();
            const subjects = getSubjects();
            let attendance = getAttendanceArray(); // Use array version

            // Apply filters
            if (subjectFilter) {
                attendance = attendance.filter(a => a.subjectId === subjectFilter);
            }

            if (dateFrom) {
                attendance = attendance.filter(a => a.date >= dateFrom);
            }

            if (dateTo) {
                attendance = attendance.filter(a => a.date <= dateTo);
            }

            const summaryContent = document.getElementById('summary-content');

            if (type === 'student') {
                generateStudentSummary(students, subjects, attendance, summaryContent);
            } else {
                generateSubjectSummary(students, subjects, attendance, summaryContent);
            }
        }

        function generateStudentSummary(students, subjects, attendance, container) {
            // Debug: Let's check what data we have
            console.log('Debug - Students:', students);
            console.log('Debug - Subjects:', subjects);
            console.log('Debug - Attendance:', attendance);

            let html = '<div class="student-summary">';

            // Sort students by roll number
            const sortedStudents = [...students].sort((a, b) => a.roll.localeCompare(b.roll));

            sortedStudents.forEach(student => {
                html += `<div class="student-section" style="margin-bottom: 32px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px;">`;
                html += `<h3 style="margin: 0 0 16px 0; color: #2196f3;">${student.roll} - ${student.name}</h3>`;

                // Group attendance by subject
                const subjectAttendance = {};
                let totalPresent = 0, totalAbsent = 0;

                attendance.forEach(session => {
                    const record = session.records.find(r => r.studentId === student.id);
                    if (record) {
                        const subjectId = session.subjectId;
                        if (!subjectAttendance[subjectId]) {
                            subjectAttendance[subjectId] = { present: 0, absent: 0, sessions: [] };
                        }

                        if (record.status === 'present') {
                            subjectAttendance[subjectId].present++;
                            totalPresent++;
                        } else {
                            subjectAttendance[subjectId].absent++;
                            totalAbsent++;
                        }

                        subjectAttendance[subjectId].sessions.push({
                            date: session.date,
                            lecture: session.lectureNumber || 1,
                            status: record.status
                        });
                    }
                });

                // Overall statistics
                const totalSessions = totalPresent + totalAbsent;
                const overallPercentage = totalSessions > 0 ? ((totalPresent / totalSessions) * 100).toFixed(1) : 0;

                html += `<div style="background: #f5f5f5; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                    <strong>Overall: </strong>
                    Present: ${totalPresent} | Absent: ${totalAbsent} | Total: ${totalSessions} | Attendance: ${overallPercentage}%
                </div>`;

                // Subject-wise breakdown
                if (Object.keys(subjectAttendance).length > 0) {
                    html += `<table class="summary-table" style="width: 100%; margin-bottom: 16px;">
                        <thead>
                            <tr><th>Subject</th><th>Present</th><th>Absent</th><th>Total</th><th>%</th></tr>
                        </thead>
                        <tbody>`;

                    Object.keys(subjectAttendance).forEach(subjectId => {
                        const subject = findSubjectById(subjects, subjectId);
                        const subjectName = subject ? subject.name : `Unknown (ID: ${subjectId})`;
                        const data = subjectAttendance[subjectId];
                        const total = data.present + data.absent;
                        const percentage = total > 0 ? ((data.present / total) * 100).toFixed(1) : 0;

                        html += `<tr>
                            <td><strong>${subjectName}</strong></td>
                            <td>${data.present}</td>
                            <td>${data.absent}</td>
                            <td>${total}</td>
                            <td>${percentage}%</td>
                        </tr>`;
                    });

                    html += `</tbody></table>`;

                    // Detailed session list for each subject
                    Object.keys(subjectAttendance).forEach(subjectId => {
                        const subject = findSubjectById(subjects, subjectId);
                        const subjectName = subject ? subject.name : `Unknown (ID: ${subjectId})`;
                        const data = subjectAttendance[subjectId];

                        html += `<div style="margin-bottom: 16px;">
                            <h4 style="margin: 8px 0; color: #333;">${subjectName} - Session Details:</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">`;

                        data.sessions.sort((a, b) => a.date.localeCompare(b.date)).forEach(session => {
                            const statusColor = session.status === 'present' ? '#43a047' : '#e53935';
                            const statusIcon = session.status === 'present' ? '‚úì' : '‚úó';

                            html += `<span style="
                                background: ${statusColor}; 
                                color: white; 
                                padding: 4px 8px; 
                                border-radius: 4px; 
                                font-size: 12px;
                                white-space: nowrap;
                            ">
                                ${statusIcon} ${session.date} (L${session.lecture})
                            </span>`;
                        });

                        html += `</div></div>`;
                    });
                } else {
                    html += `<div style="text-align: center; color: #666; font-style: italic;">No attendance records found</div>`;
                }

                html += `</div>`;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function generateSubjectSummary(students, subjects, attendance, container) {
            let html = '<div class="subject-summary">';

            attendance.forEach(session => {
                const subject = findSubjectById(subjects, session.subjectId);
                const subjectName = subject ? subject.name : `Unknown (ID: ${session.subjectId})`;

                const presentStudents = [];
                const absentStudents = [];

                session.records.forEach(record => {
                    const student = students.find(s => s.id === record.studentId);
                    if (student) {
                        if (record.status === 'present') {
                            presentStudents.push(student);
                        } else {
                            absentStudents.push(student);
                        }
                    }
                });

                const total = presentStudents.length + absentStudents.length;
                const attendanceRate = total > 0 ? ((presentStudents.length / total) * 100).toFixed(1) : 0;
                const lectureInfo = session.lectureNumber ? `${session.lectureNumber}${getOrdinalSuffix(session.lectureNumber)} Lecture` : 'Lecture';

                // Session card
                html += `
                    <div style="background: white; border-radius: 8px; padding: 20px; margin: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${attendanceRate >= 80 ? '#4caf50' : attendanceRate >= 60 ? '#ff9800' : '#f44336'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0; color: #2196f3;">${session.date} - ${subjectName}</h3>
                            <span style="background: ${attendanceRate >= 80 ? '#4caf50' : attendanceRate >= 60 ? '#ff9800' : '#f44336'}; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold;">${attendanceRate}%</span>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <strong>${lectureInfo}</strong> | Present: <span style="color: #4caf50;">${presentStudents.length}</span> | Absent: <span style="color: #f44336;">${absentStudents.length}</span> | Total: ${total}
                        </div>`;

                // Show absent students prominently
                if (absentStudents.length > 0) {
                    html += `
                        <div style="background: #ffebee; border: 1px solid #ffcdd2; border-radius: 4px; padding: 12px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; color: #f44336;">üö® Absent Students (${absentStudents.length}):</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">`;

                    absentStudents.sort((a, b) => a.roll.localeCompare(b.roll)).forEach(student => {
                        html += `<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">${student.roll}</span>`;
                    });

                    html += `
                            </div>
                        </div>`;
                } else {
                    html += `
                        <div style="background: #e8f5e8; border: 1px solid #c8e6c9; border-radius: 4px; padding: 12px; margin-bottom: 12px;">
                            <h4 style="margin: 0; color: #4caf50;">‚úÖ Perfect Attendance - No Absents!</h4>
                        </div>`;
                }

                // Show present students (condensed)
                if (presentStudents.length > 0) {
                    const presentRolls = presentStudents.sort((a, b) => a.roll.localeCompare(b.roll)).map(s => s.roll).join(', ');
                    html += `
                        <div style="background: #f1f8e9; border: 1px solid #dcedc8; border-radius: 4px; padding: 12px;">
                            <h4 style="margin: 0 0 8px 0; color: #4caf50;">Present Students (${presentStudents.length}):</h4>
                            <div style="font-size: 12px; color: #666; line-height: 1.4;">${presentRolls}</div>
                        </div>`;
                }

                html += `</div>`;
            });

            html += '</div>';
            container.innerHTML = html;
        } function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const type = document.getElementById('summary-type').value;
            const subjectFilter = document.getElementById('summary-subject').value;
            const dateFrom = document.getElementById('summary-date-from').value;
            const dateTo = document.getElementById('summary-date-to').value;

            const students = getStudents();
            const subjects = getSubjects();
            let attendance = getAttendanceArray();

            // Apply filters
            if (subjectFilter) {
                attendance = attendance.filter(a => a.subjectId === subjectFilter);
            }
            if (dateFrom) {
                attendance = attendance.filter(a => a.date >= dateFrom);
            }
            if (dateTo) {
                attendance = attendance.filter(a => a.date <= dateTo);
            }

            if (type === 'student') {
                generateStudentPDF(doc, students, subjects, attendance, subjectFilter);
            } else if (type === 'specific-student') {
                generateSpecificStudentPDF(doc, students, subjects, attendance);
            } else {
                generateSubjectPDF(doc, students, subjects, attendance, subjectFilter);
            }

            // Save the PDF
            const timestamp = new Date().toISOString().slice(0, 10);
            let fileName = '';
            if (type === 'student') {
                fileName = `Student_Attendance_Report_${timestamp}.pdf`;
            } else if (type === 'specific-student') {
                const rollNumber = document.getElementById('student-roll-search').value.trim();
                fileName = `${rollNumber}_Attendance_Report_${timestamp}.pdf`;
            } else {
                fileName = `Subject_Attendance_Report_${timestamp}.pdf`;
            }

            doc.save(fileName);
        }

        function addPDFHeader(doc, title, subtitle = '', pageNum = 1, totalPages = 1) {
            // Header background
            doc.setFillColor(33, 150, 243); // Blue background
            doc.rect(0, 0, 210, 25, 'F');

            // Title
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(title, 105, 12, { align: 'center' });

            if (subtitle) {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(subtitle, 105, 19, { align: 'center' });
            }

            // Reset text color
            doc.setTextColor(0, 0, 0);

            // Page number
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(`Page ${pageNum} of ${totalPages}`, 190, 8, { align: 'center' });

            // Date generated
            const dateGenerated = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            doc.text(`Generated: ${dateGenerated}`, 15, 8);

            return 35; // Return starting Y position for content
        }

        function addPDFFooter(doc, pageNum, totalPages) {
            // Footer line
            doc.setDrawColor(200, 200, 200);
            doc.line(15, 285, 195, 285);

            // Footer text
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Attendance Management System - PUCIT', 105, 292, { align: 'center' });
        }

        function checkPageBreak(doc, currentY, neededSpace, pageNum, totalPages, title, subtitle = '') {
            if (currentY + neededSpace > 275) { // Leave space for footer
                addPDFFooter(doc, pageNum, totalPages);
                doc.addPage();
                pageNum++;
                currentY = addPDFHeader(doc, title, subtitle, pageNum, totalPages);
            }
            return { y: currentY, pageNum: pageNum };
        }

        function generateStudentPDF(doc, students, subjects, attendance, subjectFilter) {
            let pageNum = 1;
            let totalPages = Math.ceil(students.length / 8) + 1; // Estimate

            const subjectName = subjectFilter ? (subjects.find(s => String(s.id) === String(subjectFilter))?.name || 'Unknown Subject') : 'All Subjects';
            const subtitle = `Student-wise Report - ${subjectName}`; let yPos = addPDFHeader(doc, 'ATTENDANCE REPORT', subtitle, pageNum, totalPages);

            // Summary section
            doc.setFillColor(248, 249, 250);
            doc.rect(15, yPos, 180, 25, 'F');
            doc.setDrawColor(33, 150, 243);
            doc.rect(15, yPos, 180, 25);

            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('SUMMARY', 20, yPos + 8);

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Total Students: ${students.length}`, 20, yPos + 16);
            doc.text(`Total Attendance Sessions: ${attendance.length}`, 20, yPos + 22);

            if (subjectFilter) {
                doc.text(`Subject Filter: ${subjectName}`, 110, yPos + 16);
            }

            yPos += 35;

            // Sort students by roll number
            const sortedStudents = [...students].sort((a, b) => a.roll.localeCompare(b.roll));

            sortedStudents.forEach((student, index) => {
                // Check if we need a new page (each student needs ~45 units)
                const result = checkPageBreak(doc, yPos, 50, pageNum, totalPages, 'ATTENDANCE REPORT', subtitle);
                yPos = result.y;
                pageNum = result.pageNum;

                let present = 0, absent = 0;
                const subjectStats = {};

                // Collect attendance data
                attendance.forEach(session => {
                    const record = session.records.find(r => r.studentId === student.id);
                    if (record) {
                        const subject = findSubjectById(subjects, session.subjectId);
                        const subjectName = subject ? subject.name : 'Unknown';

                        if (!subjectStats[subjectName]) {
                            subjectStats[subjectName] = { present: 0, absent: 0, sessions: [] };
                        }

                        if (record.status === 'present') {
                            present++;
                            subjectStats[subjectName].present++;
                        } else {
                            absent++;
                            subjectStats[subjectName].absent++;
                        }

                        subjectStats[subjectName].sessions.push({
                            date: session.date,
                            lecture: session.lectureNumber,
                            status: record.status
                        });
                    }
                });

                const total = present + absent;
                const percentage = total > 0 ? ((present / total) * 100).toFixed(1) : 0;

                // Student card background
                doc.setFillColor(255, 255, 255);
                doc.rect(15, yPos, 180, 45, 'F');
                doc.setDrawColor(220, 220, 220);
                doc.rect(15, yPos, 180, 45);

                // Student header with colored bar
                const barColor = percentage >= 80 ? [76, 175, 80] : percentage >= 60 ? [255, 193, 7] : [244, 67, 54];
                doc.setFillColor(...barColor);
                doc.rect(15, yPos, 180, 12, 'F');

                // Student name and roll
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                const studentText = `${student.roll || 'N/A'} - ${student.name || 'Unknown'}`;
                doc.text(studentText, 20, yPos + 8);

                // Attendance percentage
                doc.setFontSize(11);
                doc.text(`${percentage}%`, 185, yPos + 8, { align: 'right' });

                // Reset text color
                doc.setTextColor(0, 0, 0);

                // Statistics row
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                yPos += 18;

                doc.text(`Present: ${present}`, 20, yPos);
                doc.text(`Absent: ${absent}`, 70, yPos);
                doc.text(`Total: ${total}`, 120, yPos);

                // Subject breakdown
                yPos += 8;
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('Subject Breakdown:', 20, yPos);

                yPos += 5;
                doc.setFont('helvetica', 'normal');
                let subjectCount = 0;
                Object.keys(subjectStats).forEach(subjectName => {
                    if (subjectCount < 3) { // Limit to 3 subjects per row
                        const stats = subjectStats[subjectName];
                        const subjectTotal = stats.present + stats.absent;
                        const subjectPercentage = subjectTotal > 0 ? ((stats.present / subjectTotal) * 100).toFixed(0) : 0;
                        doc.text(`${subjectName}: ${subjectPercentage}%`, 20 + (subjectCount * 60), yPos);
                        subjectCount++;
                    }
                });

                yPos += 20; // Space between students
            });

            addPDFFooter(doc, pageNum, totalPages);
        }

        function generateSpecificStudentPDF(doc, students, subjects, attendance) {
            const rollNumber = document.getElementById('student-roll-search').value.trim();
            const student = students.find(s => s.roll.toLowerCase() === rollNumber.toLowerCase());

            if (!student) {
                alert('Student not found for PDF generation');
                return;
            }

            let pageNum = 1;
            let totalPages = 1;

            const subtitle = `Individual Report - ${student.roll}`;
            let yPos = addPDFHeader(doc, 'STUDENT ATTENDANCE REPORT', subtitle, pageNum, totalPages);

            // Student info card
            doc.setFillColor(33, 150, 243);
            doc.rect(15, yPos, 180, 20, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            const studentText2 = `${student.roll || 'N/A'} - ${student.name || 'Unknown'}`;
            doc.text(studentText2, 20, yPos + 12);

            doc.setTextColor(0, 0, 0);
            yPos += 30;

            // Collect data by subject
            const subjectStats = {};
            attendance.forEach(session => {
                const record = session.records.find(r => r.studentId === student.id);
                if (record) {
                    const subject = findSubjectById(subjects, session.subjectId);
                    const subjectName = subject ? subject.name : 'Unknown';

                    if (!subjectStats[subjectName]) {
                        subjectStats[subjectName] = { present: 0, absent: 0, sessions: [] };
                    }

                    if (record.status === 'present') {
                        subjectStats[subjectName].present++;
                    } else {
                        subjectStats[subjectName].absent++;
                    }

                    subjectStats[subjectName].sessions.push({
                        date: session.date,
                        lecture: session.lectureNumber,
                        status: record.status
                    });
                }
            });

            // Overall statistics
            let totalPresent = 0, totalAbsent = 0;
            Object.values(subjectStats).forEach(stats => {
                totalPresent += stats.present;
                totalAbsent += stats.absent;
            });

            const overallTotal = totalPresent + totalAbsent;
            const overallPercentage = overallTotal > 0 ? ((totalPresent / overallTotal) * 100).toFixed(1) : 0;

            // Overall stats card
            doc.setFillColor(248, 249, 250);
            doc.rect(15, yPos, 180, 25, 'F');
            doc.setDrawColor(200, 200, 200);
            doc.rect(15, yPos, 180, 25);

            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('OVERALL STATISTICS', 20, yPos + 8);

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Present: ${totalPresent} | Absent: ${totalAbsent} | Total: ${overallTotal} | Attendance Rate: ${overallPercentage}%`, 20, yPos + 18);

            yPos += 35;

            // Subject-wise details
            Object.keys(subjectStats).forEach(subjectName => {
                const stats = subjectStats[subjectName];
                const subjectTotal = stats.present + stats.absent;
                const subjectPercentage = subjectTotal > 0 ? ((stats.present / subjectTotal) * 100).toFixed(1) : 0;

                // Check page break
                const result = checkPageBreak(doc, yPos, 40 + (stats.sessions.length * 5), pageNum, totalPages, 'STUDENT ATTENDANCE REPORT', subtitle);
                yPos = result.y;
                pageNum = result.pageNum;

                // Subject header
                const headerColor = subjectPercentage >= 80 ? [76, 175, 80] : subjectPercentage >= 60 ? [255, 193, 7] : [244, 67, 54];
                doc.setFillColor(...headerColor);
                doc.rect(15, yPos, 180, 15, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`üìö ${subjectName}`, 20, yPos + 10);
                doc.text(`${subjectPercentage}%`, 185, yPos + 10, { align: 'right' });

                doc.setTextColor(0, 0, 0);
                yPos += 20;

                // Subject stats
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`Present: ${stats.present} | Absent: ${stats.absent} | Total: ${subjectTotal}`, 20, yPos);
                yPos += 10;

                // Session details (latest first)
                stats.sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
                stats.sessions.slice(0, 10).forEach(session => { // Show last 10 sessions
                    const statusIcon = session.status === 'present' ? '‚úÖ' : '‚ùå';
                    const lectureText = session.lecture ? ` (${session.lecture}${getOrdinalSuffix(session.lecture)} lecture)` : '';
                    doc.text(`${statusIcon} ${session.date}${lectureText}`, 25, yPos);
                    yPos += 5;
                });

                if (stats.sessions.length > 10) {
                    doc.setFont('helvetica', 'italic');
                    doc.text(`... and ${stats.sessions.length - 10} more sessions`, 25, yPos);
                    doc.setFont('helvetica', 'normal');
                    yPos += 5;
                }

                yPos += 10; // Space between subjects
            });

            addPDFFooter(doc, pageNum, totalPages);
        }

        function generateSubjectPDF(doc, students, subjects, attendance, subjectFilter) {
            let pageNum = 1;
            let totalPages = Math.ceil(attendance.length / 3) + 1; // Estimate

            const subjectName = subjectFilter ? (subjects.find(s => String(s.id) === String(subjectFilter))?.name || 'Unknown Subject') : 'All Subjects';
            const subtitle = `Subject-wise Report - ${subjectName}`; let yPos = addPDFHeader(doc, 'SUBJECT ATTENDANCE REPORT', subtitle, pageNum, totalPages);

            // Summary section
            doc.setFillColor(248, 249, 250);
            doc.rect(15, yPos, 180, 25, 'F');
            doc.setDrawColor(33, 150, 243);
            doc.rect(15, yPos, 180, 25);

            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('SUMMARY', 20, yPos + 8);

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Total Sessions: ${attendance.length}`, 20, yPos + 16);
            doc.text(`Total Students: ${students.length}`, 20, yPos + 22);

            yPos += 35;

            // Group attendance by date and subject
            const attendanceByDateSubject = {};
            attendance.forEach(session => {
                const key = `${session.date}_${session.subjectId}_${session.lectureNumber || 1}`;
                attendanceByDateSubject[key] = session;
            });

            // Sort by date (newest first), then subject
            const sortedKeys = Object.keys(attendanceByDateSubject).sort((a, b) => {
                const dateA = a.split('_')[0];
                const dateB = b.split('_')[0];
                return new Date(dateB) - new Date(dateA);
            });

            sortedKeys.forEach((key, index) => {
                const session = attendanceByDateSubject[key];
                const subject = findSubjectById(subjects, session.subjectId);
                const subjectName = subject ? subject.name : `Unknown (${session.subjectId})`;
                const lectureInfo = session.lectureNumber ? `${session.lectureNumber}${getOrdinalSuffix(session.lectureNumber)} Lecture` : 'Lecture';

                // Calculate present/absent
                const presentStudents = [];
                const absentStudents = [];

                session.records.forEach(record => {
                    const student = students.find(s => s.id === record.studentId);
                    if (student) {
                        if (record.status === 'present') {
                            presentStudents.push(student);
                        } else {
                            absentStudents.push(student);
                        }
                    }
                });

                // Sort students by roll number
                presentStudents.sort((a, b) => a.roll.localeCompare(b.roll));
                absentStudents.sort((a, b) => a.roll.localeCompare(b.roll));

                const totalStudents = presentStudents.length + absentStudents.length;
                const attendanceRate = totalStudents > 0 ? ((presentStudents.length / totalStudents) * 100).toFixed(1) : 0;

                // Check if we need a new page
                const neededSpace = 80 + (Math.max(presentStudents.length, absentStudents.length) * 4);
                const result = checkPageBreak(doc, yPos, neededSpace, pageNum, totalPages, 'SUBJECT ATTENDANCE REPORT', subtitle);
                yPos = result.y;
                pageNum = result.pageNum;

                // Session card
                doc.setFillColor(255, 255, 255);
                doc.rect(15, yPos, 180, neededSpace - 10, 'F');
                doc.setDrawColor(220, 220, 220);
                doc.rect(15, yPos, 180, neededSpace - 10);

                // Header with colored bar
                const headerColor = attendanceRate >= 80 ? [76, 175, 80] : attendanceRate >= 60 ? [255, 193, 7] : [244, 67, 54];
                doc.setFillColor(...headerColor);
                doc.rect(15, yPos, 180, 15, 'F');

                // Session title
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                const sessionTitle = `${session.date} - ${subjectName}`;
                doc.text(sessionTitle, 20, yPos + 10);
                doc.text(`${attendanceRate}%`, 185, yPos + 10, { align: 'right' });

                doc.setTextColor(0, 0, 0);
                yPos += 20;

                // Statistics
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`${lectureInfo} | Present: ${presentStudents.length} | Absent: ${absentStudents.length} | Total: ${totalStudents}`, 20, yPos);
                yPos += 15;

                // Prioritize showing ALL absent students since that's more important for tracking
                if (absentStudents.length > 0) {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(244, 67, 54);
                    doc.text('ABSENT STUDENTS (All):', 20, yPos);
                    yPos += 8;

                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(9);

                    // Show ALL absent students in a compact format
                    let currentY = yPos;
                    let currentX = 20;
                    const columnWidth = 85;
                    const maxColumns = 2;
                    let currentColumn = 0;

                    absentStudents.forEach((student, index) => {
                        const text = `‚Ä¢ ${student.roll}`;
                        doc.text(text, currentX, currentY);

                        currentY += 4;

                        // If we've filled this column and there are more students, move to next column
                        if (currentY > 250 && currentColumn < maxColumns - 1 && index < absentStudents.length - 1) {
                            currentColumn++;
                            currentX = 20 + (currentColumn * columnWidth);
                            currentY = yPos;
                        }

                        // If all columns are full, start a new page
                        if (currentY > 250 && currentColumn >= maxColumns - 1) {
                            const pageBreakResult = checkPageBreak(doc, currentY, 50, pageNum, totalPages, 'SUBJECT ATTENDANCE REPORT', subtitle);
                            currentY = pageBreakResult.y;
                            pageNum = pageBreakResult.pageNum;
                            currentX = 20;
                            currentColumn = 0;
                        }
                    });

                    yPos = Math.max(currentY, yPos + (Math.ceil(absentStudents.length / 20) * 4));
                    yPos += 10;
                } else {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(76, 175, 80);
                    doc.text('‚úì PERFECT ATTENDANCE - No Absents!', 20, yPos);
                    yPos += 12;
                }

                // Show present students summary (less detailed since absence is more important to track)
                if (presentStudents.length > 0) {
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(76, 175, 80);
                    doc.text(`Present Students (${presentStudents.length}):`, 20, yPos);
                    yPos += 6;

                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(8);

                    // Show present students in a more compact format
                    const presentRolls = presentStudents.map(s => s.roll).join(', ');
                    const lines = doc.splitTextToSize(presentRolls, 170);

                    lines.forEach(line => {
                        doc.text(line, 20, yPos);
                        yPos += 4;
                    });

                    yPos += 5;
                }

                yPos += 15; // Space between sessions
            });

            addPDFFooter(doc, pageNum, totalPages);
        }

        function getOrdinalSuffix(num) {
            const j = num % 10;
            const k = num % 100;
            if (j == 1 && k != 11) {
                return "st";
            }
            if (j == 2 && k != 12) {
                return "nd";
            }
            if (j == 3 && k != 13) {
                return "rd";
            }
            return "th";
        }

        function generateSpecificStudentSummary() {
            const rollNumber = document.getElementById('student-roll-search').value.trim();

            if (!rollNumber) {
                alert('Please enter a roll number');
                return;
            }

            const students = getStudents();
            const subjects = getSubjects();
            let attendance = getAttendanceArray();

            // Find student (case insensitive)
            const student = students.find(s => s.roll.toLowerCase() === rollNumber.toLowerCase());

            if (!student) {
                document.getElementById('summary-content').innerHTML = `
                    <div style="text-align: center; color: #e53935; padding: 20px;">
                        ‚ùå Student with roll number "${rollNumber}" not found.
                    </div>
                `;
                return;
            }

            // Collect all attendance records for this student
            const studentAttendance = [];

            attendance.forEach(session => {
                const record = session.records.find(r => r.studentId === student.id);
                if (record) {
                    const subject = findSubjectById(subjects, session.subjectId);
                    studentAttendance.push({
                        date: session.date,
                        subjectId: session.subjectId,
                        subjectName: subject ? subject.name : `Unknown (ID: ${session.subjectId})`,
                        lecture: session.lectureNumber,
                        status: record.status
                    });
                }
            });

            if (studentAttendance.length === 0) {
                document.getElementById('summary-content').innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px;">
                        üìù No attendance records found for ${student.roll} - ${student.name}
                    </div>
                `;
                return;
            }

            // Group by subject
            const subjectStats = {};
            studentAttendance.forEach(record => {
                if (!subjectStats[record.subjectId]) {
                    subjectStats[record.subjectId] = {
                        name: record.subjectName,
                        present: 0,
                        absent: 0,
                        total: 0,
                        records: []
                    };
                }

                subjectStats[record.subjectId].total++;
                if (record.status === 'present') {
                    subjectStats[record.subjectId].present++;
                } else {
                    subjectStats[record.subjectId].absent++;
                }

                subjectStats[record.subjectId].records.push(record);
            });

            // Generate HTML
            let html = `
                <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #2196f3;">${student.roll} - ${student.name}</h3>
                </div>
            `;

            Object.keys(subjectStats).forEach(subjectId => {
                const stats = subjectStats[subjectId];
                const attendanceRate = ((stats.present / stats.total) * 100).toFixed(1);

                html += `
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 16px; overflow: hidden;">
                        <div style="background: #2196f3; color: white; padding: 12px;">
                            <h4 style="margin: 0;">${stats.name}</h4>
                            <div style="font-size: 14px; opacity: 0.9;">
                                Present: ${stats.present} | Absent: ${stats.absent} | Total: ${stats.total} | Rate: ${attendanceRate}%
                            </div>
                        </div>
                        <div style="padding: 12px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Date</th>
                                        <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">Lecture</th>
                                        <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                // Sort by date (newest first)
                stats.records.sort((a, b) => new Date(b.date) - new Date(a.date));

                stats.records.forEach(record => {
                    const statusColor = record.status === 'present' ? '#43a047' : '#e53935';
                    const statusIcon = record.status === 'present' ? '‚úì' : '‚úó';

                    html += `
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${record.date}</td>
                            <td style="padding: 8px; text-align: center; border-bottom: 1px solid #eee;">
                                ${record.lecture}${record.lecture === 1 ? 'st' : record.lecture === 2 ? 'nd' : 'rd'}
                            </td>
                            <td style="padding: 8px; text-align: center; border-bottom: 1px solid #eee; color: ${statusColor}; font-weight: bold;">
                                ${statusIcon} ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                            </td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            document.getElementById('summary-content').innerHTML = html;
        }

        // Manage Tab Functions
        function loadManageTab() {
            loadStudentsList();
            loadSubjectsList();
        }

        function addStudent() {
            const rollElement = document.getElementById('new-student-roll');
            const nameElement = document.getElementById('new-student-name');

            if (!rollElement || !nameElement) {
                alert('Error: Could not find input fields. Make sure you are on the Manage tab.');
                return;
            }

            const roll = rollElement.value.trim();
            const name = nameElement.value.trim();

            if (!roll || !name) {
                alert('Please enter both roll number and name');
                return;
            }

            const students = getStudents();

            if (students.find(s => s.roll === roll)) {
                alert('Student with this roll number already exists');
                return;
            }

            const newStudent = {
                id: Date.now(),
                roll: roll,
                name: name
            };

            students.push(newStudent);

            setStudents(students);
            rollElement.value = '';
            nameElement.value = '';
            loadStudentsList();
        }

        function deleteStudent(id) {
            if (confirm('Are you sure you want to delete this student?')) {
                const students = getStudents().filter(s => s.id !== id);
                setStudents(students);
                loadStudentsList();
            }
        }

        function loadStudentsList() {
            const students = getStudents();
            const list = document.getElementById('students-list');

            if (students.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#666;">No students added yet.</div>';
                return;
            }

            list.innerHTML = students.map(student => `
                <div class="list-item">
                    <div><strong>${student.roll}</strong> - ${student.name}</div>
                    <div class="actions">
                        <button class="action-btn delete" onclick="deleteStudent(${student.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function importStudents() {
            const bulkData = document.getElementById('bulk-student-data').value.trim();
            const statusDiv = document.getElementById('import-status');

            if (!bulkData) {
                statusDiv.innerHTML = '<span style="color: #e53935;">Please enter student data to import.</span>';
                return;
            }

            const lines = bulkData.split('\n').map(line => line.trim()).filter(line => line);
            const students = getStudents();
            const newStudents = [];
            const errors = [];
            const duplicates = [];

            lines.forEach((line, index) => {
                // Handle different separators: comma, tab, or multiple spaces
                const parts = line.split(/[,\t]|\s{2,}/).map(part => part.trim()).filter(part => part);

                if (parts.length < 2) {
                    errors.push(`Line ${index + 1}: Invalid format - "${line}"`);
                    return;
                }

                const roll = parts[0];
                const name = parts.slice(1).join(' '); // Join remaining parts as name

                // Check for duplicates in existing students
                if (students.find(s => s.roll === roll)) {
                    duplicates.push(`${roll} - ${name}`);
                    return;
                }

                // Check for duplicates in new batch
                if (newStudents.find(s => s.roll === roll)) {
                    errors.push(`Line ${index + 1}: Duplicate roll number in import data - "${roll}"`);
                    return;
                }

                newStudents.push({
                    id: Date.now() + index, // Ensure unique IDs
                    roll: roll,
                    name: name
                });
            });

            // Show results
            let statusMessage = '';

            if (newStudents.length > 0) {
                // Add new students
                students.push(...newStudents);
                setStudents(students);
                loadStudentsList();
                statusMessage += `<span style="color: #43a047;">‚úÖ Successfully imported ${newStudents.length} students.</span><br>`;
            }

            if (duplicates.length > 0) {
                statusMessage += `<span style="color: #ff9800;">‚ö†Ô∏è Skipped ${duplicates.length} duplicate(s): ${duplicates.slice(0, 3).join(', ')}${duplicates.length > 3 ? '...' : ''}</span><br>`;
            }

            if (errors.length > 0) {
                statusMessage += `<span style="color: #e53935;">‚ùå ${errors.length} error(s): ${errors.slice(0, 2).join(', ')}${errors.length > 2 ? '...' : ''}</span><br>`;
            }

            if (newStudents.length === 0 && duplicates.length === 0 && errors.length === 0) {
                statusMessage = '<span style="color: #666;">No valid data found to import.</span>';
            }

            statusDiv.innerHTML = statusMessage;

            // Clear the textarea if import was successful
            if (newStudents.length > 0 && errors.length === 0) {
                document.getElementById('bulk-student-data').value = '';
            }
        }

        function clearBulkData() {
            document.getElementById('bulk-student-data').value = '';
            document.getElementById('import-status').innerHTML = '';
        }

        function addSubject() {
            const name = document.getElementById('subject-name').value.trim();

            if (!name) {
                alert('Please enter subject name');
                return;
            }

            const subjects = getSubjects();
            if (subjects.find(s => s.name === name)) {
                alert('Subject with this name already exists');
                return;
            }

            subjects.push({
                id: Date.now(),
                name: name
            });

            setSubjects(subjects);
            document.getElementById('subject-name').value = '';
            loadSubjectsList();
        }

        function deleteSubject(id) {
            if (confirm('Are you sure you want to delete this subject?')) {
                const subjects = getSubjects().filter(s => s.id !== id);
                setSubjects(subjects);
                loadSubjectsList();
            }
        }

        function loadSubjectsList() {
            const subjects = getSubjects();
            const list = document.getElementById('subjects-list');

            if (subjects.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#666;">No subjects added yet.</div>';
                return;
            }

            list.innerHTML = subjects.map(subject => `
                <div class="list-item">
                    <div>${subject.name}</div>
                    <div class="actions">
                        <button class="action-btn delete" onclick="deleteSubject(${subject.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Clear data functions
        function clearAllAttendance() {
            if (confirm('‚ö†Ô∏è Are you sure you want to delete ALL attendance records?\n\nThis will remove all attendance data but keep students and subjects.\n\nThis action cannot be undone!')) {
                localStorage.removeItem('attendance');
                alert('‚úÖ All attendance records have been cleared.');

                // Refresh current view if on summary tab
                const currentTab = document.querySelector('.tab.active');
                if (currentTab && currentTab.dataset.tab === 'summary') {
                    document.getElementById('summary-content').innerHTML = '<div style="text-align:center;color:#666;">No attendance data available.</div>';
                }
            }
        }

        function clearAllData() {
            if (confirm('üí• DANGER: Delete EVERYTHING?\n\nThis will permanently delete:\n‚Ä¢ All students\n‚Ä¢ All subjects\n‚Ä¢ All attendance records\n\nThis action cannot be undone!\n\nType "DELETE" in the next prompt to confirm.')) {
                const confirmation = prompt('Type "DELETE" to confirm:');
                if (confirmation === 'DELETE') {
                    localStorage.removeItem('students');
                    localStorage.removeItem('subjects');
                    localStorage.removeItem('attendance');

                    // Refresh all lists
                    loadStudentsList();
                    loadSubjectsList();
                    document.getElementById('summary-content').innerHTML = '<div style="text-align:center;color:#666;">No data available.</div>';

                    alert('üí• All data has been permanently deleted.');
                } else {
                    alert('‚ùå Deletion cancelled - wrong confirmation text.');
                }
            }
        }

        // Show message to user
        function showMessage(message, type = 'error') {
            const manageMsg = document.getElementById('manage-message');
            if (!manageMsg) return;

            manageMsg.textContent = message;
            if (type === 'success') {
                manageMsg.style.color = '#43a047';
            } else if (type === 'warning') {
                manageMsg.style.color = '#f57c00';
            } else {
                manageMsg.style.color = '#e53935';
            }
            setTimeout(() => manageMsg.textContent = '', 6000);
        }

        // Utility: get all app data
        function getAllAppData() {
            return {
                students: getStudents(),
                subjects: getSubjects(),
                attendance: getAttendance(),
            };
        }

        // Utility: set all app data
        function setAllAppData(data) {
            if (data.students) setStudents(data.students);
            if (data.subjects) setSubjects(data.subjects);
            if (data.attendance) setAttendance(data.attendance);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize sync status
            updateSyncUI();
            if (isConnected) {
                updateSyncStatus('online');
                loadFromCloud(); // Load latest data on startup
            } else {
                updateSyncStatus('offline');
            }

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Attendance tab
            document.getElementById('attendance-subject').addEventListener('change', () => {
                if (currentAttendanceSession) {
                    if (confirm('This will restart attendance taking. Continue?')) {
                        currentAttendanceSession = null;
                        currentStudentIndex = 0;
                    }
                }
            });

            // Lecture selection buttons
            document.getElementById('lecture-1').addEventListener('click', () => selectLecture(1));
            document.getElementById('lecture-2').addEventListener('click', () => selectLecture(2));
            document.getElementById('lecture-3').addEventListener('click', () => selectLecture(3));

            // Subject/date change listeners
            document.getElementById('attendance-subject').addEventListener('change', () => {
                if (selectedLecture) {
                    const subjectId = document.getElementById('attendance-subject').value;
                    const date = document.getElementById('attendance-date').value;

                    // Debug logging for subject selection
                    console.log('=== DEBUG Subject Selection ===');
                    console.log('Selected subjectId:', subjectId, 'Type:', typeof subjectId);
                    console.log('Selected date:', date);
                    console.log('Selected lecture:', selectedLecture);
                    console.log('Will call updateLectureInfo with these values');
                    console.log('==============================');

                    if (subjectId && date) {
                        updateLectureInfo(subjectId, date, selectedLecture);
                    }
                }
            });

            document.getElementById('attendance-date').addEventListener('change', () => {
                if (selectedLecture) {
                    const subjectId = document.getElementById('attendance-subject').value;
                    const date = document.getElementById('attendance-date').value;

                    if (subjectId && date) {
                        updateLectureInfo(subjectId, date, selectedLecture);
                    }
                }
            });

            document.getElementById('start-attendance').addEventListener('click', startAttendance);
            document.getElementById('mark-present').addEventListener('click', () => markAttendance('present'));
            document.getElementById('mark-absent').addEventListener('click', () => markAttendance('absent'));
            document.getElementById('finish-attendance').addEventListener('click', finishAndSync);

            // Track tab
            document.getElementById('track-lecture-1').addEventListener('click', () => selectTrackLecture(1));
            document.getElementById('track-lecture-2').addEventListener('click', () => selectTrackLecture(2));
            document.getElementById('track-lecture-3').addEventListener('click', () => selectTrackLecture(3));
            document.getElementById('load-attendance').addEventListener('click', loadAttendanceForEdit);

            // Summary tab
            document.getElementById('generate-summary').addEventListener('click', generateSummary);
            document.getElementById('download-pdf').addEventListener('click', downloadPDF);

            // Summary type change listener
            document.getElementById('summary-type').addEventListener('change', function () {
                const specificSection = document.getElementById('specific-student-section');
                if (this.value === 'specific-student') {
                    specificSection.classList.remove('hidden');
                } else {
                    specificSection.classList.add('hidden');
                }
            });

            // Enter key for student search
            document.getElementById('student-roll-search').addEventListener('keypress', e => {
                if (e.key === 'Enter') generateSpecificStudentSummary();
            });

            // Manage tab
            document.getElementById('add-student').addEventListener('click', addStudent);
            document.getElementById('add-subject').addEventListener('click', addSubject);
            document.getElementById('clear-attendance').addEventListener('click', clearAllAttendance);
            document.getElementById('clear-all-data').addEventListener('click', clearAllData);

            // Enter key support
            document.getElementById('new-student-roll').addEventListener('keypress', e => {
                if (e.key === 'Enter') document.getElementById('new-student-name').focus();
            });
            document.getElementById('new-student-name').addEventListener('keypress', e => {
                if (e.key === 'Enter') addStudent();
            });
            document.getElementById('subject-name').addEventListener('keypress', e => {
                if (e.key === 'Enter') addSubject();
            });

            // Backup/Import functionality
            const backupBtn = document.getElementById('backup-btn');
            const importBtn = document.getElementById('import-btn');
            const importFile = document.getElementById('import-file');
            const deleteAllBtn = document.getElementById('delete-all-btn');
            const manageMsg = document.getElementById('manage-message');

            if (backupBtn) {
                backupBtn.onclick = function () {
                    const data = getAllAppData();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'attendance_backup_' + new Date().toISOString().slice(0, 10) + '.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };
            }

            if (importBtn && importFile) {
                importBtn.onclick = function () {
                    importFile.click();
                };
                importFile.onchange = function (e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        try {
                            const data = JSON.parse(evt.target.result);
                            setAllAppData(data);
                            manageMsg.textContent = 'Data imported successfully!';
                            manageMsg.style.color = '#43a047';
                            setTimeout(() => manageMsg.textContent = '', 3000);
                            loadManageTab();
                        } catch (err) {
                            manageMsg.textContent = 'Invalid file format!';
                            manageMsg.style.color = '#e53935';
                            setTimeout(() => manageMsg.textContent = '', 3000);
                        }
                    };
                    reader.readAsText(file);
                };
            }

            if (deleteAllBtn) {
                deleteAllBtn.onclick = function () {
                    if (confirm('Are you sure you want to delete ALL records? This cannot be undone.')) {
                        localStorage.removeItem('students');
                        localStorage.removeItem('subjects');
                        localStorage.removeItem('attendance');
                        manageMsg.textContent = 'All records deleted.';
                        manageMsg.style.color = '#e53935';
                        setTimeout(() => manageMsg.textContent = '', 3000);
                        loadManageTab();
                    }
                };
            }

            // Suppress blocked request errors in console
            window.addEventListener('error', function (e) {
                // Suppress external service errors that are commonly blocked by ad blockers
                if (e.message && (
                    e.message.includes('ERR_BLOCKED_BY_CLIENT') ||
                    e.message.includes('sentry') ||
                    e.message.includes('temp-mail') ||
                    e.message.includes('jsonbin') ||
                    e.message.includes('Failed to fetch')
                )) {
                    e.preventDefault();
                    return false;
                }
            });

            // Suppress unhandled promise rejections from external services
            window.addEventListener('unhandledrejection', function (e) {
                if (e.reason && typeof e.reason === 'string' && (
                    e.reason.includes('ERR_BLOCKED_BY_CLIENT') ||
                    e.reason.includes('Failed to fetch') ||
                    e.reason.includes('Cloud sync unavailable')
                )) {
                    e.preventDefault();
                    return false;
                }
            });

            // Initialize
            loadAttendanceTab();
        });
    </script>
</body>

</html>